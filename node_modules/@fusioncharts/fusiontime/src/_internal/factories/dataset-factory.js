import transpose from"ramda/es/transpose";import Line from"../components/dataset/line";import Column from"../components/dataset/column";import CandleStick from"../components/dataset/candlestick";import OHLC from"../components/dataset/ohlc";import StackGenerator from"@fusioncharts/utils/src/stack-generator";import offsetDiverge from"@fusioncharts/utils/src/stack-generator/offsets/diverge";import offsetNull from"@fusioncharts/utils/src/stack-generator/offsets/null";import{UNDEF,extend2,pluck}from"@fusioncharts/core/src/lib";import timeConverter from"@fusioncharts/utils/src/time-converter";var LINE="line",getDataset=function getDataset(plotType){switch(plotType){case"column":return Column;case"candlestick":return CandleStick;case"ohlc":return OHLC;default:return Line}},getSeriesName=function getSeriesName(str){return str.split(" - ")[0]},getMeasureOpName=function getMeasureOpName(str){return str.split(" - ").slice(1).join(" - ")},getVisibility=function getVisibility(bool){return bool?"visible":"hidden"},isOHLC=function isOHLC(plotType){return plotType==="ohlc"||plotType==="candlestick"},isPlotStackable=function isPlotStackable(plotType){return plotType==="area"||plotType==="smooth-area"||plotType==="step-area"||plotType==="column"};export default function(canvas){var chart=canvas.getFromEnv("chart"),legendMap=canvas.getFromEnv("legendMap"),canvasConf=canvas.config,dataSource=canvas.getFromEnv("dataSource"),plotConfigurations=dataSource.plotconfig||{},ordinalScale=canvas.getFromEnv("ordinalScale"),xConfigs=canvasConf.isContext?chart.config.contextAxesX:chart.config.focusAxesX,yConfigs=canvasConf.isContext?chart.config.contextAxesY:chart.config.focusAxesY,isContext=canvasConf.isContext,msDsMap=canvasConf.multiSeriesDatasetMap,prediction=canvas.getFromEnv("prediction"),chartBaseDateTimeFormat=canvasConf.dataTable.getSchema().filter(function(x){return x.name===xConfigs[0].plot[0].value})[0].format,predictiveDate=prediction?timeConverter.parser(chartBaseDateTimeFormat).parse(prediction.date):UNDEF;prediction.dateMs=prediction.enabled?predictiveDate?predictiveDate.getTime():Date.now():UNDEF;if(isContext){canvasConf.plotConfigs.forEach(function(_ref){var plots=_ref.plots;var isArea=plots.filter(function(_ref2){var plottype=_ref2.plottype;return plottype==="column"}).length>1?"area":null;plots.forEach(function(ob){if(isOHLC(ob.plottype)){ob.value=ob.close||ob.low||ob.high||ob.open||[];ob.plottype=ob.typeinnavigator||"line"}else if(ob.plottype==="column"){ob.plottype=ob.typeinnavigator||isArea||(ob.value.length>1?"area":"line")}})})}canvasConf.plotConfigs.forEach(function(plotConfig){var xConfig=xConfigs[plotConfig.x],yConfig=yConfigs[plotConfig.y],binDecider=xConfig.binDecider,scaleX=xConfig.scale,scaleY=yConfig.scale,plotGenericStyle=yConfig.plotstyle||{},columnPlotInfo=plotConfig.plots.filter(function(_ref3){var plottype=_ref3.plottype;return plottype==="column"}),totalColumnPlots=columnPlotInfo.length,columnSeriesNames=columnPlotInfo.map(function(plot){return plot.stack?getSeriesName(plot.value[0]):plot.tableInfo.filterItem||getSeriesName(plot.value[0])});var currentColumnIndex=0;plotConfig.plots.forEach(function(plot){var nodeInfo=plot.tableInfo,nodeTable=nodeInfo.table,filterItem=nodeInfo.filterItem,oriPlotInfo=yConfig.plot[plot.plotInAxisIndex],plotInlineStyle=oriPlotInfo.style||{},mergedInlineStyle,connectNullData=oriPlotInfo.connectnulldata,plotCosmetics,genericCosmetics,tableData=nodeTable.getData(),data=tableData.data,dataTable=nodeTable,timeFormatterFn=xConfig.timeFormatterFn,plotType,groupIndex,totalGroups,Dataset,measures=[oriPlotInfo.value],seriesInfo={};oriPlotInfo.group&&(seriesInfo[oriPlotInfo.group]=filterItem);mergedInlineStyle=extend2(extend2({},plotGenericStyle),plotInlineStyle);if(!isContext&&isOHLC(plot.plottype)){var arr=plot.close||plot.open||plot.high||plot.low;if(arr.length>1||filterItem){plot.plottype=LINE;plot.value=arr}}plotType=plot.plottype;plotCosmetics=plotConfigurations[plotType]||{};genericCosmetics=plotConfigurations.generic||{};Dataset=getDataset(plotType);if(plotType==="column"){groupIndex=currentColumnIndex++;totalGroups=totalColumnPlots}if(isOHLC(plotType)){var ohlcs=transpose([plot.open||[plot.open],plot.high||[plot.high],plot.low||[plot.low],plot.close||[plot.close]].filter(function(s){return!!s})),open=oriPlotInfo.open,high=oriPlotInfo.high,low=oriPlotInfo.low,close=oriPlotInfo.close;open&&measures.push(open);high&&measures.push(high);low&&measures.push(low);close&&measures.push(close);if(measures.length>1){measures.shift()}ohlcs.forEach(function(ohlc){var dsInstance=canvas.attachChild(Dataset,"dataset");dataTable.on("resultFlushed",function(e){var legendInteracted=e.data&&e.data.legendInteracted;dsInstance.setData({data:e.sender.getData().data,skipLimitCalc:isContext,legendInteracted:legendInteracted},true)});dsInstance.addToEnv("binDecider",binDecider);dsInstance.addToEnv("xScale",scaleX);dsInstance.addToEnv("yScale",scaleY);dsInstance.configure({data:data,scaleX:scaleX,scaleY:scaleY,formatterFn:yConfig.formatterFn,timeFormatterFn:timeFormatterFn,yAxisAlign:pluck(yConfig.align,"left"),styleConfig:mergedInlineStyle,plotCosmetics:plotCosmetics,genericCosmetics:genericCosmetics,prefix:yConfig.formatLabelPrefix,suffix:yConfig.formatLabelSuffix,indices:[dataTable.indexOf(nodeInfo.position)].concat(ohlc.map(function(name){return dataTable.indexOf(name)})),primaryColor:true,type:plotType,series:plot.value,measures:measures,calculateFromContext:isContext,prediction:prediction,useNullStyles:!isContext})})}else{if(plot.stack&&isPlotStackable(plotType)){var xIndex=dataTable.indexOf(nodeInfo.position),sumColumn=getMeasureOpName(plot.value[0])+" - sum",generator=(new StackGenerator).setValueAccessor(function(d,key){if(legendMap[getSeriesName(key)].visibility){return d[dataTable.indexOf(key)]}return 0}).setKeysAccessor(function(){return plot.value.filter(function(name){return dataTable.indexOf(name)>=0})}).setOffset(scaleY.getType()==="log"?offsetNull:offsetDiverge);dataTable.addColumns({name:sumColumn,type:"number",calcFn:function calcFn(row,cols){return plot.value.reduce(function(acc,val){if(legendMap[getSeriesName(val)].visibility){return acc+row[cols[val]]}return acc},0)}});var series=generator.generate(dataTable.getData().data),seriesLength=series.length;dataTable.on("resultFlushed",function(e){series=generator.generate(e.sender.getData().data);var legendInteracted=e.data&&e.data.legendInteracted;series.forEach(function(serie){var dsInstance=filterItem?msDsMap[filterItem+" - "+serie.key]:msDsMap[serie.key],serieData=serie.map(function(s){return[s.data[xIndex],s[0],s[1],s.data[dataTable.indexOf(sumColumn)]]}),legendName=dsInstance.config.series,isVisible=legendMap[legendName]&&legendMap[legendName].visibility;if(isVisible===UNDEF)isVisible=true;dsInstance.setData({visibility:getVisibility(isVisible),data:serieData,skipLimitCalc:isContext,legendInteracted:legendInteracted},true)});if(series.length===0){var dsInstances=canvas.getChildren("dataset");dsInstances&&dsInstances.forEach(function(dsInstance){dsInstance.setData({data:[],legendInteracted:legendInteracted},true)})}});series.forEach(function(serie,index){var dsInstance=canvas.attachChild(Dataset,"dataset"),seriesName=getSeriesName(serie.key),serieData=serie.map(function(s){return[s.data[xIndex],s[0],s[1],s.data[dataTable.indexOf(sumColumn)]]});oriPlotInfo.stack&&(seriesInfo[oriPlotInfo.stack]=seriesName);dsInstance.addToEnv("binDecider",binDecider);dsInstance.addToEnv("xScale",scaleX);dsInstance.addToEnv("yScale",scaleY);if(filterItem){msDsMap[filterItem+" - "+serie.key]=dsInstance}else{msDsMap[serie.key]=dsInstance}dsInstance.configure({data:serieData,datasetIndex:index,seriesLength:seriesLength,scaleX:scaleX,scaleY:scaleY,timeFormatterFn:timeFormatterFn,groupIndex:groupIndex,yAxisAlign:pluck(yConfig.align,"left"),totalGroups:totalGroups,formatterFn:yConfig.formatterFn,prefix:yConfig.formatLabelPrefix,suffix:yConfig.formatLabelSuffix,styleConfig:mergedInlineStyle,plotCosmetics:plotCosmetics,genericCosmetics:genericCosmetics,connectNullData:connectNullData,indices:[0,2,1,3],primaryColor:ordinalScale.getRangeValue(seriesName),type:plotType,series:seriesName,enableMarkers:canvasConf.enableMarkers,measures:measures,calculateFromContext:isContext,seriesInfo:Object.assign({},seriesInfo),prediction:prediction,useNullStyles:!isContext})})}else{plot.value.forEach(function(name){var dsInstance=canvas.attachChild(Dataset,"dataset"),seriesName=plot.stack?getSeriesName(name):filterItem||getSeriesName(name);dataTable.on("resultFlushed",function(e){var legendName=dsInstance.config.series,legendInteracted=e.data&&e.data.legendInteracted,isVisible=legendMap[legendName]&&legendMap[legendName].visibility,currentGroupIndex=dsInstance.config.groupIndex,currentTotalGroups=dsInstance.config.totalGroups;isVisible===UNDEF&&(isVisible=true);if(legendInteracted&&plotType==="column"){var status=columnSeriesNames.filter(function(str){return legendMap[str].visibility});currentGroupIndex=status.findIndex(function(str){return str===legendName});currentTotalGroups=status.length}dsInstance.setData({visibility:getVisibility(isVisible),data:e.sender.getData().data,skipLimitCalc:isContext,legendInteracted:legendInteracted,groupIndex:currentGroupIndex,totalGroups:currentTotalGroups},true)});if(plot.stack){seriesInfo[plot.stack]=seriesName}dsInstance.addToEnv("binDecider",binDecider);dsInstance.addToEnv("xScale",scaleX);dsInstance.addToEnv("yScale",scaleY);dsInstance.configure({data:data,scaleX:scaleX,scaleY:scaleY,timeFormatterFn:timeFormatterFn,groupIndex:groupIndex,totalGroups:totalGroups,yAxisAlign:pluck(yConfig.align,"left"),formatterFn:yConfig.formatterFn,prefix:yConfig.formatLabelPrefix,suffix:yConfig.formatLabelSuffix,styleConfig:mergedInlineStyle,plotCosmetics:plotCosmetics,genericCosmetics:genericCosmetics,connectNullData:connectNullData,indices:[dataTable.indexOf(nodeInfo.position),dataTable.indexOf(name)],primaryColor:ordinalScale.getRangeValue(seriesName),type:plotType,series:seriesName,enableMarkers:canvasConf.enableMarkers,measures:measures,calculateFromContext:isContext,seriesInfo:Object.assign({},seriesInfo),prediction:prediction,useNullStyles:!isContext})})}}})})}