import merge from"ramda/es/merge";import{componentFactory,BLANKSTRING,extend2,pluck}from"@fusioncharts/core/src/lib";import Axis from"../../../_internal/components/axis";import Canvas from"../../../_internal/components/canvas";import panelConfig from"./_utils/panel-configurer";import usConfig from"@fusioncharts/utils/src/number-converter/locales/en-US";var BOTTOM="bottom",canvases=function canvases(key){return key.match(/^canvas/)},removeComponent=function removeComponent(component){return component.remove()},getSpecifier=function getSpecifier(type,subType){switch(type){case"axis":if(subType==="log"){return"$~s"}return"$s";case"tooltip":return"$.2s";case"crossline":return"$.2s";case"referenceline":return"$.1~s"}},getSpecifierForValues=function getSpecifierForValues(specifier,value){var val=Math.abs(value);if(val!==0&&val<1e-4){return"$e"}else if(val>=1e-4&&val<1||val===0){return"$"}return specifier},visibleAxes=function visibleAxes(cfg){return cfg.visible},isLeftAligned=function isLeftAligned(c){return c.align==="left"},isRightAligned=function isRightAligned(c){return c.align==="right"},isTopAligned=function isTopAligned(c){return c.align==="top"},isBottomAligned=function isBottomAligned(c){return c.align==="bottom"},mergeBorderConfig=function mergeBorderConfig(panelCfg){var borderCfg={leftBorder:false,rightBorder:false,topBorder:false,bottomBorder:false},xConfigs=panelCfg.xConfigs,yConfigs=panelCfg.yConfigs;if(xConfigs.find(isLeftAligned)||yConfigs.find(isLeftAligned)){borderCfg.leftBorder=true}if(xConfigs.find(isRightAligned)||yConfigs.find(isRightAligned)){borderCfg.rightBorder=true}if(xConfigs.find(isTopAligned)||yConfigs.find(isTopAligned)){borderCfg.topBorder=true}if(xConfigs.find(isBottomAligned)||yConfigs.find(isBottomAligned)){borderCfg.bottomBorder=true}return merge(panelCfg,borderCfg)};export default function(chart){var usedCanvasIds=[],unusedCanvasIds=[],canvasIds,baseTextStyle=chart.getFromEnv("baseTextStyle"),dataSource=chart.getFromEnv("dataSource"),DEFAULT_AXIS_X={orientation:"bottom",align:"bottom",tickpadding:2,visible:true,overlap:false,domainline:false,outputtimeformat:{},style:{"label-major":Object.assign({fill:"#818181"},baseTextStyle),"label-context":Object.assign({fill:"#818181"},baseTextStyle)}},DEFAULT_AXIS_Y={tickarguments:[4,"s"],ticksize:5,tickpadding:7,visible:true,overlap:false,domainline:false,style:{"label-major":Object.assign({"font-size":"11px"},baseTextStyle),"tick-mark-major":Object.assign({stroke:"#efefef"},baseTextStyle)}};var hydrateX=merge(DEFAULT_AXIS_X),hydrateY=merge(DEFAULT_AXIS_Y),chartConfig=chart.config,focusAxesX=chartConfig.focusAxesX,focusAxesY=chartConfig.focusAxesY,focusPanels=chartConfig.focusPanels.map(function(panel){return merge(panel,{x:panel.x.map(function(xCfg){var focusAxisX=focusAxesX[xCfg.index],formatObj=pluck(focusAxesX[xCfg.index].format,{});focusAxisX.timeFormatterFn=typeof formatObj.formatter==="function"?function(options){return formatObj.formatter.call(focusAxisX.scale,options)}:function(formatterObj){return focusAxisX.scale.getFormattedTime&&focusAxisX.scale.getFormattedTime(formatterObj,dataSource.tooltip&&dataSource.tooltip.outputtimeformat)};return merge(hydrateX(xCfg),panelConfig(focusAxesX,xCfg.index))}),y:panel.y.map(function(yCfg){var focusAxisY=focusAxesY[yCfg.index],formatObj=pluck(focusAxesY[yCfg.index].format,{});focusAxisY.formatLabelPrefix=formatObj.prefix||BLANKSTRING;focusAxisY.formatLabelSuffix=formatObj.suffix||BLANKSTRING;focusAxisY.scale.setLocale(extend2(extend2({},usConfig),{prefix:focusAxisY.formatLabelPrefix,suffix:focusAxisY.formatLabelSuffix}));focusAxisY.formatterFn=typeof formatObj.formatter==="function"?function(formatterObj){var returnValue=formatObj.formatter(formatterObj);return returnValue+""}:function(formatterObj){var specifier;specifier=typeof formatObj.formatter==="string"?formatObj.formatter:getSpecifierForValues(getSpecifier(formatterObj.type,focusAxesY[yCfg.index].type),formatterObj.value);return focusAxisY.scale.tickFormat(4,specifier)(formatterObj.value)};return merge(hydrateY(yCfg),panelConfig(focusAxesY,yCfg.index))})})}),canvasAxisMap=chart.config.canvasAxisMap,isValidYOrientation=function isValidYOrientation(orientation){return orientation==="left"||orientation==="right"},creatorFn=function creatorFn(_ref,i){var axisConfigsX=_ref.x,axisConfigsY=_ref.y,plotConfigs=_ref.plots;var canvasId="canvas_"+i;if(!canvasAxisMap[canvasId]){canvasAxisMap[canvasId]={x:[],y:[]}}axisConfigsX.filter(visibleAxes).forEach(function(ac,ai){var axisId="axesX_"+i+"_"+ai;ac.align=ac.align.toLowerCase();if(!["bottom","top"].includes(ac.align)){ac.align=BOTTOM}canvasAxisMap[canvasId].x.push(axisId);componentFactory(chart,Axis,axisId,1,[ac])});var axisCount={left:0,right:0};axisConfigsY.filter(visibleAxes).forEach(function(ac,ai){var axisId="axesY_"+i+"_"+ai;if(isValidYOrientation(ac.orientation)){ac.align=ac.orientation}ac.orientation=ac.align;ac.domainline=axisCount[ac.align]>0;axisCount[ac.align]++;ac.type==="log"&&(ac.tickarguments=[4,"~s"]);canvasAxisMap[canvasId].y.push(axisId);componentFactory(chart,Axis,axisId,1,[ac])});usedCanvasIds.push(canvasId);componentFactory(chart,Canvas,canvasId,1,[mergeBorderConfig({plotConfigs:plotConfigs,dataTable:chartConfig.dataTable,tableMap:chart.config.focusTableMap,xConfigs:axisConfigsX,yConfigs:axisConfigsY,enableGridLines:true,enableMouseTracking:1,enableMarkers:1,enableInteraction:1})])};focusPanels.forEach(creatorFn);canvasIds=Object.keys(chart.getChildren()).filter(canvases);unusedCanvasIds=canvasIds.filter(function(oldId){return!usedCanvasIds.includes(oldId)});unusedCanvasIds.forEach(function(unusedId){chart.getChildren(unusedId).forEach(removeComponent)});chartConfig.focusPanels=focusPanels}