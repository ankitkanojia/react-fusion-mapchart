import BinDecider,{DEFAULT_THRESHOLD_PIXELS}from"@fusioncharts/utils/src/bin-decider";import{timeDay,timeHour,timeWeek,timeYear,timeMonth,timeMinute,timeSecond,timeMillisecond}from"@fusioncharts/utils/src/time-intervals";import{utcDay,utcHour,utcWeek,utcYear,utcMonth,utcMinute,utcSecond,utcMillisecond}from"@fusioncharts/utils/src/time-intervals/utc";import Log from"@fusioncharts/utils/src/scales/ft-log";import extent from"@fusioncharts/utils/src/array/extent";import Linear from"@fusioncharts/utils/src/scales/linear";import ScaleTime from"@fusioncharts/utils/src/scales/time";import ScaleUTCTime from"@fusioncharts/utils/src/scales/utc";import isObject from"@fusioncharts/utils/src/type/is-object";import ScaleTimeBin from"@fusioncharts/utils/src/scales/time-bin";import timeFormatter from"@fusioncharts/utils/src/time-converter";import ScaleUTCTimeBin from"@fusioncharts/utils/src/scales/utc-bin";import standardBins from"@fusioncharts/utils/src/bin-decider/standard-bins";import getAtomicity from"../../_utils/atomicity";var UNDEF;var TYPES={time:ScaleTimeBin,utctime:ScaleUTCTimeBin,scaletime:ScaleTime,scaleutctime:ScaleUTCTime,numeric:Linear,log:Log},SHARE_RATIO=.8;export default function(chart){var chartConf=chart.config,focusAxesX=chartConf.focusAxesX,customBin=focusAxesX[0].binning,contextAxesX=chartConf.contextAxesX||[],table=chartConf.dataTable,_table$getData=table.getData(),schema=_table$getData.schema,data=_table$getData.data,isUTC=chart.getFromEnv("UTC"),chartWidth=chart.getFromEnv("chartWidth"),range=[0,SHARE_RATIO*chartWidth/focusAxesX.length],makeScale=function makeScale(_ref){var typeArg=_ref.typeArg,plot=_ref.plot;var type=typeArg||"time",Scale=(type==="time"&&isUTC?TYPES["utc"+type]:TYPES[type])||TYPES.time,scale=new Scale;return scale},makeBin=function makeBin(_ref2){var typeArg=_ref2.typeArg,plot=_ref2.plot,maxbinArg=_ref2.maxbinArg,minbinArg=_ref2.minbinArg;var type=typeArg||"time",minbin=minbinArg,maxbin=maxbinArg,bin=type==="time"&&isUTC?new BinDecider(standardBins(utcYear,utcMonth,utcWeek,utcDay,utcHour,utcMinute,utcSecond,utcMillisecond,customBin)):new BinDecider(standardBins(timeYear,timeMonth,timeWeek,timeDay,timeHour,timeMinute,timeSecond,timeMillisecond,customBin)),Scale=(type==="time"&&isUTC?TYPES["scaleutc"+type]:TYPES["scale"+type])||TYPES.time,scale=new Scale;bin.setScale(scale);maxbin=maxbin?maxbin.ms?{unit:maxbin,multiplier:1}:maxbin.unit?{unit:maxbin.unit,multiplier:+maxbin.multiplier||1}:UNDEF:UNDEF;maxbin&&bin.setBinMax(maxbin);minbin=minbin?minbin.ms?{unit:minbin,multiplier:1}:minbin.unit?{unit:minbin.unit,multiplier:+minbin.multiplier||1}:UNDEF:UNDEF;minbin&&bin.setBinMin(minbin)||bin.setBinMin(getAtomicity(schema[table.indexOf(plot[0].value)].format,table.indexOf(plot[0].value),data,bin.getStandardBins(),bin.intervalIndexMap));bin.setBinRange(range);bin.setRangeThreshold(chartConf.pixelMultiplier*DEFAULT_THRESHOLD_PIXELS);return bin},makeScalesBins=function makeScalesBins(axesX){var scales=[],bins=[],i,len=axesX.length;for(i=0;i<len;i++){scales[i]=makeScale(axesX[i]);bins[i]=makeBin(axesX[i]);scales[i].setThresholdIntervals(bins[i].getStandardBins());scales[i].setBinMin(bins[i].getBinMin());scales[i].setRangeThreshold(bins[i].getRangeThreshold())}return{scales:scales,bins:bins}},minMaxFn=function minMaxFn(_ref3){var value=_ref3.value;var min=table.min(value),max=table.max(value);return[min,max]},calculateDomain=function calculateDomain(axis){var _ref4;var arr=axis.plot.map(minMaxFn),context=extent((_ref4=[]).concat.apply(_ref4,arr),Number),value=axis.plot[0].value,format=axis.format||schema.find(function(_ref5){var name=_ref5.name;return name===value}).format,parser=timeFormatter.parser(format),initialInterval=isObject(axis.initialinterval)?axis.initialinterval:{},setMin=function setMin(userMin,dataMin){var min=parser.parse(userMin);if(min===null){return dataMin}return min<dataMin?+min:dataMin},setMax=function setMax(userMax,dataMax){var max=parser.parse(userMax);if(max===null){return dataMax}return max>dataMax?+max:dataMax},focus;context[0]=setMin(axis.min,context[0]);context[1]=setMax(axis.max,context[1]);focus=context.slice();focus[0]=setMax(initialInterval.from,focus[0]);focus[1]=setMin(initialInterval.to,focus[1]);focus=extent(focus);return{focus:focus,context:context}};var contextInfo=makeScalesBins(contextAxesX),focusInfo=makeScalesBins(focusAxesX),_calculateDomain=calculateDomain(contextAxesX[0]),focus=_calculateDomain.focus,context=_calculateDomain.context;chart.addToEnv("contextScalesX",contextInfo.scales);chart.addToEnv("focusScalesX",focusInfo.scales);chart.addToEnv("contextBins",contextInfo.bins);chart.addToEnv("focusBins",focusInfo.bins);chart.setContextLimit(context);chart.setFocusLimit(focus)}