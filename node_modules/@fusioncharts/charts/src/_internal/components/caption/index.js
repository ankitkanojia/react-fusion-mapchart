import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import{parseUnsafeString,pluck,pluckNumber,NORMAL,BOLD,convertColor,getValidValue,setLineHeight,visibleStr,hiddenStr,BLANKSTRING}from"@fusioncharts/core/src/lib";import{ComponentInterface}from"@fusioncharts/core/src/component-interface";import{addDep}from"@fusioncharts/core/src/dependency-manager";import captionAnimation from"./index.animation";var mathMax=Math.max,mathMin=Math.min,mathCeil=Math.ceil,PXSTRING="px",POSITION_RIGHT="right",POSITION_LEFT="left",POSITION_CENTER="center",POSITION_TOP="top",POSITION_BOTTOM="bottom",POSITION_MIDDLE="middle",POSITION_START="start",POSITION_END="end";addDep({name:"captionAnimation",type:"animationRule",extension:captionAnimation});var Caption=function(_ComponentInterface){_inheritsLoose(Caption,_ComponentInterface);function Caption(){return _ComponentInterface.apply(this,arguments)||this}var _proto=Caption.prototype;_proto.getType=function getType(){return"caption"};_proto.getName=function getName(){return"caption"};_proto.configure=function configure(){var iapi=this.getFromEnv("chart"),chartAttrs=iapi.getFromEnv("chart-attrib"),caption=this,captionConfig=caption.config||{},style=iapi.getFromEnv("style"),outCanfontFamily=style.outCanfontFamily,outCancolor=style.outCancolor,fontSize=style.fontSize,align=["top","center"];caption.config.text=parseUnsafeString(chartAttrs.caption);captionConfig.style={fontFamily:pluck(chartAttrs.captionfont,outCanfontFamily),color:convertColor(pluck(chartAttrs.captionfontcolor,outCancolor).replace(/^#? ([a-f0-9]+)/gi,"#$1")),fontSize:pluckNumber(chartAttrs.captionfontsize,fontSize+3)+PXSTRING,fontWeight:pluckNumber(chartAttrs.captionfontbold)===0?NORMAL:BOLD};if(!captionConfig.align){captionConfig.align=BLANKSTRING}captionConfig.align=pluck(chartAttrs.captionposition,chartAttrs.captionalignment,POSITION_CENTER);if(captionConfig.align){align=captionConfig.align.split("-");align[0]&&(align[0]=align[0].toLowerCase());align[1]&&(align[1]=align[1].toLowerCase());if(align.length<2){align[1]=align[0]}}switch(align[0]){case POSITION_TOP:captionConfig.isOnTop=1;break;case POSITION_BOTTOM:captionConfig.isOnTop=0;break;default:captionConfig.isOnTop=pluckNumber(chartAttrs.captionontop,1)}switch(align[1]){case POSITION_RIGHT:captionConfig.align=POSITION_END;break;case POSITION_LEFT:captionConfig.align=POSITION_START;break;default:captionConfig.align=POSITION_MIDDLE}captionConfig.isOnLeft=!pluckNumber(chartAttrs.captiononright,0);captionConfig.captionPosition=getValidValue(chartAttrs.captionposition,POSITION_TOP).toLowerCase();captionConfig.alignWithCanvas=pluckNumber(chartAttrs.aligncaptionwithcanvas,iapi.config.alignCaptionWithCanvas,1);captionConfig.horizontalPadding=pluckNumber(chartAttrs.captionhorizontalpadding,captionConfig.alignWithCanvas?0:15);captionConfig.drawCaption=true;setLineHeight(captionConfig.style)};_proto.allocatePosition=function allocatePosition(){var caption=this,chart=caption.getFromEnv("chart");chart._manageCaptionPosition()};_proto.draw=function draw(){var caption=this,iapi=this.getFromEnv("chart"),chartConfig=iapi.config,animationManager=iapi.getFromEnv("animationManager"),textDirection=iapi.config.textDirection,captionGroup=iapi.getChildContainer().captionGroup,smartLabel=iapi.getFromEnv("smartLabel"),captionElement=caption.getGraphicalElement("captionElement"),toolTipController=caption.getFromEnv("toolTipController"),captionConfig=caption.config,captionStyle=captionConfig.style,hasCaption=captionConfig.text,captionX=captionConfig.x,align=captionConfig.align,captionAttrObj,captionState;if(hasCaption){captionAttrObj={text:captionConfig.text,fill:captionStyle.color,x:captionX,y:captionConfig.y,"text-anchor":align||POSITION_MIDDLE,"vertical-align":captionConfig.verticalAlign||POSITION_TOP,visibility:captionConfig.drawCaption?visibleStr:hiddenStr,direction:textDirection};captionElement=caption.addGraphicalElement("captionElement",animationManager.setAnimation({el:captionElement||"text",attr:captionAttrObj,container:captionGroup,state:captionState,component:caption,label:"text"}));captionElement.css(captionStyle);if(chartConfig.showtooltip){toolTipController.enableToolTip(captionElement,captionConfig.originalText)}else{toolTipController.disableToolTip(captionElement)}if(smartLabel){smartLabel.useEllipsesOnOverflow(chartConfig.useEllipsesWhenOverflow);smartLabel.setStyle(captionStyle)}}else if(captionElement){animationManager.setAnimation({el:captionElement,component:caption,callback:function callback(){this.hide()},doNotRemove:true})}chartConfig.savedCaption=captionElement};_proto.manageSpace=function manageSpace(availableHeight,availableWidth){var iapi=this.getFromEnv("chart"),chartConfig=iapi.config,caption=iapi.getChildren("caption")[0],subCaption=iapi.getChildren("subCaption")[0],captionConfig=caption.config,subCaptionConfig=subCaption.config,chartAttrs=iapi.getFromEnv("dataSource").chart,SmartLabel=iapi.getFromEnv("smartLabel"),allowedHeight=availableHeight,titleText=parseUnsafeString(chartAttrs.caption),subTitleText=parseUnsafeString(chartAttrs.subcaption),captionPadding=pluckNumber(chartAttrs.captionpadding,10),oriCapPadding=captionPadding,isPaddingReduced=false,captionObj,subcaptionObj,totalHeight=0,capStyle,dimensions,subCapStyle,difference=0,extraSpace=0,captionLineHeight=0,subCaptionLineHeight=0,topGutterWidth=5,canvas=iapi.getChildren("canvas"),canvasBorderThickness=mathMax(canvas&&canvas[0].config.canvasBorderThickness,0),captionWidth=0,subCaptionWidth=0;if(allowedHeight>3){if(captionPadding<canvasBorderThickness){captionPadding=canvasBorderThickness+2}if(titleText!==BLANKSTRING){capStyle=captionConfig.style;captionLineHeight=mathCeil(pluckNumber(parseFloat(capStyle.fontHeight,10),parseFloat(capStyle.lineHeight,10),12))}if(subTitleText!==BLANKSTRING){subCapStyle=subCaptionConfig.style;subCaptionLineHeight=pluckNumber(parseInt(subCapStyle.fontHeight,10),parseInt(subCapStyle.lineHeight,10),12)}if(captionLineHeight>0||subCaptionLineHeight>0){allowedHeight=mathMax(allowedHeight,0);totalHeight=captionLineHeight+subCaptionLineHeight+captionPadding;if(totalHeight>allowedHeight){difference=allowedHeight-totalHeight;isPaddingReduced=true;if(difference<captionPadding){captionPadding=mathMax(difference,5)}else{difference-=captionPadding;captionPadding=0;if(subCaptionLineHeight>difference){extraSpace=subCaptionLineHeight-difference+10;subCaptionLineHeight=0;subCaptionConfig._originalText=subCaptionConfig.text;subCaptionConfig.text=BLANKSTRING}else{difference-=subCaptionLineHeight;subCaptionLineHeight=0;if(captionLineHeight>difference){extraSpace=captionLineHeight-difference}}}}else{extraSpace=allowedHeight-totalHeight}SmartLabel.useEllipsesOnOverflow(chartConfig.useEllipsesWhenOverflow);if(captionLineHeight>0){SmartLabel.setStyle(capStyle);captionLineHeight+=extraSpace;captionObj=SmartLabel.getSmartText(titleText,availableWidth,captionLineHeight);extraSpace=captionLineHeight-captionObj.height;captionConfig.height=captionLineHeight=captionObj.height;captionConfig.text=captionObj.text;captionConfig.originalText=captionObj.tooltext?captionObj.tooltext:false;captionWidth=captionObj.width}if(subCaptionLineHeight>0){SmartLabel.setStyle(subCapStyle);subCaptionLineHeight+=extraSpace;subcaptionObj=SmartLabel.getSmartText(subTitleText,availableWidth,subCaptionLineHeight);extraSpace=subCaptionLineHeight-subcaptionObj.height;subCaptionLineHeight=subcaptionObj.height;subCaptionConfig.text=subcaptionObj.text;subCaptionConfig.height=subcaptionObj.height;subCaptionConfig.originalText=subcaptionObj.tooltext?subcaptionObj.tooltext:false;subCaptionWidth=subcaptionObj.width}if(isPaddingReduced&&extraSpace>0){captionPadding+=mathMin(oriCapPadding-captionPadding,extraSpace)}captionConfig.captionPadding=captionPadding;captionConfig.height=captionLineHeight;captionConfig.width=captionWidth;subCaptionConfig.width=subCaptionWidth;subCaptionConfig.height=subCaptionLineHeight;totalHeight=captionLineHeight+subCaptionLineHeight+captionPadding}if(totalHeight>chartConfig.canvasHeight){totalHeight=0;captionConfig.drawCaption=false}else{captionConfig.drawCaption=true}if(captionConfig.isOnTop){dimensions={top:totalHeight}}else{dimensions={bottom:totalHeight,top:topGutterWidth}}}else{dimensions={bottom:0,top:0};captionConfig.drawCaption=false}return dimensions};_proto.setDimention=function setDimention(pos){var caption=this,captionConfig=caption.config;captionConfig.x=pos.x;captionConfig.y=pos.y};return Caption}(ComponentInterface);export default Caption;