import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import{pluck,pluckNumber,parseUnsafeString,POSITION_START,POSITION_END,POSITION_TOP,POSITION_BOTTOM,POSITION_MIDDLE,POSITION_RIGHT,preDefStr,BLANKSTRING,setLineHeight,getFirstValue,pluckFontSize,chartPaletteStr,TESTSTR,crispBound,extend2,convertColor,getFirstColor}from"@fusioncharts/core/src/lib";import{ComponentInterface}from"@fusioncharts/core/src/component-interface";import LegendItem from"./legend-item";import{addDep}from"@fusioncharts/core/src/dependency-manager";import{ScrollBar}from"@fusioncharts/core/src/toolbox";import legendAnimation from"./index.animation";import{priorityList}from"@fusioncharts/core/src/schedular";var UNDEF,TEXT_ANCHOR_MAP={left:POSITION_START,right:POSITION_END,center:POSITION_MIDDLE},math=Math,mathMin=math.min,mathMax=math.max,mathFloor=math.floor,mathCeil=math.ceil,INHERIT_STR="inherit",COMMA=",",NONE="none",COLOR_WHITE="#ffffff",PXSTRING="px",ZERO_STR="0,",NORMAL=preDefStr.NORMAL,BOLD=preDefStr.BOLD,noneStr=preDefStr.noneStr,styleValueMap={fontWeight:{1:BOLD,0:NORMAL},fontStyle:{1:"italic",0:NORMAL},textDecoration:{1:"underline",0:noneStr}},handlers=function handlers(legend){var dragInitX,dragInitY;return{dragstart:function dragstart(){dragInitX=legend.config.xL||legend.config.xPos;dragInitY=legend.config.yL||legend.config.yPos},dragmove:function dragmove(e){var dx=e.originalEvent.data[0],dy=e.originalEvent.data[1],config=legend.config,chartConfig=legend.getFromEnv("chartConfig"),translationLimit=(config.borderWidth||0*.5)+2,dragOffsetX,dragOffsetY;dragOffsetX=mathMin(mathMax(dragInitX+dx,translationLimit),chartConfig.width-config.width-translationLimit);dragOffsetY=mathMin(mathMax(dragInitY+dy,translationLimit),chartConfig.height-config.height-translationLimit);config.xPos=config.xL=dragOffsetX;config.yPos=config.yL=dragOffsetY;legend.addJob("draw",legend.dragDraw,priorityList&&priorityList.draw)}}};addDep({name:"legendAnimation",type:"animationRule",extension:legendAnimation});var Legend=function(_ComponentInterface){_inheritsLoose(Legend,_ComponentInterface);function Legend(){var _this;_this=_ComponentInterface.call(this)||this;var legend=_assertThisInitialized(_this);legend._stateCosmetics={};legend._legendState=[];legend.dragDraw=function(){legend.draw()};legend.drawScroll=function(){legend.createItemGroup()};legend.config.handlers=handlers(legend);return _this}var _proto=Legend.prototype;_proto.createItem=function createItem(owner){var legend=this,legendItem;legendItem=new LegendItem;legend.attachChild(legendItem,"legendItem");legendItem.setLinkedItem("owner",owner);legendItem.addEventListener("mouseover",function(){legendItem.setLegendState("hover",true)});legendItem.addEventListener("mouseout",function(){legendItem.removeLegendState("hover")});return legendItem.getId()};_proto.getItem=function getItem(id){var legend=this,items=legend.getChildren().legendItem;if(id!==UNDEF){if(items){for(var i=0;i<items.length;i++){if(items[i].getId()===id){return items[i]}}}}else{return false}};_proto.getSortedLegendItems=function getSortedLegendItems(){var legend=this,items=legend.getChildren("legendItem")||[],reverselegend=legend.config.reverselegend,map={},sortedItems=[],i,len;for(i=0,len=items.length;i<len;i++){if(items[i].config.index===UNDEF){map[len+i]=items[i]}else{map[items[i].config.index]=items[i]}}Object.keys(map).sort(function(index1,index2){if(reverselegend){return index2-index1}return index1-index2}).forEach(function(index){sortedItems.push(map[index])});return sortedItems};_proto.disposeItem=function disposeItem(id){var legend=this,legendItem=legend.getItem(id);legendItem&&legendItem.remove()};_proto.getName=function getName(){return"legend"};_proto.getType=function getType(){return"legend"};_proto.__setDefaultConfig=function __setDefaultConfig(){_ComponentInterface.prototype.__setDefaultConfig.call(this);var config=this.config;config.enabled=true;config.symbolWidth=12;config.borderRadius=1;config.lastScrollPos=0;config.oriSymbolPadding=3;config.textPadding=4;config.scrollY=0;config.backgroundColor=COLOR_WHITE;config.initialItemX=0;config.title={text:BLANKSTRING,x:0,y:0,padding:2};config.scroll={};config.itemStyle={}};_proto.createLegendGroup=function createLegendGroup(){var legend=this,config=legend.config,chart=legend.getFromEnv("chart"),chartConfig=chart.config,animationManager=legend.getFromEnv("animationManager"),translationLimit=(config.borderWidth||0)*.5+2,legendGroup,legendGroupCheck=legend.getContainer("legendGroup");config.xL&&(config.xL=mathMin(mathMax(config.xL,translationLimit),chartConfig.width-config.width-translationLimit));config.yL&&(config.yL=mathMin(mathMax(config.yL,translationLimit),chartConfig.height-config.height-translationLimit));legendGroup=animationManager.setAnimation({el:legendGroupCheck||"group",attr:{name:"legendGroup",transform:["T",config.xL||config.xPos,config.yL||config.yPos]},container:chart.getChildContainer("legendGroup"),component:legend});if(!legendGroupCheck){legend.addContainer("legendGroup",legendGroup)}};_proto.draw=function draw(){this.createLegendGroup();this.drawLegendBox();this.createItemGroup();this.drawCaption();this.createScrollGroup();this.decideScroll()};_proto.decideScroll=function decideScroll(){var legend=this,legendConf=legend.config,scrollEnabled=legendConf.scroll.enabled;if(scrollEnabled){this.createScrollBar()}else if(legendConf.hasScroll){legend.getChildren("legendScrollBar")[0].remove();legendConf.hasScroll=false}};_proto.createItemGroup=function createItemGroup(){var legend=this,animationManager=legend.getFromEnv("animationManager"),legendGroup=legend.getContainer("legendGroup"),itemGroup,itemGroupCheck=legend.getChildContainer("itemGroup"),padding=pluckNumber(legend.config.padding,4),halfPad=padding*.5,clipSTR1=ZERO_STR,clipH=Math.max(legend.config.height-padding,0),clipSTR2=COMMA+legend.config.width+COMMA+clipH;itemGroup=animationManager.setAnimation({el:itemGroupCheck||"group",attr:{name:"item",transform:["T",0,legend.config.scrollY||0]},container:legendGroup,component:legend});if(!itemGroupCheck){legend.addChildContainer("itemGroup",itemGroup)}if(legend.config.scroll.enabled){itemGroup.attr({"clip-rect":clipSTR1+halfPad+clipSTR2})}else{itemGroup.attr({"clip-rect":null})}return itemGroup};_proto.createScrollGroup=function createScrollGroup(){var legend=this,animationManager=legend.getFromEnv("animationManager"),scrollGroupCheck=legend.getChildContainer("scrollGroup"),legendGroup=legend.getContainer("legendGroup");if(legend.config.scroll.enabled&&!legend.getGraphicalElement("scrollbarContainer")){legend.addGraphicalElement("scrollbarContainer",animationManager.setAnimation({el:scrollGroupCheck||"group",attr:{name:"scrollGroup"},container:legendGroup,component:legend,label:"scrollbar"}))}};_proto.createScrollBar=function createScrollBar(){var legend=this,config=legend.config,scrollItem,chartAttr=legend.getFromEnv("chart-attrib"),legendScrollBar=legend.getChildren("legendScrollBar")&&legend.getChildren("legendScrollBar")[0],borderWidth=config.borderWidth||0,semiBorder=borderWidth*.5,padding=pluckNumber(config.padding,4),halfPad=padding*.5,scrollConfig,scrollbarWidth=10,clipH,width=config.width,height=config.height,x,y,h;scrollItem={conf:{isHorizontal:false},handler:{scroll:function scroll(pos){config.lastScrollPos=pos;config.scrollY=(clipH-config.totalHeight)*pos;legend.addJob("scrollDraw",legend.drawScroll,priorityList&&priorityList.draw)},mousedown:function mousedown(e){e.preventDefault();e.stopPropagation()}}};if(chartAttr.legendscrollbgcolor){scrollItem.conf.color=convertColor(chartAttr.legendscrollbgcolor)}if(!legendScrollBar){legendScrollBar=legend.attachChild(new ScrollBar,"legendScrollBar");this.config.hasScroll=true}legendScrollBar.configure(scrollItem.conf);legendScrollBar.attachEventHandlers(scrollItem.handler);scrollConfig=legendScrollBar.config;clipH=Math.max(height-padding,0);x=width-scrollbarWidth+halfPad-borderWidth;y=semiBorder;h=Math.max(height-borderWidth,0);scrollConfig.scrollRatio=(clipH+padding)/config.totalHeight;scrollConfig.startPercent=0;scrollConfig.scrollPosition=config.lastScrollPos;scrollConfig.parentLayer=legend.getChildContainer("scrollGroup");legendScrollBar.setDimension({x:x,y:y,height:h})};_proto.drawCaption=function drawCaption(){var legend=this,itemGroup=legend.getChildContainer("itemGroup"),caption=legend.getGraphicalElement("caption"),animationManager=this.getFromEnv("animationManager"),config=this.config,attrObj,titleStyle,captionX,padding=pluckNumber(config.padding,4),captionCss,scrollEnabled=config.scroll.enabled,scrollbarWidth=10,width=config.width;if(config.title&&config.title.text!==BLANKSTRING&&config.validLegendItem){switch(config.title.align){case POSITION_START:captionX=padding;break;case POSITION_END:captionX=width-padding-(scrollEnabled?scrollbarWidth:0);break;default:captionX=width*.5}titleStyle=config.title.style;attrObj={text:config.title.text,title:config.title.originalText||BLANKSTRING,x:captionX,y:padding,fill:config.title.style.color,direction:config.textDirection,"line-height":titleStyle.lineHeight,"vertical-align":POSITION_TOP,"text-anchor":config.title.align,opacity:1};captionCss={"font-weight":titleStyle.fontWeight,"font-style":titleStyle.fontStyle,"font-family":titleStyle.fontFamily,"font-size":titleStyle.fontSize};caption&&caption.show();if(!caption){caption=animationManager.setAnimation({el:"text",attr:attrObj,component:legend,container:itemGroup});caption=this.addGraphicalElement("caption",caption);caption.css(captionCss)}else{animationManager.setAnimation({el:caption,attr:attrObj,component:legend})}legend.getFromEnv("toolTipController").enableToolTip(caption,config.title.originalText)}else{if(caption){animationManager.setAnimation({el:caption,component:legend,doNotRemove:true,callback:function callback(){caption.hide()}})}}};_proto.drawLegendBox=function drawLegendBox(){var legend=this,animationManager=this.getFromEnv("animationManager"),config=legend.config,box,legendGroup=legend.getContainer("legendGroup"),width=config.width,boxCheck=legend.getGraphicalElement("box"),height=config.height,r=config.borderRadius,backgroundColor=config.backgroundColor,borderColor=config.borderColor,borderAlpha=config.borderAlpha,backgroundAlpha=config.backgroundAlpha,borderWidth=config.borderWidth||0;box=animationManager.setAnimation({el:boxCheck||"rect",attr:{x:0,y:0,width:width,height:height,r:r,stroke:borderColor,"stroke-width":borderWidth,fill:backgroundColor||NONE,"stroke-opacity":borderAlpha/100,"fill-opacity":backgroundAlpha/100,cursor:config.legendAllowDrag?"move":"default"},container:legendGroup,component:legend,label:"legendGroup"});if(!boxCheck){legend.addGraphicalElement("box",box);box.shadow(config.shadow)}return box};_proto.getPosition=function getPosition(){var legend=this,chart=legend.getFromEnv("chart"),chartConfig=chart.config,xPos,yPos,config=legend.config,canvasBottom=chartConfig.height-chartConfig.canvasBottom,canvasLeft=chartConfig.canvasLeft,canvasWidth=chartConfig.canvasWidth,marginLeft=config.chartMarginLeft||0,marginRight=config.chartMarginRight||0,marginBottom=config.chartMarginBottom||0,actionBarHeight=chartConfig.actionBarHeight||0,canvasMarginLeft=config.actualCanvasMarginLeft||0,canvasMarginBottom=chartConfig.actualCanvasMarginBottom||0,canvasMarginRight=chartConfig.actualCanvasMarginRight||0,alignLegendWithCanvas=config.alignLegendWithCanvas,chartHeight=chartConfig.height,canvasTop=chartConfig.canvasTop,width=config.width||0,height=config.height||0,chartBorderWidth=chartConfig.borderWidth,oriCanvasLeft=chartConfig.oriCanvasLeft,oriCanvasTop=chartConfig.oriTopSpace,oriCanvasBottom=chartConfig.oriBottomSpace,topSpace=0,bottomSpace=0,xLeft,spaceLeftByChart,spaceRightLeft,borderWidth=config.borderWidth||0,isVertical,legendPos=config.legendPos;if(legendPos===POSITION_RIGHT){config.align=POSITION_RIGHT;config.verticalAlign=POSITION_MIDDLE;isVertical=config.layout="vertical"}if(isVertical){xPos=chartConfig.width-marginRight-canvasMarginRight-width-chartBorderWidth;topSpace=pluckNumber(oriCanvasTop,canvasTop);bottomSpace=pluckNumber(oriCanvasBottom,canvasBottom);yPos=topSpace+(chartHeight-bottomSpace-topSpace-height)*.5+(config.y||0)}else{spaceLeftByChart=chartConfig.width-(marginLeft+canvasMarginLeft+(marginRight+canvasMarginRight));spaceRightLeft=alignLegendWithCanvas?canvasWidth-width:spaceLeftByChart-width;xLeft=!alignLegendWithCanvas?marginLeft+canvasMarginLeft:pluckNumber(oriCanvasLeft,canvasLeft);xPos=xLeft+spaceRightLeft/2;yPos=chartHeight-height-canvasMarginBottom-marginBottom-actionBarHeight}return crispBound(xPos,yPos,width,height,borderWidth)};_proto.setTranslation=function setTranslation(x,y){var legend=this,config=legend.config;config._translateX=x;config._translateY=y;config.translate="t"+x+","+y};_proto.allocatePosition=function allocatePosition(){var legend=this,legendConfig=legend.config,dim;if(legendConfig.translate){dim=crispBound(legendConfig._translateX,legendConfig._translateY,legendConfig.width,legendConfig.height,legendConfig.borderWidth)}else{dim=legend.getPosition()}legendConfig.xPos=dim.x;legendConfig.yPos=dim.y;legendConfig.width=dim.width;legendConfig.height=dim.height};_proto._manageLegendPosition=function _manageLegendPosition(allottedSpace){var legend=this,config=legend.config,legendPosition=config.legendPos,dimensions;config.padding=4;config.textPadding=4;if(legendPosition===POSITION_RIGHT){dimensions=legend._placeLegendBlockRight(allottedSpace)}else{dimensions=legend._placeLegendBlockBottom(allottedSpace)}return dimensions};_proto.setDimension=function setDimension(dim){var legend=this,config=this.config,itemArr=legend.getSortedLegendItems(),len=itemArr.length,availableWidth=dim.width,availableHeight=dim.height,allowedMaxHeight=availableHeight*2,itemConfig,userConfig,name,item,maxWidth=0,totalWidth=0,totalNumber=0,averageWidth=0,perItemWidth=0,maxHeight=0,legendCaptionHeight=0,maxMarkerGutter=0,tempTableStructure=[],singleRowLegend=false,padding=config.padding,textPadding=config.textPadding,SmartLabel=legend.getFromEnv("smartLabel"),itemStyle=legend.getStateCosmetics("default"),itemFontSize=parseInt(itemStyle.text["font-size"],10)||10,legendX=0,current=0,nonItemWidth,rowHeight,usedHeight,textWidth,numberOfCell,tempCurrent,legendCaption=config.title,captionPadding=legendCaption.padding,captionWidth,minimiseWrappingInLegend=config.minimiseWrappingInLegend,legendPadding=config.legendPadding,legendScale=config.legendScale,alignLegendWithCanvas=config.alignLegendWithCanvas,legendnumcolumns=config.numColumns,symbolPadding=config.oriSymbolPadding,legendHeight,symbolWidthSpace,dimensions,legendLineHeight,i,j,colIndex,rowIndex,numRows,validLegendItem,smartText,scroll,originalAvailableWidth=availableWidth,nonTextElemWidth;dimensions={width:2*padding,height:2*padding};symbolWidthSpace=itemFontSize+1;if(symbolWidthSpace<=0){symbolWidthSpace=1}availableWidth=Math.max(availableWidth-2*padding,0);symbolWidthSpace*=legendScale;symbolPadding*=legendScale;symbolWidthSpace=mathMin(symbolWidthSpace,availableWidth);if(symbolWidthSpace<=0){symbolPadding=symbolWidthSpace=0}config.symbolWidth=symbolWidthSpace;config.textPadding=4;config.legendHeight=legendHeight=symbolWidthSpace+2*symbolPadding;config.rowHeight=rowHeight=mathMax(parseInt(itemStyle.text["line-height"],10)||12,legendHeight);nonItemWidth=textPadding+symbolPadding+padding;SmartLabel.setStyle(extend2({},itemStyle.text));legendLineHeight=SmartLabel.getOriSize(TESTSTR).height;usedHeight=legendPadding+config.borderWidth/2+1;usedHeight=mathMin(usedHeight,availableHeight-legendLineHeight-8);legendPadding=rowHeight*.05;config.initialItemY=0;config.initialItemX=0;for(i=0;i<len;i+=1){item=itemArr[i];itemConfig=item.config||(item.config={});userConfig=itemConfig;name=itemConfig.name=parseUnsafeString(userConfig.label);if(name===BLANKSTRING||userConfig.enabled===0||userConfig.enabled===false||item.getState("removed")){itemConfig.enabled=0;continue}else{itemConfig.enabled=1}totalNumber+=1;validLegendItem=true;smartText=SmartLabel.getOriSize(name);maxWidth=mathMax(maxWidth,smartText.width);maxHeight=mathMax(maxHeight,mathMin(smartText.height,allowedMaxHeight));totalWidth+=smartText.width}config.validLegendItem=validLegendItem;averageWidth=totalWidth/totalNumber;nonTextElemWidth=legendHeight+legendPadding+textPadding+symbolPadding+2*padding;totalWidth+=nonTextElemWidth*totalNumber;config.x=!alignLegendWithCanvas&&totalWidth>originalAvailableWidth?0:config.x;if(validLegendItem){averageWidth+=nonTextElemWidth;maxWidth+=nonTextElemWidth;if(legendnumcolumns>0&&totalNumber<legendnumcolumns){legendnumcolumns=totalNumber}if(totalWidth<=availableWidth&&(legendnumcolumns<=0||legendnumcolumns===totalNumber)){legendnumcolumns=totalNumber;perItemWidth=averageWidth=totalWidth/totalNumber;singleRowLegend=true;if(maxHeight>rowHeight){maxMarkerGutter=(maxHeight-rowHeight)/2;rowHeight=maxHeight}}else if(legendnumcolumns>0&&(perItemWidth=availableWidth/legendnumcolumns)>averageWidth){if(perItemWidth>maxWidth){perItemWidth=maxWidth}}else if(availableWidth>maxWidth&&(minimiseWrappingInLegend||averageWidth*1.5>maxWidth)){legendnumcolumns=mathFloor(availableWidth/maxWidth);if(totalNumber<legendnumcolumns){legendnumcolumns=totalNumber}perItemWidth=maxWidth}else if(availableWidth>=2*averageWidth){legendnumcolumns=mathFloor(availableWidth/averageWidth);if(totalNumber<legendnumcolumns){legendnumcolumns=totalNumber}perItemWidth=mathFloor(availableWidth/legendnumcolumns);if(perItemWidth>maxWidth){perItemWidth=maxWidth}}else{legendnumcolumns=1;perItemWidth=availableWidth}config.itemWidth=perItemWidth;textWidth=mathCeil(perItemWidth-nonTextElemWidth);if(textWidth<0){symbolPadding=textWidth=textPadding=0}config.symbolPadding=symbolPadding;config.textPadding=textPadding;config.width=Math.max(perItemWidth*legendnumcolumns-legendPadding,0);if(legendCaption.oriText!==BLANKSTRING){SmartLabel.setStyle(legendCaption.style);smartText=SmartLabel.getSmartText(legendCaption.oriText,availableWidth,allowedMaxHeight);legendCaption.text=smartText.text;smartText.tooltext&&(legendCaption.originalText=smartText.tooltext);captionWidth=smartText.width+2*padding;if(config.width<captionWidth){config.initialItemX=(captionWidth-config.width)/2;config.width=captionWidth}config.initialItemY=legendCaptionHeight=smartText.height+captionPadding}SmartLabel.setStyle(extend2({},itemStyle.text));for(i=0;i<len;i+=1){item=itemArr[i];itemConfig=item.config;if(itemConfig.enabled!==0){if(textWidth===0){tempTableStructure[current]=true;itemConfig.name=BLANKSTRING;j=1;rowIndex=parseInt(current/legendnumcolumns,10);colIndex=current%legendnumcolumns;itemConfig._legendX=colIndex*perItemWidth;itemConfig._legendY=rowIndex*rowHeight+2*padding;itemConfig._legendH=j*rowHeight;itemConfig._totalWidth=symbolWidthSpace+symbolPadding}if(singleRowLegend){smartText=SmartLabel.getOriSize(itemConfig.name);if(smartText.height<rowHeight){itemConfig._legendTestY=(rowHeight-smartText.height)/2}itemConfig._markerYGutter=maxMarkerGutter;itemConfig._legendX=legendX;itemConfig._legendY=2*padding;itemConfig._legendH=rowHeight;itemConfig._totalWidth=symbolWidthSpace+nonItemWidth+smartText.width;legendX+=smartText.width+nonTextElemWidth}else{smartText=SmartLabel.getSmartText(itemConfig.name,textWidth,allowedMaxHeight);itemConfig.name=smartText.text;smartText.tooltext&&(itemConfig.originalText=smartText.tooltext);while(tempTableStructure[current]===true){current+=1}numberOfCell=smartText.height/rowHeight;tempCurrent=current;for(j=0;j<numberOfCell;j+=1,tempCurrent+=legendnumcolumns){tempTableStructure[tempCurrent]=true}if(smartText.height<rowHeight){itemConfig._legendTestY=(rowHeight-smartText.height)/2}rowIndex=parseInt(current/legendnumcolumns,10);colIndex=current%legendnumcolumns;itemConfig._legendX=colIndex*perItemWidth;itemConfig._legendY=rowIndex*rowHeight+2*padding;itemConfig._legendH=j*rowHeight;itemConfig._totalWidth=symbolWidthSpace+nonItemWidth+smartText.width}current++}}numRows=singleRowLegend?1:mathCeil(tempTableStructure.length/legendnumcolumns);dimensions.height+=numRows*rowHeight+legendCaptionHeight;config.height=config.totalHeight=dimensions.height;config.rowHeight=rowHeight;config.legendNumColumns=legendnumcolumns;if(config.height-2*symbolPadding>availableHeight){config.height=availableHeight;scroll=config.scroll||(config.scroll={});scroll.enabled=true;scroll.flatScrollBars=config.flatScrollBars;scroll.scrollBar3DLighting=config.scrollBar3DLighting;config.width=config.width+12>availableWidth?config.width:config.width+12}else{config.scroll.enabled=false}usedHeight+=config.height;config.isActive=true;config.enabled=true}else{config.enabled=false;config.width=0;usedHeight=0}return{width:availableWidth,height:usedHeight}};_proto._placeLegendBlockBottom=function _placeLegendBlockBottom(availableHeight){var legend=this,chart=legend.getFromEnv("chart"),chartConfig=chart.config,origRenderWidth=chart.getFromEnv("chartWidth"),origRenderHeight=chart.getFromEnv("chartHeight"),spacingLeft=chartConfig.canvasLeft,spacingRight=chartConfig.width-(chartConfig.canvasRight||0),SmartLabel=chart.getFromEnv("smartLabel"),config=legend.config,marginLeft=config.chartMarginLeft,marginRight=config.chartMarginRight,marginTop=config.chartMarginTop,alignLegendWithCanvas=config.alignLegendWithCanvas,itemArr=legend.getSortedLegendItems(),len=itemArr.length,legendPadding=config.legendPadding,canvasMarginRight=chartConfig.canvasMarginRight,canvasMarginLeft=chartConfig.canvasMarginLeft,yAxis=chart.getChildren("yAxis"),verticalAxis=yAxis&&yAxis[0].config.isVertical?yAxis:chart.getChildren("xAxis"),axis1Obj=verticalAxis&&verticalAxis[0],axis2Obj=verticalAxis&&verticalAxis[1],axis1=axis1Obj&&axis1Obj.config||{},axis2=axis2Obj&&axis2Obj.config||{},title1Width=axis1.nameMaxW,title2Width=axis2.nameMaxW,axis1NameStyle=axis1.name&&axis1.name.style||{},axis2NameStyle=axis2.name&&axis2.name.style||{},axis1Title=axis1.axisName||BLANKSTRING,axis2Title=axis2.axisName||BLANKSTRING,usedHeight,availableWidth=chartConfig.canvasWidth-chartConfig.canvasMarginLeft-chartConfig.canvasMarginRight,yAxisTitleHeight,yAxisTitleWidth,title1,title2;config.paddingBottom=chartConfig.height-chartConfig.canvasBottom;SmartLabel.useEllipsesOnOverflow(chartConfig.useEllipsesWhenOverflow);SmartLabel.setStyle(axis1NameStyle);title1=SmartLabel.getOriSize(axis1Title);SmartLabel.setStyle(axis2NameStyle);title2=SmartLabel.getOriSize(axis2Title);if(availableWidth<legendPadding){config.padding=legendPadding=availableWidth=0}if(title1||title2){yAxisTitleHeight=pluckNumber(title1.height,0)>pluckNumber(title2.height,0)?(yAxisTitleWidth=title1Width)&&title1.width:(yAxisTitleWidth=title2Width)&&title2.width}availableWidth=alignLegendWithCanvas?availableWidth:origRenderWidth-(yAxisTitleHeight+marginTop>origRenderHeight-availableHeight?2*yAxisTitleWidth+marginRight+marginLeft+canvasMarginRight+canvasMarginLeft:marginRight+marginLeft+canvasMarginLeft+canvasMarginRight);if(!config.showLegend||len===0){usedHeight=0;config.height=0;config.width=0}else{config.x=(spacingLeft-marginLeft-spacingRight+marginRight)/2;usedHeight=legend.setDimension({width:availableWidth,height:availableHeight}).height}return{bottom:usedHeight,right:0}};_proto._placeLegendBlockRight=function _placeLegendBlockRight(availWidth){var legend=this,availableWidth=availWidth,legendConf=legend.config,chart=legend.getFromEnv("chart"),chartConf=chart.config,SmartLabel=chart.getFromEnv("smartLabel"),canvasBorderThickness=chart.getChildren("canvas")[0].config.canvasBorderThickness||0,textPadding=legendConf.textPadding,captionPadding=legendConf.title.padding,symbolPadding=legendConf.oriSymbolPadding,legendPadding=legendConf.legendPadding,legendScale=legendConf.legendScale,itemStyle=legend.getStateCosmetics("default"),itemFontSize=parseInt(itemStyle.text["font-size"],10),availableHeight=chartConf.canvasHeight,allowedMaxHeight=availableHeight*2,textWidthUsed=0,padding=legendConf.padding,padding2=2*padding,blockDimensions={width:padding2,height:padding2},dimensions={},validLegendItem=false,itemArr=legend.getSortedLegendItems(),len=itemArr.length,usedWidth,smartText,textWidth,symbolWidthSpace,legendHeight,itemConfig,name,captionWidth,userConfig,i=0,item;legendConf.initialItemY=0;legendConf.initialItemX=0;availableWidth-=padding2+legendPadding;if(availableWidth<legendPadding){legendConf.padding=legendPadding=availableWidth=0}symbolWidthSpace=itemFontSize+1;if(symbolWidthSpace<=0){symbolWidthSpace=1}symbolWidthSpace*=legendScale;symbolPadding*=legendScale;symbolWidthSpace=mathMin(symbolWidthSpace,availableWidth);if(symbolWidthSpace<=0){symbolPadding=symbolWidthSpace=0}legendConf.symbolPadding=symbolPadding;legendConf.symbolWidth=symbolWidthSpace;legendConf.legendHeight=legendHeight=symbolWidthSpace+2*symbolPadding;legendConf.rowHeight=mathMax(parseInt(itemStyle.text["line-height"],10)||12,legendHeight);usedWidth=legendPadding+legendConf.borderWidth/2+canvasBorderThickness;textWidth=availableWidth-legendHeight-legendPadding-textPadding;if(textWidth<0){textWidth=0}SmartLabel.useEllipsesOnOverflow(chartConf.useEllipsesWhenOverflow);SmartLabel.setStyle(extend2({},itemStyle.text));if(!legendConf.showLegend||len===0){dimensions.right=0;legendConf.height=0;legendConf.width=0}else{for(i=0;i<len;i+=1){item=itemArr[i];itemConfig=item.config||(item.config={});userConfig=itemConfig;name=itemConfig.name=parseUnsafeString(userConfig.label);itemConfig._legendX=0;itemConfig._legendY=blockDimensions.height;if(userConfig.enabled===0||userConfig.enabled===false||name===BLANKSTRING){itemConfig.enabled=0;continue}else{itemConfig.enabled=1}validLegendItem=true;if(textWidth===0){blockDimensions.height+=itemConfig._legendH=legendHeight;itemConfig.name=BLANKSTRING;itemConfig._totalWidth=symbolWidthSpace+symbolPadding}else{smartText=SmartLabel.getSmartText(name,textWidth,allowedMaxHeight);itemConfig.name=smartText.text;smartText.tooltext&&(itemConfig.originalText=smartText.tooltext);if(smartText.height<legendHeight){itemConfig._legendTestY=(legendHeight-smartText.height)/2}itemConfig._totalWidth=symbolWidthSpace+symbolPadding+textPadding+smartText.width+legendPadding;blockDimensions.height+=itemConfig._legendH=mathMax(smartText.height,legendHeight);textWidthUsed=mathMax(smartText.width,textWidthUsed)}}legendConf.validLegendItem=validLegendItem;if(validLegendItem){legendConf.itemWidth=textWidthUsed+legendHeight+legendPadding+textPadding;legendConf.width=legendConf.itemWidth+padding2;if(legendConf.title.oriText!==BLANKSTRING){SmartLabel.setStyle(legendConf.title.style);smartText=SmartLabel.getSmartText(legendConf.title.oriText,availableWidth,allowedMaxHeight);legendConf.title.text=smartText.text;smartText.tooltext&&(legendConf.title.originalText=smartText.tooltext);captionWidth=smartText.width+padding2;if(legendConf.width<captionWidth){legendConf.initialItemX=(captionWidth-legendConf.width)/2;legendConf.width=captionWidth}legendConf.initialItemY=smartText.height+captionPadding;blockDimensions.height+=legendConf.initialItemY}legendConf.height=legendConf.totalHeight=blockDimensions.height;usedWidth=mathMin(legendConf.width+usedWidth,availableWidth);dimensions.right=usedWidth+legendPadding;legendConf.isActive=true;legendConf.enabled=true}else{legendConf.enabled=false;legendConf.width=0;dimensions.right=0}}return dimensions};_proto.postSpaceManager=function postSpaceManager(){var legend=this,legendConf=legend.config,legendPosition=legendConf.legendPos,chart=legend.getFromEnv("chart"),availableHeight=chart.config.canvasHeight;if(legendPosition===POSITION_RIGHT){if(legendConf.height>availableHeight){legendConf.height=availableHeight;legendConf.scroll.enabled=true;legendConf.scroll.flatScrollBars=legendConf.flatScrollBars;legendConf.scroll.scrollBar3DLighting=legendConf.scrollBar3DLighting;legendConf.width+=(legendConf.scroll.scrollBarWidth=10)+(legendConf.scroll.scrollBarPadding=2)}else{legendConf.scroll.enabled=false}}};_proto.configureAttributes=function configureAttributes(obj){if(obj===void 0){obj={}}_ComponentInterface.prototype.configureAttributes.call(this,obj);var legend=this,config=legend.config,chart=legend.getFromEnv("chart"),chartConfig=chart.config,legendLineHeight,style=legend.getFromEnv("style"),chartAttr=chart.getFromEnv("chart-attrib"),is3D=chart.config.is3D,colorM=legend.getFromEnv("color-manager"),borderColor,palleteString=is3D?chartPaletteStr.chart3D:chartPaletteStr.chart2D,interactiveLegend=config.interactiveLegend=chart.hasInteractiveLegend!==false&&Boolean(pluckNumber(chartAttr.interactivelegend,1)),borderAlpha,backgroundAlpha,roundEdges=pluckNumber(chartAttr.useroundedges,0),padding=4,outCancolor=style.outCancolor,textStyle=obj.style&&obj.style.text,legendItemFont=pluck(chartAttr.legenditemfont,textStyle&&textStyle["font-family"],style.outCanfontFamily),legendScale=pluckNumber(chartAttr.legendiconscale,1),legendFontSize=pluckFontSize(chartAttr.legenditemfontsize,textStyle&&textStyle["font-size"],style.fontSize)+PXSTRING,legendFontColor=pluck(chartAttr.legenditemfontcolor,textStyle&&textStyle.color,outCancolor).replace(/^#?([a-f0-9]+)/gi,"#$1"),legendItemHoverFontColor=getFirstColor(pluck(chartAttr.legenditemhoverfontcolor,legendFontColor)),anchorMap;config.isActive=false;config.chartMarginTop=chartConfig.origMarginTop;config.chartMarginRight=chartConfig.origMarginRight;config.chartMarginBottom=chartConfig.origMarginBottom;config.chartMarginLeft=chartConfig.origMarginLeft;config.reverselegend=pluckNumber(chartAttr.reverselegend,0);config.showLegend=pluckNumber(chartAttr.showlegend,!chart.dontShowLegendByDefault,1);legendLineHeight=setLineHeight({fontSize:legendFontSize});config.legendPos=pluck(chartAttr.legendposition,chart.legendposition,obj.legendPosition,POSITION_BOTTOM).toLowerCase();config.numColumns=pluckNumber(chartAttr.legendnumcolumns,0);config.xL=config.yL=0;if(legendScale<=0||legendScale>5){legendScale=1}config.drawCustomLegendIcon=pluckNumber(chartAttr.drawcustomlegendicon,obj.drawcustomlegendicon,0);config.legendScale=legendScale;config.legendPadding=pluckNumber(chartAttr.legendpadding,7);config.alignLegendWithCanvas=pluckNumber(obj.alignlegendwithcanvas,chartConfig.alignLegendWithCanvas);config.title.style={fontFamily:pluck(chartAttr.legendcaptionfont,legendItemFont),fontSize:pluckFontSize(chartAttr.legendcaptionfontsize,style.fontSize)+PXSTRING,color:pluck(chartAttr.legendcaptionfontcolor,outCancolor).replace(/^#?([a-f0-9]+)/gi,"#$1"),fontWeight:styleValueMap.fontWeight[pluckNumber(chartAttr.legendcaptionfontbold,1)]||BLANKSTRING};anchorMap=chartAttr.legendcaptionalignment?chartAttr.legendcaptionalignment.toLowerCase():TEXT_ANCHOR_MAP.center;config.title.align=TEXT_ANCHOR_MAP[anchorMap]||TEXT_ANCHOR_MAP.center;config.title.style["text-anchor"]=config.title.align;config.padding=padding;borderColor=pluck(chartAttr.legendbordercolor,colorM.getColor(palleteString.legendBorderColor));borderAlpha=config.borderAlpha=pluckNumber(chartAttr.legendborderalpha,100);config.borderColor=convertColor(borderColor,borderAlpha);config.borderWidth=pluckNumber(chartAttr.legendborderthickness,obj.legendborderthickness,!roundEdges||chartAttr.legendbordercolor?1:0);config.borderRadius=pluckNumber(roundEdges,0);config.backgroundAlpha=backgroundAlpha=pluckNumber(chartAttr.legendbgalpha,obj.legendbgalpha,100);config.backgroundColor=convertColor(pluck(chartAttr.legendbgcolor,colorM.getColor(palleteString.legendBgColor)),backgroundAlpha);config.symbol3DLighting=Boolean(pluckNumber(chartAttr.use3dlighting,chartAttr.useplotgradientcolor,1));config.shadow=Boolean(pluckNumber(chartAttr.legendshadow,1));if(config.shadow){config.shadow={enabled:config.shadow,opacity:mathMax(borderAlpha,backgroundAlpha)/100}}config.prevReversed=Boolean(pluckNumber(config.reversed,0));config.reversed=Boolean(pluckNumber(chartAttr.reverselegend,0));config.lineWidth=pluckNumber(chartAttr.linethickness,2);config.borderRadius=pluckNumber(chartAttr.legendborderradius,roundEdges?3:0);config.legendAllowDrag=Boolean(pluckNumber(chartAttr.legendallowdrag,0));config.title.oriText=parseUnsafeString(getFirstValue(chartAttr.legendcaption,BLANKSTRING));config.legendScrollBgColor=getFirstColor(pluck(chartAttr.legendscrollbgcolor,chartAttr.scrollcolor,colorM.getColor("altHGridColor")));config.legendScrollBarColor=pluck(chartAttr.legendscrollbarcolor,borderColor);config.legendScrollBtnColor=pluck(chartAttr.legendscrollbtncolor,borderColor);config.minimiseWrappingInLegend=pluckNumber(chartAttr.minimisewrappinginlegend,0);config.flatScrollBars=pluckNumber(chartAttr.flatscrollbars,0);config.scrollBar3DLighting=pluckNumber(chartAttr.scrollbar3dlighting,1);config.orderReversed=false;legend.setStateCosmetics("hidden",{symbol:{fill:convertColor(pluck(chartAttr.legenditemhiddencolor,"cccccc").replace(/^#?([a-f0-9]+)/gi,"#$1")),stroke:convertColor(pluck(chartAttr.legenditemhiddencolor,"cccccc").replace(/^#?([a-f0-9]+)/gi,"#$1"))},text:{fill:convertColor(pluck(chartAttr.legenditemhiddencolor,"cccccc").replace(/^#?([a-f0-9]+)/gi,"#$1"))}});legend.setStateCosmetics("default",{text:{fill:convertColor(legendFontColor),"font-family":legendItemFont,cursor:interactiveLegend?preDefStr.POINTER:"default","font-size":legendFontSize,"line-height":legendLineHeight,"vertical-align":POSITION_TOP,"text-anchor":POSITION_START,direction:chartConfig.textDirection==="rtl"?"rtl":"initial","font-weight":styleValueMap.fontWeight[pluckNumber(chartAttr.legenditemfontbold,0)]||BLANKSTRING},symbol:{bgColor:pluck(chartAttr.legendiconbgcolor),cursor:interactiveLegend?preDefStr.POINTER:"default",borderColor:pluck(chartAttr.legendiconbordercolor),bgAlpha:pluck(chartAttr.legendiconbgalpha,chartAttr.legendiconalpha,100),borderAlpha:pluck(chartAttr.legendiconborderalpha,chartAttr.legendiconalpha,100),borderThickness:pluckNumber(chartAttr.legendiconborderthickness),startAngle:pluckNumber(chartAttr.legendiconstartangle,45),sides:pluckNumber(chartAttr.legendiconsides,obj.legendiconsides,4)}});legend.setStateCosmetics("hover",function(cosmetics,legenditem){if(!legenditem.hasState("hidden")){if(!cosmetics.text){cosmetics.text={}}cosmetics.text.fill=convertColor(legendItemHoverFontColor.replace(/^#?([a-f0-9]+)/gi,"#$1"));cosmetics.text.cursor=INHERIT_STR}return cosmetics});if(config.legendAllowDrag&&!config._dragEvtListenerBinded){legend.addEventListener("fc-dragstart",config.handlers.dragstart);legend.addEventListener("fc-dragmove",config.handlers.dragmove);config._dragEvtListenerBinded=true}else if(!config.legendAllowDrag&&config._dragEvtListenerBinded){legend.removeEventListener("fc-dragstart",config.handlers.dragstart);legend.removeEventListener("fc-dragmove",config.handlers.dragmove);config._dragEvtListenerBinded=false}};_proto.getLegendState=function getLegendState(){return this._legendState};_proto.hasState=function hasState(state){var states=this.getLegendState(),i,len;for(i=0,len=states.length;i<len;i++){if(states[i]===state){return true}}return false};_proto.setLegendState=function setLegendState(state,pushAtEnd){if(!this.hasState(state)){if(pushAtEnd){this._legendState.push(state)}else{this._legendState.unshift(state)}}this.asyncDraw()};_proto.removeLegendState=function removeLegendState(state){var i,len,notFound=1;if(state){for(i=0,len=this._legendState.length;i<len&&notFound;i++){if(state===this._legendState[i]){this._legendState.splice(i,1);notFound=0}}}else{this._legendState.length=0}this.asyncDraw()};_proto.setStateCosmetics=function setStateCosmetics(state,cosmetics){this._stateCosmetics[state]=cosmetics};_proto.removeStateCosmetics=function removeStateCosmetics(state){delete this._stateCosmetics[state]};_proto.getStateCosmetics=function getStateCosmetics(state){return this._stateCosmetics[state]};_proto.hide=function hide(){var legend=this,chart=legend.getFromEnv("chart"),legendGroup=chart.getChildContainer("legendGroup");legendGroup&&legendGroup.hide()};return Legend}(ComponentInterface);export default Legend;