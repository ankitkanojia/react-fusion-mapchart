import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import Pie2DDataset from"../../dataset/pie2d";import CommonAPI from"../_internal/commonchartapi";import{pluck,pluckNumber,componentFactory,POSITION_BOTTOM,POSITION_RIGHT,ZEROSTRING,ONESTRING,convertColor,hasSVG}from"@fusioncharts/core/src/lib";import Caption from"../../_internal/components/caption";import SubCaption from"../../_internal/components/sub-caption";import Background from"../../_internal/components/background";import datasetFactory from"../../factories/pie-dataset";import legendItemFactory from"../../factories/legend";import{_manageLegendSpace as _manageLegendSpace2}from"../_internal/legend-spacemanager";import{priorityList}from"@fusioncharts/core/src/schedular";var math=Math,mathMin=math.min,mathMax=math.max,mathAbs=math.abs,mathPI=math.PI,mathRound=math.round,deg2rad=mathPI/180,rad2deg=180/mathPI,PIE_STR="pie",CHART_STR="Pie Chart",PIE2D_STR="Pie2D",count=0,UNDEF,performSlicing=function performSlicing(dataset,indx,slice){var sliceVal=!!slice,index=indx,willSlice=function willSlice(dataPlot){return sliceVal!==dataPlot.config.sliced||typeof slice==="undefined"},data,dataConfig,output,selectedDataPlot;if(!dataset){return output}data=dataset.components&&dataset.components.data||[];index=dataset.config.reversePlotOrder?data.length-index-1:index;selectedDataPlot=data[index];if(selectedDataPlot){dataConfig=selectedDataPlot.config;if(willSlice(selectedDataPlot)){output=dataset.plotGraphicClick.call(selectedDataPlot.graphics.element)}else{output=dataConfig.sliced}}return output};var Pie2D=function(_CommonAPI){_inheritsLoose(Pie2D,_CommonAPI);Pie2D.getName=function getName(){return"Pie2D"};var _proto=Pie2D.prototype;_proto.getName=function getName(){return"Pie2D"};function Pie2D(){var _this;_this=_CommonAPI.call(this)||this;_this.defaultSeriesType=PIE_STR;_this.defaultPlotShadow=1;_this.reverseLegend=1;_this.defaultPaletteOptions=UNDEF;_this.sliceOnLegendClick=true;_this.dontShowLegendByDefault=true;_this.defaultZeroPlaneHighlighted=false;_this.hasCanvas=true;_this.eiMethods={isPlotItemSliced:function isPlotItemSliced(index){var data,config,apiInstance=this.apiInstance,dataset=apiInstance&&apiInstance.getDatasets();return dataset&&(dataset=dataset[0])&&(data=dataset.components.data)&&data[index]&&(config=data[index].config)&&config.sliced},addData:function addData(){var apiInstance=this.apiInstance,dataset=apiInstance&&apiInstance.getDatasets();return dataset&&(dataset=dataset[0])&&dataset.addData.apply(dataset,arguments)},removeData:function removeData(){var apiInstance=this.apiInstance,dataset=apiInstance&&apiInstance.getDatasets();return dataset&&(dataset=dataset[0])&&dataset.removeData.apply(dataset,arguments)},updateData:function updateData(){var apiInstance=this.apiInstance,dataset=apiInstance&&apiInstance.getDatasets();return dataset&&(dataset=dataset[0])&&dataset.updateData.apply(dataset,arguments)},slicePlotItem:function slicePlotItem(index,slice,callback){var fcInstance=this,apiInstance=fcInstance.apiInstance;if(callback){apiInstance.addJob("eiMethods-slice-plot"+count++,function(){var slicingResult=performSlicing(apiInstance.getDatasets()[0],index,slice);return typeof callback==="function"&&callback(slicingResult)},priorityList.postRender)}else{return performSlicing(apiInstance.getDatasets()[0],index,slice)}},startingAngle:function startingAngle(angle,relative,callback){var chart=this.apiInstance,output;if(callback){chart.addJob("eiMethods-start-angle"+count++,function(){output=chart._startingAngle(angle,relative);if(typeof callback==="function"){callback(output)}},priorityList.postRender)}else{return chart._startingAngle(angle,relative)}}};_this.registerFactory("dataset",datasetFactory,["vCanvas","legend"]);_this.registerFactory("legend",legendItemFactory);return _this}_proto.__setDefaultConfig=function __setDefaultConfig(){_CommonAPI.prototype.__setDefaultConfig.call(this);var config=this.config;config.alignCaptionWithCanvas=0;config.formatnumberscale=1;config.isSingleSeries=true;config.friendlyName=CHART_STR;config.defaultDatasetType=PIE2D_STR;config.plotborderthickness=1;config.decimals=2;config.alphaanimation=0;config.singletonPlaceValue=true;config.usedataplotcolorforlabels=0;config.enableslicing=ONESTRING;config.skipCanvasDrawing=true};_proto.parseChartAttr=function parseChartAttr(dataObj){_CommonAPI.prototype.parseChartAttr.call(this,dataObj);var iapi=this,chartAttrs=iapi.getFromEnv("chart-attrib");iapi.config.showLegend=pluckNumber(chartAttrs.showlegend,0)};_proto.configureAttributes=function configureAttributes(dataObj){var iapi=this,chartConfig=iapi.config,toolTipController;iapi.parseChartAttr(dataObj);iapi.createComponent(dataObj);iapi.config.skipConfigureIteration.axis=true;iapi.configureChildren();iapi._createToolBox();toolTipController=iapi.getFromEnv("toolTipController");toolTipController.setStyle({backgroundColor:hasSVG?convertColor(chartConfig.tooltipbgcolor||"FFF",chartConfig.tooltipbgalpha||100):(chartConfig.tooltipbgcolor||"FFF").replace(/\s+/g,"").replace(/^#?([a-f0-9]+)/gi,"#$1"),color:(chartConfig.tooltipcolor||chartConfig.basefontcolor||"545454").replace(/^#?([a-f0-9]+)/gi,"#$1"),borderColor:hasSVG?convertColor(chartConfig.tooltipbordercolor||"666",chartConfig.tooltipborderalpha||100):(chartConfig.tooltipbordercolor||"666").replace(/\s+/g,"").replace(/^#?([a-f0-9]+)/gi,"#$1"),borderWidth:pluckNumber(chartConfig.tooltipborderthickness,1)+"px",showToolTipShadow:pluckNumber(chartConfig.showtooltipshadow||0),borderRadius:pluckNumber(chartConfig.tooltipborderradius,0),fontSize:pluckNumber(chartConfig.basefontsize,10)+"px",fontFamily:chartConfig.basefont||this.getFromEnv("style").inCanfontFamily,padding:pluckNumber(chartConfig.tooltippadding||3)+"px"})};_proto._createLayers=function _createLayers(){_CommonAPI.prototype._createLayers.call(this);var animationManager=this.getFromEnv("animationManager");!this.getChildContainer("legendGroup")&&this.addChildContainer("legendGroup",animationManager.setAnimation({el:"group",attr:{name:"legend"},component:this,container:this.getContainer("parentgroup"),label:"group"}))};_proto.createComponent=function createComponent(){var iapi=this,skipConfigureIteration;skipConfigureIteration=iapi.config.skipConfigureIteration={};iapi.createBaseComponent();iapi.getFromEnv("animationManager").setAnimationState(iapi._firstConfigure?"initial":"update");componentFactory(iapi,Caption,"caption");skipConfigureIteration.caption=true;componentFactory(iapi,SubCaption,"subCaption");skipConfigureIteration.subCaption=true;componentFactory(iapi,Background,"background");skipConfigureIteration.background=true;skipConfigureIteration.canvas=true;iapi._createConfigurableComponents&&iapi._createConfigurableComponents();if(iapi.config.realtimeEnabled){iapi._realTimeConfigure&&iapi._realTimeConfigure()}};_proto._postSpaceManagement=function _postSpaceManagement(){this.config.showLegend&&this.getChildren("legend")&&this.getChildren("legend")[0].postSpaceManager();this.allocateDimensionOfChartMenuBar()};_proto._checkInvalidSpecificData=function _checkInvalidSpecificData(){var chart=this,chartAttr=chart.getFromEnv("dataSource"),i,len,zeroSum=0,nullSum=0,data=chartAttr.data,value;if(!data){return true}len=data.length||0;for(i=0;i<len;i++){value=Number(data[i].value);zeroSum+=!isNaN(value)&&value===0?1:0;nullSum+=isNaN(value)?1:0}if(zeroSum+nullSum>=len){return true}return false};_proto._spaceManager=function _spaceManager(){var chart=this,chartConfig=chart.config,dataSet=chart.getChildren("dataset")[0],data=dataSet.components.data,conf=dataSet.config,legend=chart.getFromEnv("legend"),colorM=chart.getFromEnv("color-manager"),SmartLabel=chart.getFromEnv("smartLabel"),chartwidth=chart.getFromEnv("chartWidth"),chartHeight=chart.getFromEnv("chartHeight"),textWidthArr=[],length=conf.dataLabelCounter,labelMaxW=0,fcJSONChart=chart.getFromEnv("dataSource").chart,manageLabelOverflow=pluckNumber(fcJSONChart.managelabeloverflow,0),userGivenSlicingDist=pluckNumber(fcJSONChart.slicingdistance),slicingDistance=!conf.preSliced&&chartConfig.allPlotSliceEnabled===ZEROSTRING&&(fcJSONChart.showlegend!==ONESTRING||fcJSONChart.interactivelegend===ZEROSTRING)?0:mathAbs(pluckNumber(userGivenSlicingDist,20)),isPieRadiusInPerentage=/%/g.test(fcJSONChart.pieradius),pieRadius=pluckNumber(isPieRadiusInPerentage?Math.min(chartwidth/2,chartHeight/2)*(parseFloat(fcJSONChart.pieradius)/100):fcJSONChart.pieradius,0),enableSmartLabels=pluckNumber(fcJSONChart.enablesmartlabels,fcJSONChart.enablesmartlabel,1),skipOverlapLabels=enableSmartLabels?pluckNumber(fcJSONChart.skipoverlaplabels,fcJSONChart.skipoverlaplabel,1):0,isSmartLineSlanted=pluckNumber(fcJSONChart.issmartlineslanted,1),labelDistance=length?pluckNumber(fcJSONChart.labeldistance,fcJSONChart.smartlabelclearance,5):slicingDistance,totalDistnace=labelDistance,width=chartConfig.width,height=chartConfig.height,actionBarHeight=(chart._manageActionBarSpace(height*.225)||{}).bottom,chartWorkingWidth=width-(chartConfig.marginRight+chartConfig.marginLeft),chartWorkingHeight=height-(chartConfig.marginTop+chartConfig.marginBottom)-(actionBarHeight?actionBarHeight+chartConfig.marginBottom:0),minOfWH=mathMin(chartWorkingHeight,chartWorkingWidth),smartLineColor=pluck(fcJSONChart.smartlinecolor,colorM.getColor("plotFillColor")),smartLineAlpha=pluckNumber(fcJSONChart.smartlinealpha,100),smartLineThickness=pluckNumber(fcJSONChart.smartlinethickness,.7),dataLabelOptions=conf.dataLabelOptions=dataSet._parseDataLabelOptions(),style=dataLabelOptions.style,lineHeight=length?pluckNumber(parseInt(style.lineHeight,10),12):0,pieMinRadius=pieRadius===0?minOfWH*.15:pieRadius,pieMinDia=2*pieMinRadius,legendSpace={bottom:0,right:0},captionSpace,pieYScale=conf.pieYScale,pieSliceDepth=conf.pieSliceDepth,textObj,avaiableMaxpieSliceDepth,totalSpaceReq;dataLabelOptions.connectorWidth=smartLineThickness;dataLabelOptions.connectorPadding=pluckNumber(fcJSONChart.connectorpadding,5);dataLabelOptions.connectorColor=convertColor(smartLineColor,smartLineAlpha);if(length){totalDistnace=labelDistance+slicingDistance}totalSpaceReq=pieMinDia+(lineHeight+totalDistnace)*2;captionSpace=chart._manageChartMenuBar(totalSpaceReq<chartWorkingHeight?chartWorkingHeight-totalSpaceReq:chartWorkingHeight/2);chartWorkingHeight-=(captionSpace.top||0)+(captionSpace.bottom||0);if(conf.showLegend){chart.config.hasLegend=true;if(pluck(fcJSONChart.legendposition,POSITION_BOTTOM).toLowerCase()!==POSITION_RIGHT){legendSpace=legend._manageLegendPosition(chartWorkingHeight/2);chartWorkingHeight-=legendSpace.bottom}else{legendSpace=legend._manageLegendPosition(chartWorkingHeight/2);chartWorkingWidth-=legendSpace.right}}chart._allocateSpace(legendSpace);SmartLabel.useEllipsesOnOverflow(chartConfig.useEllipsesWhenOverflow);if(length!==1){for(;length--;){SmartLabel.setStyle(data[length].config.style||chartConfig.dataLabelStyle);textWidthArr[length]=textObj=SmartLabel.getOriSize(data[length].config.displayValue);labelMaxW=mathMax(labelMaxW,textObj.width)}}if(pieRadius===0){pieMinRadius=chart._stubRadius(chartWorkingWidth,labelMaxW,chartWorkingHeight,totalDistnace,slicingDistance,lineHeight,pieMinRadius,labelDistance)}else{conf.slicingDistance=slicingDistance;conf.pieMinRadius=pieMinRadius;dataLabelOptions.distance=labelDistance}avaiableMaxpieSliceDepth=chartWorkingHeight-2*(pieMinRadius*pieYScale+lineHeight);conf.managedPieSliceDepth=pieSliceDepth>avaiableMaxpieSliceDepth?pieSliceDepth-avaiableMaxpieSliceDepth:conf.pieSliceDepth;dataLabelOptions.isSmartLineSlanted=isSmartLineSlanted;dataLabelOptions.enableSmartLabels=enableSmartLabels;dataLabelOptions.skipOverlapLabels=skipOverlapLabels;dataLabelOptions.manageLabelOverflow=manageLabelOverflow};_proto._stubRadius=function _stubRadius(chartWorkingWidth,labelMaxW,chartWorkingHeight,totalDist,sliceDistance,lineHeight,minRadius,labelDistance){var chart=this,pieMinRadius=minRadius,slicingDistance=sliceDistance,dataSet=chart.getChildren("dataset")[0],conf=dataSet.config,fcJSONChart=chart.getFromEnv("dataSource").chart,userGivenSlicingDist=pluckNumber(fcJSONChart.slicingdistance),dataLabelOptions=conf.dataLabelOptions||(conf.dataLabelOptions=dataSet._parseDataLabelOptions()),availableRadius=0,MINSLICINGDIST=10,shortFall;availableRadius=mathMin(chartWorkingWidth/2-labelMaxW-slicingDistance,chartWorkingHeight/2-lineHeight)-totalDist;if(availableRadius>=pieMinRadius){pieMinRadius=availableRadius}else if(!userGivenSlicingDist){shortFall=pieMinRadius-availableRadius;slicingDistance=mathMax(mathMin(totalDist-shortFall,slicingDistance),MINSLICINGDIST)}conf.slicingDistance=slicingDistance;conf.pieMinRadius=pieMinRadius;dataLabelOptions.distance=labelDistance;return pieMinRadius};_proto._startingAngle=function _startingAngle(angl,relative){var angle=angl,ang,chart=this,dataSet=chart.getChildren("dataset")[0],seriesData=dataSet.config,currentAngle=(ang=seriesData.startAngle)*-rad2deg+(-1*ang<0?360:0);if(!isNaN(angle)){if(!(seriesData.singletonCase||seriesData.isRotating)){angle+=relative?currentAngle:0;seriesData.startAngle=-angle*deg2rad;dataSet._rotate(angle);currentAngle=angle}}return mathRound(((currentAngle%=360)+(currentAngle<0?360:0))*100)/100};_proto._manageLegendSpace=function _manageLegendSpace(){_manageLegendSpace2.call(this)};_proto.getDSdef=function getDSdef(){return Pie2DDataset};return Pie2D}(CommonAPI);export default Pie2D;