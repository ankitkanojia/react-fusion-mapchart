import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import{extend2,PROJECT_VERSION,pluckNumber,pluck,RGBtoHex,BLANKSTRING}from"@fusioncharts/core/src/lib";import{ComponentInterface}from"@fusioncharts/core/src/component-interface";import{downloadCharts,browserDetails,drawSvgOnCanvas,isCanvasElemSupported}from"../utils/lib-svg-to-canvas";import{addImage,getDataUrl}from"../utils/jpeg-to-pdf";import{EXPORTACTION,EXPORTMODE,EXPORTFORMAT,LOGMODE,createExportActionOldString,cacheAllImages,makeImageUrlsAbsolute,embedImagesWithNonDataURL,replaceImagesWithNonDataUrl,hasUndownloadableImage,logCharts,svgStrToDataUrl}from"../utils/export-utils";import{getDep}from"@fusioncharts/core/src/dependency-manager";var copyExportOptions=function copyExportOptions(object){var newObject={},key;for(key in object){newObject[key.toLowerCase()]=object[key]}return newObject},DEFAULT_BG_COLOR="#FFFFFF";var isObject=function isObject(obj){return typeof obj==="object"},getBackgroundColor=function getBackgroundColor(chartInstance){if(chartInstance.jsVars.transparent||pluckNumber(chartInstance.options.containerBackgroundOpacity,1)===0){return BLANKSTRING}return chartInstance.options.containerBackgroundColor||DEFAULT_BG_COLOR},getBackgroundAlpha=function getBackgroundAlpha(chartInstance){if(chartInstance.jsVars.transparent){return 0}return pluckNumber(chartInstance.options.containerBackgroundOpacity,1)+""},IMAGEDATA="IMAGE-DATA",xAttrRegx=/\s\bx\b=['"][^'"]+?['"]/gi,yAttrRegx=/\s\by\b=['"][^'"]+?['"]/gi,win=window,doc=win.document,DEFAULT_EXPORT_URL=win.location.protocol==="https:"?"https://export.api3.fusioncharts.com/":"http://export.api3.fusioncharts.com/",DEFAULT_LOG_URL=win.location.protocol==="https:"?"https://export.api3.fusioncharts.com/api/v1.0/logs":"http://export.api3.fusioncharts.com/api/v1.0/logs",isIOS=win.navigator.userAgent.match(/(iPad|iPhone|iPod)/g);var ExportModule=function(_ComponentInterface){_inheritsLoose(ExportModule,_ComponentInterface);function ExportModule(){var _this;_this=_ComponentInterface.call(this)||this;_this.config={exportOption:{},chartConfig:{caption:"",subcaption:"",width:"",height:""}};return _this}var _proto=ExportModule.prototype;_proto.getName=function getName(){return"exportModule"};_proto.getType=function getType(){return"extension"};_proto.configureMenuBar=function configureMenuBar(){var exporter=this,toolbar=exporter.getFromEnv("toolbar"),isbtoaSupported=!!win.btoa,exportString="Export As ",chartObj=exporter.getFromEnv("chart"),exportFormats=exporter.getFromEnv("chart-attrib").exportformats,hamBurger=toolbar.getChild("hamburgerMenu-"+toolbar.getId()+"-"+chartObj.getId()+"-0"),exportTypes,exportParam,type,excelexport=getDep("Excelexport"),i,isTimeseriesChart=chartObj.getName()==="timeseries",length,fn,exportMap={PNG:exportString+EXPORTFORMAT.PNG.toUpperCase(),JPG:exportString+EXPORTFORMAT.JPG.toUpperCase(),PDF:exportString+EXPORTFORMAT.PDF.toUpperCase(),SVG:exportString+EXPORTFORMAT.SVG.toUpperCase(),XLSX:exportString+EXPORTFORMAT.XLSX.toUpperCase()},exportOptionObj,list=[],usrExportType;if(exporter.config.exportOption.exportenabled){fn=function fn(exportTypeName){return function(){exporter.config.exportOption.exportformat=exportTypeName;exporter.exportChart({})}};if(exportFormats){exportTypes=exportFormats.split("|");for(i=0,length=exportTypes.length;i<length;i++){exportParam=exportTypes[i].split("=");type=exportParam[0].toUpperCase();exportMap[type]&&(exportMap[type]=exportParam[1]||exportMap[type]);exportMap[type]&&(usrExportType||(usrExportType={}))&&(usrExportType[type]=true)}}for(type in exportMap){if(type==="XLSX"&&(!isbtoaSupported||!excelexport||excelexport&&excelexport.then)||usrExportType&&!usrExportType[type]){continue}exportOptionObj={name:exportMap[type],handler:fn(type),action:"click"};list.push(exportOptionObj)}hamBurger.appendInMenu(list);if(isbtoaSupported&&!isTimeseriesChart&&excelexport&&excelexport.then){excelexport.then(function(){hamBurger.appendInMenu([{name:exportMap.XLSX,handler:fn("XLSX"),action:"click"}]);hamBurger.asyncDraw()})}}};_proto.configure=function configure(options){var chartInstance=this.getFromEnv("chartInstance"),exportConfig=this.config,exportChartConfig=exportConfig.chartConfig,exportOption=exportConfig.exportOption,config=options.chartConfig;config.caption&&(exportChartConfig.caption=pluck(config.caption,""));config.subcaption&&(exportChartConfig.subcaption=pluck(config.subcaption,""));exportOption.exportenabled=pluckNumber(config.exportenabled,0);exportOption.exportshowmenuitem=pluckNumber(config.exportshowmenuitem,1);exportOption.exportformat=pluck(config.exportformat,EXPORTFORMAT.PNG);exportOption.exporthandler=pluck(config.html5exporthandler,config.exporthandler,DEFAULT_EXPORT_URL);exportOption.exportaction=function(){var exportAction;if(config.exportaction&&typeof config.exportaction==="string"){exportAction=config.exportaction.toLowerCase();return[EXPORTACTION.DOWNLOAD,EXPORTACTION.SAVE,EXPORTACTION.DOWNLOADSAVE].indexOf(exportAction)>=0?exportAction:EXPORTACTION.DOWNLOAD}return EXPORTACTION.DOWNLOAD}();exportOption.exporttargetwindow=pluck(config.exporttargetwindow,isIOS?"_parent":"_self");exportOption.exportfilename=pluck(config.exportfilename,"FusionCharts");exportOption.exportparameters=pluck(config.exportparameters,"");exportOption.exportcallback=pluck(config.exportcallback,"");exportOption.exportwithimages=pluckNumber(config.exportwithimages,1);exportOption.exportmode=function(){var exportMode;if(typeof config.exportatclientside!=="undefined"){exportMode={1:EXPORTMODE.AUTO,0:EXPORTMODE.AUTO}[config.exportatclientside]}exportMode=config.exportmode||exportMode||EXPORTMODE.AUTO;exportMode=exportMode.toLowerCase();return exportMode}();exportOption.logenabled=pluckNumber(config.logenabled,0);exportOption.loghandler=pluck(config.html5loghandler,config.loghandler,DEFAULT_LOG_URL);exportOption.logmode=function(){var logMode=config.logmode;if(typeof logMode!=="undefined"&&typeof logMode==="string"&&logMode.toUpperCase()in LOGMODE){return LOGMODE[logMode.toUpperCase()]}return LOGMODE.AUTO}();exportOption.bgcolor=getBackgroundColor(chartInstance);exportOption.bgalpha=getBackgroundAlpha(chartInstance);if(exportOption.exportshowmenuitem){this.configureMenuBar()}};_proto.exportChart=function exportChart(exportOption){var chartInstance=this.getFromEnv("chartInstance"),chart=this.getFromEnv("chart"),exportOptionsLowerKeys=isObject(exportOption)&&copyExportOptions(exportOption)||{},optionsExport=extend2(extend2({},this.config.exportOption),exportOptionsLowerKeys),exportFormat=(optionsExport.exportformat||EXPORTFORMAT.PNG).toLowerCase(),exportHandler=optionsExport.exporthandler,exportAction=optionsExport.exportaction,exportTargetWindow=optionsExport.exporttargetwindow||"",exportFileName=optionsExport.exportfilename,exportParameters=optionsExport.exportparameters,exportCallback=optionsExport.exportcallback,exportWithImages=optionsExport.exportwithimages,exportMode=optionsExport.exportmode,logEnabled=optionsExport.logenabled,logHandler=optionsExport.loghandler,logMode=optionsExport.logmode,xlsArr,csv,excelUri,self=this,undef,fireExportDataReadyEventOnChart=function fireExportDataReadyEventOnChart(postData){chart.fireChartInstanceEvent("exportDataReady",postData)};chart.fireChartInstanceEvent("beforeExport",optionsExport,undef,function(){var chartId=chartInstance.id,chartCaption=self.config.chartConfig.caption,chartSubcaption=self.config.chartConfig.subcaption,paper=this.apiInstance.getFromEnv("paper"),useCanvas=this.apiInstance.getFromEnv("core-options")["export"].useCanvas,postData,svg,svgForClientSideExport,chartMenuBar=chart.getChildren("chartMenuBar")[0],hamBurger=chartMenuBar.getChild("hamburgerMenu-"+chartMenuBar.getId()+"-"+chart.getId()+"-0"),containerGroup,clientSideExportedEventsParam={DOMId:chartId,height:paper.height,width:paper.width,fileName:exportFileName+"."+exportFormat,statusCode:undef,statusMessage:undef,notice:undef},exportOptionObject={exportAction:exportAction,exportTargetWindow:exportTargetWindow,exportCallback:exportCallback,fusionCharts:chartInstance,paper:paper,chartId:chartId,exportHandler:exportHandler,logEnabled:logEnabled,logMode:logMode,logHandler:logHandler},createPostDataForExport=function createPostDataForExport(streamType,streamValue,configuredExportAction){var _logEnabled;_logEnabled=!!logEnabled;if(logMode===LOGMODE.CLIENT){_logEnabled=false}return{charttype:chartInstance.chartType(),stream_type:streamType||"",stream:streamValue||"",meta_bgColor:optionsExport.bgcolor||"",meta_bgAlpha:optionsExport.bgalpha||"1",meta_DOMId:chartInstance.id,meta_width:paper.width||self.config.chartConfig.width,meta_height:paper.height||self.config.chartConfig.height,chart_caption:chartCaption,chart_sub_caption:chartSubcaption,is_single_export:true,is_full_version:!true,version:PROJECT_VERSION,user_time_zone:-(new Date).getTimezoneOffset(),log_enabled:_logEnabled,parameters:["exportfilename="+exportFileName,"exportformat="+exportFormat,"exportaction="+createExportActionOldString(exportAction),"exportactionnew="+exportAction,"configuredexportaction="+(configuredExportAction||exportAction),"exportparameters="+exportParameters].join("|")}},createPostDataForLog=function createPostDataForLog(){return{chartType:chartInstance.chartType(),chartCaption:chartCaption,chartSubCaption:chartSubcaption,isSingleExport:true,isFullVersion:!true,exportAction:exportAction,userTimeZone:-(new Date).getTimezoneOffset(),exportFileName:[exportFileName,exportFormat].join("."),exportFormat:exportFormat,version:PROJECT_VERSION}},noPrepareAndExportData=function noPrepareAndExportData(svgToExport){downloadCharts(null,null,null,createPostDataForExport(EXPORTFORMAT.SVG,svgToExport),exportOptionObject)},prepareAndExportData=function prepareAndExportData(svgToExportURL){var canvas,exportPostData,svgToExport=svgToExportURL;if(browserDetails.hasCanvas&&typeof win.btoa!=="undefined"){canvas=doc.createElement("canvas");canvas.width=paper.width;canvas.height=paper.height;svgToExport=embedImagesWithNonDataURL(svgToExport);svgForClientSideExport=replaceImagesWithNonDataUrl(svgForClientSideExport);if(hasUndownloadableImage(svgToExport)||exportFormat===EXPORTFORMAT.SVG){exportPostData=createPostDataForExport(EXPORTFORMAT.SVG,svgToExport);downloadCharts(null,null,null,exportPostData,exportOptionObject)}else{drawSvgOnCanvas({svg:svgForClientSideExport,canvas:canvas,x:0,y:0,width:paper.width,height:paper.height,useCanvas:useCanvas},function(){var dataURI;switch(exportFormat){case EXPORTFORMAT.PNG:dataURI=canvas.toDataURL("image/png");break;case EXPORTFORMAT.JPEG:dataURI=canvas.toDataURL("image/jpeg");break;case EXPORTFORMAT.PDF:addImage(canvas.toDataURL("image/jpeg"),paper.height,paper.width);dataURI=getDataUrl();break;default:dataURI=canvas.toDataURL("image/jpeg");break}exportPostData=createPostDataForExport(IMAGEDATA,dataURI);downloadCharts(null,null,null,exportPostData,exportOptionObject)})}}else{noPrepareAndExportData(svgToExport)}},getImageDataUrl=function getImageDataUrl(type,callback,exportOptions){var canvas;canvas=doc.createElement("canvas");canvas.width=paper.width;canvas.height=paper.height;drawSvgOnCanvas({svg:svgForClientSideExport,canvas:canvas,x:0,y:0,width:paper.width,height:paper.height,useCanvas:useCanvas},function(){switch(type){case EXPORTFORMAT.PNG:callback(type,canvas.toDataURL("image/png"),exportFileName,exportOptions);break;case EXPORTFORMAT.JPEG:callback(type,canvas.toDataURL("image/jpeg"),exportFileName,exportOptions);break;case EXPORTFORMAT.PDF:callback(type,canvas.toDataURL("image/jpeg"),exportFileName,exportOptions);break;default:callback(type,canvas.toDataURL("image/jpeg"),exportFileName,exportOptions);break}})},prepareClientSideDownload=function prepareClientSideDownload(exportFrmt,userImageUrl,exprtFileName,downloadOptions,mode){var imageUrl=userImageUrl;if(exportFrmt===EXPORTFORMAT.PDF){addImage(imageUrl,paper.height,paper.width);imageUrl=getDataUrl()}if(mode===EXPORTMODE.AUTO){postData=createPostDataForExport(IMAGEDATA,imageUrl)}else{postData=null}downloadCharts("url",imageUrl,exprtFileName+"."+exportFrmt,postData,downloadOptions)},saveAfterProcessingAtClientSide=function saveAfterProcessingAtClientSide(svgToExport,exportOptions,callback){var svgDataURI,callbackModified;if(exportFormat===EXPORTFORMAT.SVG){svgDataURI=svgStrToDataUrl(svgToExport);callback(svgDataURI,exportOptions)}else{callbackModified=function callbackModified(){callback(arguments[1],exportOptions)};getImageDataUrl(exportFormat,callbackModified,exportOptions)}},exportAtClientSide=function exportAtClientSide(svgToBeExported,exportOptions,mode){var svgDataURI,prepareClientSideDownloadModified;if(exportFormat===EXPORTFORMAT.SVG){svgDataURI=svgStrToDataUrl(svgToBeExported);if(mode===EXPORTMODE.AUTO){postData=createPostDataForExport(IMAGEDATA,svgDataURI)}else{postData=null}downloadCharts("url",svgDataURI,exportFileName+"."+exportFormat,postData,exportOptions)}else{prepareClientSideDownloadModified=function prepareClientSideDownloadModified(){prepareClientSideDownload(arguments[0],arguments[1],arguments[2],arguments[3],mode)};getImageDataUrl(exportFormat,prepareClientSideDownloadModified,exportOptions)}},createXlsArr=function createXlsArr(){var count=0;xlsArr=[];csv.replace(/[^\r\n]+/g,function(match){xlsArr[count]=[];xlsArr[count]=match.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(function(x){return x.replace(/"/g,BLANKSTRING)});count+=1})},raiseEventExportDataReady=fireExportDataReadyEventOnChart,logSeparatelyIfLogModeCLient=function logSeparatelyIfLogModeCLient(mode){if(mode===LOGMODE.CLIENT){logCharts(createPostDataForLog(),exportOptionObject)}},browserCanSelfDownload,configuredExportAction,exportJSONtoEXCEL,dontCacheImages;if(exportFormat==="xlsx"){if(typeof win.btoa!=="undefined"){csv=chartInstance.getCSVData()}else{chart.fireChartInstanceEvent("exportCancelled",optionsExport);return false}raiseEventExportDataReady();createXlsArr();exportJSONtoEXCEL=getDep("ExcelExport");exportJSONtoEXCEL&&exportJSONtoEXCEL(xlsArr).then(function(content){excelUri=content;browserCanSelfDownload=typeof win.btoa!=="undefined"&&(browserDetails.name==="Chrome"||browserDetails.name==="Firefox"||browserDetails.name==="Safari"||browserDetails.name==="Edge"||browserDetails.name==="ie");if(exportMode!=="server"&&browserCanSelfDownload){if(exportAction===EXPORTACTION.DOWNLOAD||exportAction===EXPORTACTION.DOWNLOADSAVE){downloadCharts("blob",excelUri,exportFileName+"."+exportFormat,null,exportOptionObject);chart.fireChartInstanceEvent("exported",clientSideExportedEventsParam)}if(exportAction===EXPORTACTION.SAVE||exportAction===EXPORTACTION.DOWNLOADSAVE){configuredExportAction=exportAction;if(exportAction===EXPORTACTION.DOWNLOADSAVE){exportAction=EXPORTACTION.SAVE}postData=createPostDataForExport(IMAGEDATA,excelUri,configuredExportAction);downloadCharts(null,null,null,postData,exportOptionObject);logSeparatelyIfLogModeCLient(logMode)}else if(logMode!==LOGMODE.SERVER){logCharts(createPostDataForLog(),exportOptionObject)}}else{var fileReader=new FileReader;fileReader.onload=function serverSideExport(e){var tempUintArrayStr=BLANKSTRING,bytes=new Uint8Array(e.target.result),length=bytes.byteLength;for(var i=0;i<length;i++){tempUintArrayStr+=String.fromCharCode(bytes[i])}tempUintArrayStr="data:application/vnd.ms-excel;base64,"+win.btoa(tempUintArrayStr);downloadCharts(null,null,null,createPostDataForExport(IMAGEDATA,tempUintArrayStr),exportOptionObject);logSeparatelyIfLogModeCLient(logMode)};fileReader.readAsArrayBuffer(excelUri)}})}else{containerGroup=hamBurger.getChild("listContainer").getLinkedParent().getGraphicalElement("button","button");containerGroup&&containerGroup.attr("visibility","hidden");svg=paper.toSVG(exportWithImages);svgForClientSideExport=paper.toSVG(exportWithImages&&isCanvasElemSupported());svgForClientSideExport=svgForClientSideExport.replace(/&nbsp;/gi," ");containerGroup&&containerGroup.attr("visibility","visible");svg=svg.replace(/(\sd\s*=\s*["'])[M\s\d\.]*(["'])/gi,"$1M 0 0 L 0 0$2");svg=svg.replace(/NS\d+:/gi,"xlink:");svg=svg.replace(/&nbsp;/gi," ");svgForClientSideExport=svgForClientSideExport.replace(/NS\d+:/gi,"xlink:");svgForClientSideExport=svgForClientSideExport.replace(/(\sd\s*=\s*["'])[M\s\d\.]*(["'])/gi,"$1M 0 0 L 0 0$2");svgForClientSideExport=svgForClientSideExport.replace(/(xlink:title\s*=\s*)['"].*?["']/gi,"");svg=svg.replace(/[\w\-]+\=\"undefined\"/gi,"");svg=svg.replace(/(xlink:title\s*=\s*)['"].*?["']/gi,"");svg=svg.replace(/rgba\(([^\)]+)\)/gi,function(RGBStr){return"#"+new RGBtoHex(RGBStr.split(","))});svg=svg.replace(/<svg[^>]+/i,function(svgString){var str=svgString;if(!str.match(/height/i)&&(paper.height||self.config.chartConfig.height)){str+=' height="'+(paper.height||self.config.chartConfig.height)+'"'}if(!str.match(/width/i)&&(paper.width||self.config.chartConfig.width)){str+=' width="'+(paper.width||self.config.chartConfig.width)+'"'}return str});svg=svg.replace(/(([\w]+\-)?opacity\s*=\s*)['"][\d\.]+e[\-\+][\d]+["']/gi,'$1"0.001"');svg=svg.replace(/(([\w]+\-)?opacity\s*:\s*)[\d\.]+e[\-\+][\d]+/gi,"$10.001");svg=svg.replace(/<text[^\>]+/gi,function(text){var fullText=text;fullText=fullText.replace(/stroke\=[\"\']([a-z0-9\#]+)?[\"\']/gi,"");fullText=fullText.replace(/stroke\s*\:\s*([a-z0-9\#]+)?;?/gi,"");fullText=fullText.replace(/stroke-width\=[\"\']([a-z0-9\#]+)?[\"\']/gi,"");fullText=fullText.replace(/stroke-width\s*\:\s*([a-z0-9\#]+)?;?/gi,"");fullText=fullText.replace(/stroke-opacity\=[\"\']([a-z0-9\#]+)?[\"\']/gi,"");fullText=fullText.replace(/stroke-opacity\s*\:\s*([a-z0-9\#]+)?;?/gi,"");fullText=fullText.replace(/(<text[^\>]+fill\=)([\"\'][^\"\']+[\"\'])([^\>]+)/gi,'$1$2 stroke=$2 stroke-width="0.2"$3');fullText=fullText.replace(/(<text[^\>]+fill-opacity\=)([\"\'][^\"\']+[\"\'])([^\>]+)/gi,"$1$2 stroke-opacity=$2 $3");return fullText});svg=svg.replace(/<(\b[^<>s\s]+\b)[^\>]+?opacity\s*=\s*['"][^1][^\>]+?(\/>|>[\s\r\n]*?<\/\1>)/gi,function(fullText,tagName){var recrXCommand=xAttrRegx.exec(fullText)||"",recrYCommand=yAttrRegx.exec(fullText)||"",prop;prop=' opacity="1" stroke-opacity="1" fill="#cccccc" stroke-width="0" r="0" height="0.5" width="0.5" d="M 0 0 L 1 1" />';return fullText+"<"+tagName+recrXCommand+recrYCommand+prop});svg=makeImageUrlsAbsolute(svg);svgForClientSideExport=makeImageUrlsAbsolute(svgForClientSideExport);dontCacheImages=exportMode===EXPORTMODE.SERVER;cacheAllImages(svg,dontCacheImages,function(){postData=createPostDataForExport(EXPORTFORMAT.SVG,svg);raiseEventExportDataReady(postData);postData=null;var configuredExptAction,canBrowserSelfDownload=typeof win.btoa!=="undefined"&&(browserDetails.name==="Chrome"||browserDetails.name==="Firefox"||browserDetails.name==="Safari"||browserDetails.name==="Edge"||browserDetails.name==="ie");if((exportMode===EXPORTMODE.CLIENT||exportMode===EXPORTMODE.AUTO&&!hasUndownloadableImage(svg))&&canBrowserSelfDownload){svgForClientSideExport=replaceImagesWithNonDataUrl(svgForClientSideExport);if(exportAction===EXPORTACTION.DOWNLOAD||exportAction===EXPORTACTION.DOWNLOADSAVE){exportAtClientSide(svgForClientSideExport,exportOptionObject,exportMode);chart.fireChartInstanceEvent("exported",clientSideExportedEventsParam)}if(exportAction===EXPORTACTION.SAVE||exportAction===EXPORTACTION.DOWNLOADSAVE){configuredExptAction=exportAction;if(exportAction===EXPORTACTION.DOWNLOADSAVE){exportAction=EXPORTACTION.SAVE}saveAfterProcessingAtClientSide(svgForClientSideExport,exportOptionObject,function(dataUri,exportOptionObj){postData=createPostDataForExport(IMAGEDATA,dataUri,configuredExptAction);downloadCharts(null,null,null,postData,exportOptionObj);logSeparatelyIfLogModeCLient(logMode)});chart.fireChartInstanceEvent("exported",clientSideExportedEventsParam)}else if(logMode!==LOGMODE.SERVER){logCharts(createPostDataForLog(),exportOptionObject)}}else if(exportMode===EXPORTMODE.AUTO){prepareAndExportData(svg);logSeparatelyIfLogModeCLient(logMode)}else if(exportMode===EXPORTMODE.SERVER){noPrepareAndExportData(svg);logSeparatelyIfLogModeCLient(logMode)}})}},function(){chart.fireChartInstanceEvent("exportCancelled",optionsExport)})};return ExportModule}(ComponentInterface);export{ExportModule as default};