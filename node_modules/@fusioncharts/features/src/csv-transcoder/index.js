import{raiseError}from"@fusioncharts/core/src/event-api";import{BLANKSTRING}from"@fusioncharts/core/src/lib";var win=window,FCGlobal,UNDEF,COMMA=",",QUOTE='"',APOS="'",TAB="\t",CRLF="\r\n",LIT_QUOT="{quot}",LIT_TAB="{tab}",LIT_APOS="{apos}",toInt=win.parseInt,toFloat=win.parseFloat,returnFirstArgument=function returnFirstArgument(x){return x},jsonToCsv,csvToJson,multilevelPieCsv,_recursiveCategoryCall,multiPieData,multiPieLineCount,headerLen,counter;var DSV=function(){function DSV(config){this.data=[];this.rowCount=0;this.columnCount=0;this.configure(config)}var _proto=DSV.prototype;_proto.set=function set(row,col,value){var i;if(this.rowCount<=row){for(i=this.rowCount;i<=row;i+=1){this.data[i]=[]}this.rowCount=row+1}if(this.columnCount<=col){this.columnCount=col+1}this.data[row][col]=value};_proto.setRow=function setRow(row,value){var i;if(this.rowCount<=row){for(i=this.rowCount;i<=row;i+=1){this.data[i]=[]}this.rowCount=row+1}if(this.columnCount<value.length){this.columnCount=value.length}this.data[row]=value};_proto.get=function get(row,col){var data=this.data;return data[row]&&data[row][col]};_proto.configure=function configure(config){var decodeLiterals=DSV.decodeLiterals;this.delimiter=decodeLiterals(config.delimiter,COMMA);this.qualifier=decodeLiterals(config.qualifier,QUOTE);this.eolCharacter=decodeLiterals(config.eolCharacter,CRLF);this.numberFormatted=!!toInt(config.numberFormatted,0)};_proto.clear=function clear(){this.data=[];this.rowCount=0;this.columnCount=0};_proto.toString=function toString(){var row,col,str=BLANKSTRING;for(row=0;row<this.rowCount;row+=1){col=this.qualifier+this.data[row].join(this.qualifier+this.delimiter+this.qualifier)+this.qualifier;str+=col==='""'?this.eolCharacter:col+this.eolCharacter}if(this.rowCount>0){str=str.slice(0,str.length-2)}return str};return DSV}();DSV.decodeLiterals=function(str,defaultValue){if(str===UNDEF||str===null||!str.toString){return defaultValue}return str.replace(LIT_TAB,TAB).replace(LIT_QUOT,QUOTE).replace(LIT_APOS,APOS)};_recursiveCategoryCall=function recursiveCategoryCall(catObj,csv){var i;multiPieData.push(catObj.label||BLANKSTRING);counter++;headerLen=Math.max(headerLen,counter);if(catObj.category!==UNDEF){for(i=0;i<catObj.category.length;++i){_recursiveCategoryCall(catObj.category[i],csv)}multiPieData.pop();counter--}else{csv.setRow(multiPieLineCount++,multiPieData.slice());multiPieData.pop();counter--}};multilevelPieCsv=function multilevelPieCsv(data){var jsonData=data,chartAttrs=jsonData.chart,category=jsonData&&jsonData.category||[],categoryLen=category.length,i,header=[],catObj,csv;multiPieLineCount=1;headerLen=0;counter=0;csv=new DSV({separator:chartAttrs.exportdataseparator,qualifier:chartAttrs.exportdataqualifier,numberFormatted:chartAttrs.exportdataformattedval});for(i=0;i<categoryLen;++i){catObj=category[i];multiPieData=[];_recursiveCategoryCall(catObj,csv)}for(i=0;i<headerLen;++i){header.push("category")}csv.setRow(0,header);return{data:csv.toString(),error:UNDEF,predictedFormat:{multilevel:true}}};jsonToCsv=function jsonToCsv(data,fusionCharts){var jsondata=data,jsVars=fusionCharts&&fusionCharts.jsVars,args=fusionCharts&&fusionCharts.args,iApi=jsVars&&jsVars.instanceAPI,csv,row,column,g,i,j,k,l,chartAttrs=jsondata.chart||jsondata.map||jsondata.graph||{},forceErrorColumns=Boolean(chartAttrs.exporterrorcolumns||0),categories=jsondata.categories&&jsondata.categories[0]&&jsondata.categories[0].category||[],isGeoPlot=jsondata.map&&!jsondata.chart||jsVars&&jsVars.instanceAPI&&jsVars.instanceAPI.defaultSeriesType==="geo",isXYPlot=false,isErrorPlot=false,isMapPlot=false,isOHLC=false,hasSum=false,doFormat=returnFirstArgument,predictedFormat={},datasets,lineset,axisset,dataCollectionLength,categoryLength,datasetLength,categoryItem,dataCollection,datasetItem,dataLength,dataItem,dataValue,errorValue,bumpColumnCount,summation=0,datasetArr,mapRows,mapColumns,entities,entityId,entity,options,dataset,dIndex=-1,dataStore,value,parentYAxis;if((args&&args.type)==="multilevelpie"){return multilevelPieCsv(data)}csv=new DSV({separator:chartAttrs.exportdataseparator,qualifier:chartAttrs.exportdataqualifier,numberFormatted:chartAttrs.exportdataformattedval});if(FCGlobal.formatNumber&&csv.numberFormatted){doFormat=function doFormat(x,axisIndex){return FCGlobal.formatNumber(x,chartAttrs,axisIndex)}}if(isGeoPlot){predictedFormat.geo=true;datasets=jsVars.instanceAPI.getDatasets();entities=datasets&&datasets[0]&&datasets[0].components.data||[];csv.setRow(0,["Id"," Short Name","Long Name","Value","Formatted Value"]);i=0;for(entityId in entities){entity=entities[entityId];options=entity.config;value=options.cleanValue;if(entity.hidden===true){continue}csv.setRow(++i,[entityId,options.shortLabel,options.label,value===null?"":value,options.formattedValue])}}else if((datasets=jsondata.dials&&jsondata.dials.dial||jsondata.pointers&&jsondata.pointers.pointer||jsondata.value)!==UNDEF){predictedFormat.gauge=true;if(typeof datasets==="string"){csv.set(0,0,doFormat(datasets));predictedFormat.singlevalue=true;if(typeof jsondata.target==="string"){csv.set(0,1,doFormat(jsondata.target));predictedFormat.bullet=true}}else{csv.setRow(0,["Id","Value"]);predictedFormat.multivalue=true;for(i=0,k=1,j=datasets.length;i<j;i+=1,k+=1){csv.setRow(k,[k,doFormat(datasets[i].value)])}}}else if(datasets=jsondata.dataset||!(jsondata.data instanceof Array)&&[]){predictedFormat.multiseries=true;column=1;lineset=jsondata.lineset;if(lineset){datasets=datasets.concat(lineset);predictedFormat.lineset=true}axisset=jsondata.axis;if(axisset){datasets=datasets.concat(axisset);predictedFormat.multiaxis=true}datasetLength=datasets.length;categoryLength=categories.length;if(!(datasetLength=datasets.length)){for(i=0;i<categoryLength;i+=1){categoryItem=categories[i];csv.set(i+1,0,categoryItem.label||categoryItem.name)}predictedFormat.multilevel=true}for(i=0;i<datasetLength;i+=1){dataCollection=datasets;if(dataCollection[i].dataset){dataCollection=dataCollection[i].dataset;g=0;dataCollectionLength=dataCollection.length}else{dataCollection=datasets;g=i;dataCollectionLength=g+1}for(;g<dataCollectionLength&&!isXYPlot&&!isMapPlot;g+=1){datasetItem=dataCollection[g];dIndex++;if(iApi&&(datasetArr=iApi.getDatasets())&&datasetArr[dIndex]&&datasetArr[dIndex].visible===false){continue}dataset=iApi&&datasetArr&&datasetArr[dIndex];parentYAxis=dataset&&dataset.config&&dataset.config.parentYAxis;csv.set(0,column,datasetItem.seriesname);if(typeof datasetItem.data==="string"){predictedFormat.compactdata=true;datasetItem.data=datasetItem.data.split(chartAttrs.dataseparator||"|")}for(j=0,k=0,dataLength=datasetItem.data&&datasetItem.data.length||0;j<dataLength||j<categoryLength;j+=1){categoryItem=categories[j];row=k+1;dataItem=datasetItem.data&&datasetItem.data[k]||{};if(dataItem.x!==UNDEF&&dataItem.y!==UNDEF){isXYPlot=predictedFormat.xy=true;break}if(dataItem.open!==UNDEF||dataItem.high!==UNDEF||dataItem.close!==UNDEF||dataItem.low!==UNDEF){isOHLC=predictedFormat.ohlc=true;break}if(dataItem.rowid!==UNDEF&&dataItem.columnid!==UNDEF){isMapPlot=predictedFormat.heatmap=true;break}if(j<categoryLength&&!categoryItem.vline){csv.set(row,0,categoryItem.label||categoryItem.name);dataValue=toFloat(dataItem?dataItem.value:"");dataValue=isNaN(dataValue)?"":doFormat(dataValue,parentYAxis);csv.set(row,column,dataValue);if(isErrorPlot||forceErrorColumns||dataItem.errorvalue){if(!isErrorPlot){csv.set(0,column+1,"Error")}bumpColumnCount=1;csv.set(row,column+1,doFormat(dataItem.errorvalue))}k+=1}}if(bumpColumnCount){column+=bumpColumnCount;bumpColumnCount=0}column+=1}}if(lineset){datasets=datasets.slice(0,-lineset.length)}if(axisset){datasets=datasets.slice(0,-axisset.length)}}else if(datasets=jsondata.data){csv.set(0,1,chartAttrs.yaxisname||"Value");predictedFormat.singleseries=true;hasSum=chartAttrs.showsumatend=="1";for(i=0,categoryLength=datasets.length;i<categoryLength;i+=1){dataItem=datasets[i];if(!dataItem.vline){dataValue=toFloat(dataItem.value?dataItem.value:"");csv.setRow(i+1,[dataItem.label||dataItem.name,isNaN(dataValue)?"":(summation+=dataValue,doFormat(dataValue))])}}if(hasSum){predictedFormat.summation=true;csv.setRow(i+1,[chartAttrs.sumlabel||"Total",doFormat(summation)])}}if(isOHLC){csv.clear();csv.setRow(0,["Open","Close","High","Low"]);for(i=0,row=1,datasets=jsondata.dataset,dataCollectionLength=datasets.length;i<dataCollectionLength;i+=1){for(j=0,datasetItem=datasets[i]&&datasets[i].data||[],datasetLength=datasetItem.length;j<datasetLength;j+=1,row+=1){dataItem=datasetItem[j]||{};csv.setRow(j+1,[doFormat(dataItem.open),doFormat(dataItem.close),doFormat(dataItem.high),doFormat(dataItem.low)])}}}else if(isXYPlot){csv.clear();isErrorPlot=false;bumpColumnCount=0;csv.setRow(0,["Series","x","y"]);for(i=0,row=1,datasets=jsondata.dataset,dataCollectionLength=datasets.length;i<dataCollectionLength;i+=1){if(iApi&&(datasetArr=iApi.getDatasets())&&datasetArr[i]&&datasetArr[i].visible===false){continue}for(j=0,datasetItem=datasets[i]&&datasets[i].data||[],datasetLength=datasetItem.length;j<datasetLength;j+=1,row+=1){dataItem=datasetItem[j]||{};dataValue=[datasets[i].seriesname,doFormat(dataItem.x),doFormat(dataItem.y)];if(dataItem.z!==UNDEF){dataValue.push(doFormat(dataItem.z));if(!bumpColumnCount){csv.set(0,3,"z");bumpColumnCount=1}}if(isErrorPlot||forceErrorColumns||dataItem.errorvalue!==UNDEF||dataItem.horizontalerrorvalue!==UNDEF||dataItem.verticalerrorvalue!==UNDEF){errorValue=doFormat(dataItem.errorvalue);dataValue.push(dataItem.errorvalue,dataItem.horizontalerrorvalue===UNDEF?errorValue:doFormat(dataItem.horizontalerrorvalue),dataItem.verticalerrorvalue===UNDEF?errorValue:doFormat(dataItem.verticalerrorvalue));if(!isErrorPlot){csv.set(0,bumpColumnCount+3,"Error");csv.set(0,bumpColumnCount+4,"Horizontal Error");csv.set(0,bumpColumnCount+5,"Vertical Error")}isErrorPlot=predictedFormat.error=true}csv.setRow(row,dataValue)}}}else if(isMapPlot){csv.clear();mapRows={};mapColumns={};for(i=0,j=1,categories=jsondata.rows&&jsondata.rows.row||[],l=categories.length;i<l;i+=1,j+=1){categoryItem=categories[i];if(categoryItem.id){mapRows[categoryItem.id.toLowerCase()]=j;csv.set(j,0,categoryItem.label||categoryItem.id)}}for(i=0,j=1,categories=jsondata.columns&&jsondata.columns.column||[],l=categories.length;i<l;i+=1,j+=1){categoryItem=categories[i];if(categoryItem.id){mapColumns[categoryItem.id.toLowerCase()]=j;csv.set(0,j,categoryItem.label||categoryItem.id)}}datasetItem=jsondata.dataset&&jsondata.dataset[0]&&jsondata.dataset[0].data||[];dataStore=iApi&&(datasetArr=iApi.getDatasets())&&datasetArr[0]&&datasetArr[0].components&&datasetArr[0].components.data||[];for(i=0,l=datasetItem.length;i<l;i+=1){dataItem=datasetItem[i];row=dataItem.rowid.toLowerCase();column=dataItem.columnid.toLowerCase();if(dataStore[i]&&dataStore[i].visible===false){continue}if(!mapRows[row]){mapRows[row]=csv.rowCount;csv.set(csv.rowCount,0,dataItem.rowid)}if(!mapColumns[column]){mapColumns[column]=csv.columnCount;csv.set(0,csv.columnCount,dataItem.columnid)}csv.set(mapRows[row],mapColumns[column],doFormat(dataItem.value))}}axisset=null;lineset=null;categories=null;datasets=null;if(csv.rowCount>0&&csv.get(0,0)===UNDEF){csv.set(0,0,chartAttrs.xaxisname||"Label")}return{data:csv.toString(),error:UNDEF,predictedFormat:predictedFormat}};csvToJson=function csvToJson(data,fusionCharts){raiseError(fusionCharts,"0604111215","run","csvToJson()","fusionCharts CSV data-handler only supports encoding of data.");return data};function getCSVData(){return this.getChartData("csv")}function getDataAsCSV(){return this.getCSVData()}function wrapper(FusionCharts){if(FusionCharts){FCGlobal=FusionCharts;FusionCharts.prototype.getDataAsCSV=getDataAsCSV;FusionCharts.prototype.getCSVData=getCSVData}return{format:"csv",toJSON:csvToJson,fromJSON:jsonToCsv}}export default{extension:wrapper,name:"csv",type:"transcoder",requiresFusionCharts:true};