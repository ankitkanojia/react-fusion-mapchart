import LinkInformation,{store}from"./link-information";import{raiseError,raiseWarning,triggerEvent}from"@fusioncharts/core/src/event-api";import{extend2,domInsertModes,POINTER,HASHSTRING,PXSTRING,NORMAL,regex,BOLD}from"@fusioncharts/core/src/lib";import domEvtHandler from"@fusioncharts/core/src/dom-event";var DROP_HASH_RE=regex.dropHash,MSG_CLOSE="Close";var UNDEF;function checkObjectRenderLocationOverride(obj,parent){return(obj.options.containerElement===parent.options.containerElement||obj.options.containerElementId===parent.options.containerElementId)&&obj.options.insertMode===domInsertModes.REPLACE}function linkInitialize(event){var arr;if(!(event.sender.link instanceof LinkInformation)||event.sender.link.root.disposed){event.sender.link=new LinkInformation(event.sender)}else{if(event.sender.link.parent instanceof this){arr=event.sender.link.parent.link.items;!arr[event.sender.id]&&(arr[event.sender.id]=event.sender)}}}function configureLinkFn(param,levelLink){var i,level=levelLink;if(param instanceof Array){for(i=0;i<param.length;i+=1){if(typeof store[this.link.root.id][i]!=="object"){store[this.link.root.id][i]={}}extend2(store[this.link.root.id][i],param[i],false,true)}store[this.link.root.id].splice(param.length)}else if(typeof param==="object"){if(typeof level!=="number"){level=this.link.level}if(typeof store[this.link.root.id][level]==="undefined"){store[this.link.root.id][level]={}}extend2(store[this.link.root.id][level],param,false,true)}else{raiseError(this,"25081731","param","~configureLink()","Unable to update link configuration from set parameters")}}function drawOverlayButtonFn(args){var vars=this.jsVars,backBtn=vars.overlayButton,cssObj,item,text;if(args&&args.show){if(!backBtn){backBtn=vars.overlayButton=document.createElement("span");domEvtHandler.listen(backBtn,"click",function(){triggerEvent("OverlayButtonClick",vars.fcObj,args)})}text=args.message?args.message:"Back";while(backBtn.firstChild){backBtn.removeChild(backBtn.firstChild)}backBtn.appendChild(document.createTextNode(text));vars.overlayButtonMessage=text;cssObj={border:"1px solid "+(args.borderColor?args.borderColor.replace(DROP_HASH_RE,HASHSTRING):"#7f8975"),backgroundColor:args.bgColor?args.bgColor.replace(DROP_HASH_RE,HASHSTRING):"#edefec",fontFamily:args.font?args.font:"Verdana,sans",color:"#"+args.fontColor?args.fontColor:"49563a",fontSize:(args.fontSize?args.fontSize:"10")+PXSTRING,padding:(args.padding?args.padding:"3")+PXSTRING,fontWeight:parseInt(args.bold,10)===0?NORMAL:BOLD,position:"absolute",top:"0",right:"0",cursor:POINTER};for(item in cssObj){backBtn.style[item]=cssObj[item]}vars.hcObj.container.appendChild(backBtn);vars.overlayButtonActive=true}else if(backBtn){vars.overlayButton=backBtn.parentNode.removeChild(backBtn);vars.overlayButtonActive=false;delete vars.overlayButtonMessage}}function addlinkedCharts(FusionCharts){FusionCharts.prototype.configureLink=configureLinkFn;FusionCharts.prototype.drawOverlayButton=drawOverlayButtonFn;FusionCharts.addEventListener("beforeRender",linkInitialize);FusionCharts.addEventListener("beforeInitialize",linkInitialize);FusionCharts.addEventListener("linkedChartInvoked",function linkedChartInvokedHanlder(event,args){var obj=event.sender,param=obj.clone({dataSource:args.data,dataFormat:args.linkType,link:new LinkInformation(obj.link.root,obj,obj instanceof FusionCharts),clickedEntity:args.clickedEntity,clickedEntityBox:args.clickedEntityBox},true),alias=args.alias,childObj;if(alias){if(!param.typeSource&&param.swfUrl){param.typeSource=param.swfUrl.replace(/(.*?)?[^\/]*\.swf.*?/gi,"$1")}param.type=alias}if(obj.args&&parseInt(obj.args.animate,10)!==0){delete param.animate}extend2(param,obj.link.configuration(),false,true);triggerEvent("beforeLinkedItemOpen",obj.link.root,{level:obj.link.level},UNDEF,function(){if(FusionCharts.items[param.id]instanceof FusionCharts){FusionCharts.items[param.id].dispose()}childObj=new FusionCharts(param);if(!checkObjectRenderLocationOverride(childObj,obj)&&!(obj.options.overlayButton&&obj.options.overlayButton.message)){if(typeof obj.options.overlayButton!=="object"){obj.options.overlayButton={}}obj.options.overlayButton.message=MSG_CLOSE}childObj.render();triggerEvent("linkedItemOpened",obj.link.root,{level:obj.link.level,item:childObj})})});FusionCharts.addEventListener("overlayButtonClick",function overlayButtonClickHandler(event,args){var sender,level,parent,root;if(args.id!=="LinkManager"){return}sender=event.sender;level=sender.link.level-1;parent=sender.link.parent;root=sender.link.root;triggerEvent("beforeLinkedItemClose",root,{level:level,item:sender},UNDEF,function(){setTimeout(function(){if(FusionCharts.items[sender.id]){sender.dispose()}triggerEvent("linkedItemClosed",root,{level:level})},0);if(!parent.disposed&&!parent.isActive()&&checkObjectRenderLocationOverride(sender,parent)){parent.render()}else{parent._addChartDependency("returnFromLinkedChart",{resolve:function resolve(){return{state:3}}});parent._setState()}})});FusionCharts.addEventListener("DrawComplete",function drawCompleteHandler(event){var obj=event.sender,config;if(!obj||typeof obj.link==="undefined"){return}if(obj.link.root===obj||!(obj.link.parent instanceof FusionCharts)){return}if(!(obj.ref&&typeof obj.drawOverlayButton==="function")){raiseWarning(obj,"04091602","run","::LinkManager^Loaded","Unable to draw overlay button on object. -"+obj.id);return}config=extend2({show:true,id:"LinkManager"},obj.link.parent.options.overlayButton,false,true);extend2(config,obj.link.parent.link.configuration().overlayButton||{},false,true);obj.drawOverlayButton(config)});FusionCharts.addEventListener("beforeDispose",function beforeDisposeHandler(e){var obj=e.sender;if(!(obj&&obj.link instanceof LinkInformation)){return}if(obj&&obj.link&&obj.link.parent instanceof FusionCharts){if(obj.link.parent.link&&obj.link.parent.link.items){delete obj.link.parent.link.items[e.sender.id]}}delete store[obj.id]})}export default{type:"extension",name:"LinkedChart",extension:addlinkedCharts,requiresFusionCharts:true};