import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import{pluckNumber,pluck,parseTooltext,parseUnsafeString,getDashStyle,getDefinedColor,getValidValue,toRaphaelColor,getCrispValue,getFirstValue,convertColor,getLightColor,getColumnColor}from"@fusioncharts/core/src/lib";import ColumnDataset from"@fusioncharts/charts/src/dataset/column";import{addDep}from"@fusioncharts/core/src/dependency-manager";import waterFall2DAnimation from"./index.animation";var HUNDREDSTRING="100",PLOTBORDERCOLOR="plotBorderColor",PLOTGRADIENTCOLOR="plotGradientColor",COMMA=",",BLANK="",SHOWSHADOW="showShadow",NONE="none",MAX_MITER_LINEJOIN=2,M="M",H="H",UNDEF;addDep({name:"waterFall2DAnimation",type:"animationRule",extension:waterFall2DAnimation});var WaterFall2DDataset=function(_ColumnDataset){_inheritsLoose(WaterFall2DDataset,_ColumnDataset);function WaterFall2DDataset(){return _ColumnDataset.apply(this,arguments)||this}var _proto=WaterFall2DDataset.prototype;_proto.getType=function getType(){return"dataset"};_proto.getName=function getName(){return"waterFall2D"};_proto.configure=function configure(datasetJSON){if(!datasetJSON){return false}this.trimData(datasetJSON);this.config.JSONData=datasetJSON;var catData,catObj,dataSet=this,chart=dataSet.getFromEnv("chart"),conf=dataSet.config,JSONData=dataSet.config.JSONData,setDataArr=JSONData.data,setDataLen=setDataArr&&setDataArr.length,catLen=dataSet.getFromEnv("xAxis").getTicksLen(),len=Math.min(catLen,setDataLen),chartAttr=chart.getFromEnv("dataSource").chart,colorM=dataSet.getFromEnv("color-manager"),showplotborder,plotColor=colorM.getPlotColor(dataSet.index||dataSet.positionIndex),plotBorderDash=pluckNumber(JSONData.dashed,chartAttr.plotborderdashed),usePlotGradientColor=pluckNumber(chartAttr.useplotgradientcolor,1),showTooltip=pluckNumber(chartAttr.showtooltip,1),tooltipSepChar=parseUnsafeString(pluck(chartAttr.tooltipsepchar,", ")),formatedVal,parserConfig,setTooltext,macroIndices,toolText,plotDashLen,plotDashGap,plotBorderThickness,isRoundEdges,showHoverEffect,plotfillAngle,plotFillAlpha,plotFillRatio,plotgradientcolor,plotBorderAlpha,plotBorderColor,plotBorderDashStyle,initailPlotBorderDashStyle,setData,setValue,dataObj,config,colorArr,hoverColor,hoverAlpha,hoverGradientColor,hoverRatio,hoverAngle,hoverBorderColor,hoverBorderAlpha,hoverBorderThickness,hoverBorderDashed,hoverBorderDashGap,hoverBorderDashLen,hoverDashStyle,hoverColorArr,dataStore=dataSet.components.data,numberFormatter=dataSet.getFromEnv("number-formatter"),toolTipValue,setDisplayValue,isBar=false,is3D=false,isStacked=false,stack100Percent,enableAnimation,parentYAxis,setDataDashed,setDataPlotDashLen,setDataPlotDashGap,i,reflowData={},reflowDataObj=reflowData.dataObj||(reflowData.dataObj={}),reflowChartObj=reflowDataObj.chart||(reflowDataObj.chart={}),lineThickness=pluck(chartAttr.connectorthickness,1),showSum,dataLabel,showLabel,itemValue,maxValue=-Infinity,minValue=Infinity,seriesSum=0,total=0,lastComTotal=0,issum,zLine,setColor,cumulative,sumObj,countPoint,plotfillangle;dataSet.setState("visible",pluckNumber(JSONData.visible,!Number(JSONData.initiallyhidden),1)===1);showplotborder=conf.showplotborder=pluckNumber(chartAttr.showplotborder,is3D?0:1);conf.plotBorderThickness=plotBorderThickness=showplotborder?is3D?1:pluckNumber(chartAttr.plotborderthickness,1):0;conf.isRoundEdges=isRoundEdges=pluckNumber(chartAttr.useroundedges,0);conf.plotBorderAlpha=plotBorderAlpha=showplotborder?pluck(chartAttr.plotborderalpha,plotFillAlpha,HUNDREDSTRING):0;conf.plotBorderColor=plotBorderColor=pluck(chartAttr.plotbordercolor,is3D?"#ffffff":colorM.getColor(PLOTBORDERCOLOR).split(COMMA)[0]);conf.plotgradientcolor=plotgradientcolor=usePlotGradientColor?getDefinedColor(chartAttr.plotgradientcolor,colorM.getColor(PLOTGRADIENTCOLOR)):BLANK;conf.plotDashLen=plotDashLen=pluckNumber(chartAttr.plotborderdashlen,6);conf.showTextOutline=pluckNumber(chartAttr.textoutline,0);conf.plotDashGap=plotDashGap=pluckNumber(chartAttr.plotborderdashgap,3);conf.use3DLighting=pluckNumber(chartAttr.use3dlighting,1);conf.showSum=showSum=pluckNumber(chartAttr.showsumatend,1);conf.plotColor=plotColor=pluck(JSONData.color,plotColor);conf.plotfillAngle=plotfillAngle=pluckNumber(360-chartAttr.plotfillangle,90);conf.showShadow=isRoundEdges||is3D?pluckNumber(chartAttr.showshadow,1):pluckNumber(chartAttr.showshadow,colorM.getColor(SHOWSHADOW));conf.showHoverEffect=showHoverEffect=pluckNumber(chartAttr.plothovereffect,chartAttr.showhovereffect,UNDEF);conf.plotFillAlpha=plotFillAlpha=pluck(JSONData.alpha,chartAttr.plotfillalpha,HUNDREDSTRING);conf.plotRadius=pluckNumber(chartAttr.useRoundEdges,conf.isRoundEdges?1:0);conf.plotFillRatio=plotFillRatio=pluck(JSONData.ratio,chartAttr.plotfillratio);conf.plotBorderDashStyle=initailPlotBorderDashStyle=plotBorderDash?getDashStyle(plotDashLen,plotDashGap):"none";conf.showValues=pluckNumber(JSONData.showvalues,chartAttr.showvalues,1);conf.valuePadding=pluckNumber(chartAttr.valuepadding,2);conf.enableAnimation=enableAnimation=pluckNumber(chartAttr.animation,chartAttr.defaultanimation,1);conf.animation=!enableAnimation?false:{duration:pluckNumber(chartAttr.animationduration,1)*1e3};reflowChartObj.transposeAnimation=conf.transposeAnimation=pluckNumber(chartAttr.transposeanimation,reflowChartObj.transposeAnimation,enableAnimation);conf.transposeAnimDuration=pluckNumber(chartAttr.transposeanimduration,.2)*1e3;conf.showTooltip=pluckNumber(chartAttr.showtooltip,1);conf.stack100Percent=stack100Percent=pluckNumber(chart.stack100percent,chartAttr.stack100percent,0);conf.definedGroupPadding=Math.max(pluckNumber(chartAttr.plotspacepercent),0);conf.plotSpacePercent=Math.max(pluckNumber(chartAttr.plotspacepercent,20)%100,0);conf.maxColWidth=pluckNumber(isBar?chartAttr.maxbarheight:chartAttr.maxcolwidth,50);conf.showPercentValues=pluckNumber(chartAttr.showpercentvalues,isStacked&&stack100Percent?1:0);conf.showPercentInToolTip=pluckNumber(chartAttr.showpercentintooltip,isStacked&&stack100Percent?1:0);conf.plotPaddingPercent=pluckNumber(chartAttr.plotpaddingpercent);conf.rotateValues=pluckNumber(chartAttr.rotatevalues)?270:0;conf.placeValuesInside=pluckNumber(chartAttr.placevaluesinside,0);conf.parentYAxis=parentYAxis=pluck(JSONData.parentyaxis&&JSONData.parentyaxis.toLowerCase(),"p")==="s"?1:0;conf.defaultPadding={left:.5,right:.5};dataSet.setState("dirty",true);if(!dataStore){dataStore=dataSet.components.data=[]}conf.zLine=zLine={step:true,data:[],dashStyle:chartAttr.connectordashed==="1"?getDashStyle(pluckNumber(chartAttr.connectordashlen,2),pluckNumber(chartAttr.connectordashgap,2)):NONE,useForwardSteps:true,color:convertColor(pluck(chartAttr.connectorcolor,"000000"),pluck(chartAttr.connectoralpha,100)),lineWidth:lineThickness};for(i=0;i<len;i+=1){setData=setDataArr[i];itemValue=numberFormatter.getCleanValue(setData.value);issum=pluckNumber(setData.issum,0);if(setData.vline||issum){delete setData._value;continue}seriesSum+=itemValue;setData._value=itemValue}if(showSum){showSum=true;len+=1;sumObj={label:getFirstValue(chartAttr.sumlabel,"Total"),_value:seriesSum,value:seriesSum,issum:1,cumulative:1}}for(i=0,countPoint=0;i<len;i+=1){setData=setDataArr[i];dataObj=dataStore[i];config=dataObj&&dataObj.config;if(!dataObj){dataObj=dataStore[i]={graphics:{}}}if(!dataObj.config){config=dataStore[i].config={}}if(!setData&&showSum){setData=setDataArr[i]=sumObj}plotColor=pluck(setData.color,colorM.getPlotColor(i));if(dataObj.vline){continue}itemValue=setData._value;delete setData._value;config.issum=issum=pluckNumber(setData.issum,0);cumulative=config.isCumulative=pluckNumber(setData.cumulative,1);if(issum){itemValue=cumulative?total:total===lastComTotal?total:total-lastComTotal;config.lastComTotal=lastComTotal;lastComTotal=total;zLine.data.push({y:null,x:countPoint-.5})}else{total+=itemValue}maxValue=Math.max(maxValue,total);minValue=Math.min(minValue,total);config.total=total;showLabel=config.showLabel=pluckNumber(setData.showlabel,chartAttr.showlabels,1);dataLabel=config.dataLabel=parseUnsafeString(!showLabel?BLANK:getFirstValue(setData.label,setData.name));if(itemValue>0){setColor=pluck(setData.color,chartAttr.positivecolor,plotColor);if(showHoverEffect!==0){hoverColor=pluck(setData.positivehovercolor,chartAttr.positivehovercolor,chartAttr.plotfillhovercolor,chartAttr.columnhovercolor,setColor)}}else{setColor=pluck(setData.color,chartAttr.negativecolor,plotColor);if(showHoverEffect!==0){hoverColor=pluck(setData.negativehovercolor,chartAttr.negativehovercolor,chartAttr.plotfillhovercolor,chartAttr.columnhovercolor,setColor)}}if(itemValue<0){plotfillangle=360-plotfillAngle}else{plotfillangle=plotfillAngle}plotFillAlpha=pluck(setData.alpha,conf.plotFillAlpha);setDataDashed=pluckNumber(setData.dashed,plotBorderDash);setDataPlotDashLen=pluckNumber(setData.dashlen,plotDashLen);setDataPlotDashGap=plotDashGap=pluckNumber(setData.dashgap,plotDashGap);config.showValue=pluckNumber(setData.showvalue,conf.showValues);config.setValue=setValue=itemValue;config.setLink=pluck(setData.link);config.toolTipValue=toolTipValue=numberFormatter.dataLabels(setValue,parentYAxis);config.setDisplayValue=setDisplayValue=getValidValue(parseUnsafeString(setData.displayvalue));config.displayValue=pluck(setDisplayValue,toolTipValue);config.plotBorderDashStyle=plotBorderDashStyle=setDataDashed===1?getDashStyle(setDataPlotDashLen,setDataPlotDashGap):setDataDashed===0?"none":initailPlotBorderDashStyle;config.shadow={opacity:conf.showShadow?plotFillAlpha/100:0};config.colorArr=colorArr=getColumnColor(setColor+COMMA+plotgradientcolor.replace(/,+?$/,""),plotFillAlpha,plotFillRatio,plotfillangle,isRoundEdges,plotBorderColor,plotBorderAlpha.toString(),isBar?1:0,!!is3D);if(showHoverEffect!==0){hoverAlpha=pluck(setData.alpha,setData.hoveralpha,JSONData.hoveralpha,chartAttr.plotfillhoveralpha,chartAttr.columnhoveralpha,plotFillAlpha);hoverGradientColor=pluck(setData.hovergradientcolor,JSONData.hovergradientcolor,chartAttr.plothovergradientcolor,plotgradientcolor);!hoverGradientColor&&(hoverGradientColor="");hoverRatio=pluck(setData.hoverratio,JSONData.hoverratio,setData.ratio,chartAttr.plothoverratio,plotFillRatio);hoverAngle=pluckNumber(360-setData.hoverangle,360-JSONData.hoverangle,360-chartAttr.plothoverangle,plotfillangle);hoverBorderColor=pluck(setData.borderhovercolor,JSONData.borderhovercolor,chartAttr.plotborderhovercolor,plotBorderColor);hoverBorderAlpha=pluck(setData.borderhoveralpha,JSONData.borderhoveralpha,chartAttr.plotborderhoveralpha,plotBorderAlpha,plotFillAlpha);hoverBorderThickness=pluckNumber(setData.borderhoverthickness,JSONData.borderhoverthickness,chartAttr.plotborderhoverthickness,plotBorderThickness);hoverBorderDashed=pluckNumber(setData.borderhoverdashed,JSONData.borderhoverdashed,chartAttr.plotborderhoverdashed);hoverBorderDashGap=pluckNumber(setData.borderhoverdashgap,JSONData.borderhoverdashgap,chartAttr.plotborderhoverdashgap,plotDashLen);hoverBorderDashLen=pluckNumber(setData.borderhoverdashlen,JSONData.borderhoverdashlen,chartAttr.plotborderhoverdashlen,plotDashGap);hoverDashStyle=hoverBorderDashed?getDashStyle(hoverBorderDashLen,hoverBorderDashGap):plotBorderDashStyle;if(showHoverEffect===1&&hoverColor===plotColor){hoverColor=getLightColor(hoverColor,70)}hoverColorArr=getColumnColor(hoverColor+","+hoverGradientColor,hoverAlpha,hoverRatio,hoverAngle,isRoundEdges,hoverBorderColor,hoverBorderAlpha.toString(),isBar?1:0,!!is3D);config.setRolloutAttr={fill:!is3D?toRaphaelColor(colorArr[0]):[toRaphaelColor(colorArr[0]),!conf.use3DLighting],stroke:showplotborder&&toRaphaelColor(colorArr[1]),"stroke-width":plotBorderThickness,"stroke-dasharray":plotBorderDashStyle};config.setRolloverAttr={fill:!is3D?toRaphaelColor(hoverColorArr[0]):[toRaphaelColor(hoverColorArr[0]),!conf.use3DLighting],stroke:showplotborder&&toRaphaelColor(hoverColorArr[1]),"stroke-width":hoverBorderThickness,"stroke-dasharray":hoverDashStyle}}formatedVal=config.toolTipValue;config.origToolText=setTooltext=getValidValue(parseUnsafeString(pluck(setData.tooltext,JSONData.plottooltext,chartAttr.plottooltext)));if(!showTooltip){toolText=false}else if(setTooltext!==UNDEF){macroIndices=[1,2,3,5,6,7,20,21,24,25];parserConfig={formattedValue:formatedVal,label:dataLabel,yaxisName:parseUnsafeString(chartAttr.yaxisname),xaxisName:parseUnsafeString(chartAttr.xaxisname),cumulativeValue:total,cumulativeDataValue:numberFormatter.dataLabels(total),sum:numberFormatter.dataLabels(seriesSum),unformattedSum:seriesSum};toolText=parseTooltext(setTooltext,macroIndices,parserConfig,setData,chartAttr,JSONData)}else{toolText=formatedVal===null?false:dataLabel!==BLANK?dataLabel+tooltipSepChar:""}zLine.data.push({y:itemValue===null?null:total,x:countPoint});countPoint+=1;config.originalPlotColor=plotColor;config.toolText=toolText;config.setTooltext=toolText;config._x=i;config._y=setValue}conf.maxValue=maxValue;conf.minValue=minValue;conf.connectNullData=pluckNumber(chartAttr.connectnulldata,0);conf.showConnectors=pluckNumber(chartAttr.showconnectors,1);catData=JSONData.catData;for(i=0;i<catData.length;i+=1){catObj=catData[i];setDataArr.splice(catObj.index,0,catObj.data)}dataSet.getFromEnv("xAxis").setTickValues(setDataArr);dataSet.config.maxminFlag=false};_proto.createCoordinates=function createCoordinates(){var dataSet=this,isBar=dataSet.getFromEnv("chart").isBar,yAxis=dataSet.getFromEnv("yAxis"),xAxis=dataSet.getFromEnv("xAxis"),yBase=yAxis.getAxisBase(),yBasePos=yAxis.getPixel(yBase),dataObj,config,previousY,i,Px,Py,Pb,yVal,chartConfig=dataSet.getFromEnv("chartConfig"),xDepth=chartConfig.xDepth||0,yDepth=chartConfig.yDepth||0,len=dataSet.components.data.length,groupManager=dataSet.groupManager,stackConf=groupManager&&groupManager.stackConf,dataStore=dataSet.components.data;!isBar&&(xDepth=-xDepth);isBar&&(yDepth=-yDepth);for(i=0;i<len;i++){dataObj=dataStore[i];config=dataObj&&dataObj.config;if(dataObj===UNDEF){continue}yVal=config._y;if(!config.issum){previousY=dataStore[i-1]&&dataStore[i-1].config.total;previousY&&(yVal+=previousY)}else if(!config.isCumulative){previousY=config.lastComTotal;yVal+=config.lastComTotal}else{previousY=null}Px=xAxis.getPixel(stackConf&&stackConf[i].x||config._x)+xDepth;Py=yAxis.getPixel(yVal)+yDepth;Pb=(previousY?yAxis.getPixel(previousY):yBasePos)+yDepth;if(xAxis.config.isVertical){config._Px=Py;config._Py=Px;config._Pby=Px;config._Pbx=Pb}else{config._Px=Px;config._Py=Py;config._Pby=Pb;config._Pbx=Px}}};_proto.getDataLimits=function getDataLimits(){var dataSet=this,dataStore=dataSet.components.data,conf=dataSet.config,i,config,len=dataStore.length,setValue,maxValue=-Infinity,minValue=+Infinity;for(i=0;i<len;i++){if(!dataStore[i]){continue}config=dataStore[i].config;setValue=config.total;if(setValue!==UNDEF){maxValue=Math.max(maxValue,setValue);minValue=Math.min(minValue,setValue)}}conf.maxValue=maxValue;conf.minValue=minValue;return{max:conf.maxValue,min:conf.minValue}};_proto.drawPlots=function drawPlots(anim){var dataSet=this;_ColumnDataset.prototype.drawPlots.call(this,anim);if(dataSet.config.showConnectors){dataSet.drawLine()}else{dataSet.getContainer("commonElemsGroup").hide()}};_proto.drawLine=function drawLine(){var dataSet=this,conf=dataSet.config,i,yPos,xPos,yAxis=dataSet.getFromEnv("yAxis"),yBase=yAxis.getAxisBase(),yBasePos=yAxis.getPixel(yBase),lineContainer=dataSet.getContainer("commonElemsGroup"),groupNetHalfWidth=dataSet.getFromEnv("columnWidth")/2,zLineConf=conf.zLine,data=zLineConf.data,set,y,x,ln=data.length,seriesLineWidth=zLineConf.lineWidth,lastXPos,zLineDummy=dataSet._graphics.zLine,zLine,lastYPos=null,linePath=[],lastMoveCommand=[];yAxis.yBasePos=yBasePos;lineContainer.toFront().show();for(i=0;i<ln;i+=1){set=data[i];y=set.y;if(y===null){lastMoveCommand.length=0;if(conf.connectNullData===0){lastYPos=null}}else{x=pluckNumber(set.x,i);yPos=yAxis.getPixel(y);xPos=dataSet.getFromEnv("xAxis").getPixel(x);xPos=getCrispValue(xPos,seriesLineWidth,seriesLineWidth).position;yPos=getCrispValue(yPos,seriesLineWidth,seriesLineWidth).position;if(lastYPos!==null){if(lastMoveCommand.length){linePath=linePath.concat(lastMoveCommand);lastMoveCommand.length=0}linePath.push(M,lastXPos,lastYPos,"m",-groupNetHalfWidth,0,H,xPos,"h",groupNetHalfWidth,"m",0,yPos-lastYPos)}else{lastMoveCommand.push(M,xPos,yPos)}lastXPos=xPos;lastYPos=yPos}}zLine=dataSet.getFromEnv("animationManager").setAnimation({el:zLineDummy||"path",attr:{path:linePath,"stroke-linecap":"round","stroke-opacity":1,"stroke-dasharray":zLineConf.dashStyle,stroke:zLineConf.color,"stroke-linejoin":seriesLineWidth>=MAX_MITER_LINEJOIN?"round":"miter","stroke-width":seriesLineWidth},container:lineContainer,component:dataSet,label:"path"});if(!zLineDummy){dataSet.addGraphicalElement("zLine",zLine)}};return WaterFall2DDataset}(ColumnDataset);export default WaterFall2DDataset;