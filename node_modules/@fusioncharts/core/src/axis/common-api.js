import difference from"ramda/src/difference";import extent from"@fusioncharts/utils/src/array/extent";import{UNDEF,pluckNumber,POSITION_START,parseUnsafeString,POSITION_BOTTOM,POSITION_TOP,POSITION_END,extend2,toPrecision,BLANKSTRING,parseTooltext,getSuggestiveRotation,pluck}from"../lib";var queryOptions={wrtVisible:true},LABEL_ID="_label",NORMALSTRING="normal",MIDDLE_STR="middle",EVENTARGS="eventArgs",POINTER="pointer",NOSTRING="none",extractStyleInfo=function extractStyleInfo(cat,chart){var sAttrMap={labelfont:["fontFamily"],labelfontcolor:["fontColor"],labelfontsize:["fontSize",function(val){return val?pluckNumber(val)+"px":UNDEF}],labelfontbold:["fontWeight",function(val){return val?"bold":NORMALSTRING}],labelfontitalic:["fontStyle",function(val){return val?"italic":NORMALSTRING}],labelfontalpha:["fontAlpha"]},cats=chart.getFromEnv("dataSource").categories,catData=cats&&cats[0]||{},defFn=function defFn(val){return val},styleExists=false,attrKey,attrVal,secAttrVal,style={},attrRule,mappedAttr,mapFn,mappedVal;for(attrKey in catData){if(attrKey==="category"||attrKey in cat){continue}attrVal=catData[attrKey];cat[attrKey]=attrVal}for(attrKey in sAttrMap){attrRule=sAttrMap[attrKey];mappedAttr=attrRule[0];mapFn=attrRule[1]||defFn;attrVal=cat[attrKey];secAttrVal=cat[mappedAttr.toLowerCase()];if(attrVal!==UNDEF||secAttrVal!==UNDEF){if((mappedVal=mapFn(attrVal))!==UNDEF||(mappedVal=mapFn(secAttrVal))!==UNDEF){style[mappedAttr]=mappedVal;styleExists=true}}if(styleExists){cat.style=style}}},setAxisDimention=function setAxisDimention(data){var axis=this,scale=axis.getScale(),axisConfig=axis.config,chart=axis.getFromEnv("chart"),chartConfig=chart.config,axisDimention=axisConfig.axisDimention||(axisConfig.axisDimention={}),isReverse=axisConfig.isReverse;axisDimention.opposite=pluckNumber(data.opposite,axisDimention.opposite);axisDimention.x=pluckNumber(data.x,axisDimention.x,chartConfig.canvasLeft);axisDimention.y=pluckNumber(data.y,axisDimention.y,chartConfig.canvasTop);axisDimention.axisLength=pluckNumber(data.axisLength,axisDimention.axisLength);if(axisConfig.isVertical){isReverse?scale.setRange([axisDimention.y+axisDimention.axisLength,axisDimention.y]):scale.setRange([axisDimention.y,axisDimention.y+axisDimention.axisLength])}else{isReverse?scale.setRange([axisDimention.x+axisDimention.axisLength,axisDimention.x]):scale.setRange([axisDimention.x,axisDimention.x+axisDimention.axisLength])}axisConfig.translation=axis._computeTranslation()},setDataLimit=function setDataLimit(_max,_min){var axis=this,max=_max,min=_min,axisConfig=axis.config,categories=axis.getFromEnv("dataSource").categories,categoryArr=categories&&categories[0]&&categories[0].category,startPad=axisConfig.startPad||0,endPad=axisConfig.endPad||0,catMin,catMax,trendMin,trendMax,xAxisLabelMode=axisConfig.xAxisLabelMode,numberAccessor=function numberAccessor(a){return Number(a)};if(xAxisLabelMode==="categories"||xAxisLabelMode==="mixed"){var _extent=extent(categoryArr,function(obj){return Number(obj.x)});catMin=_extent[0];catMax=_extent[1]}var _axis$getTrendLineLim=axis.getTrendLineLimits();trendMin=_axis$getTrendLineLim[0];trendMax=_axis$getTrendLineLim[1];var _extent2=extent([trendMin,trendMax,catMin,catMax,min,max],numberAccessor);min=_extent2[0];max=_extent2[1];axisConfig.originalMax=max;axisConfig.originalMin=min;max=axisConfig.isPercent?100:max+endPad;min=axisConfig.isPercent?0:min-startPad;axis._setAxisRange({min:min,max:max});if(axisConfig.axisRange.tickInterval!==UNDEF){axis._adjustNumberFormatter(axisConfig.axisRange.tickInterval)}},getTrendLineLimits=function getTrendLineLimits(){var axisConfig=this.config,lines=axisConfig.trendLines||axisConfig.vTrendLines||axisConfig.trendPoints,lineArr=lines&&lines[0]&&lines[0].line||lines&&lines.point,startMin,startMax,endMin,endMax;if(axisConfig.trendLimits)return axisConfig.trendLimits;var _extent3=extent(lineArr,function(obj){return obj.startvalue===""?UNDEF:Number(obj.startvalue)});startMin=_extent3[0];startMax=_extent3[1];var _extent4=extent(lineArr,function(obj){return obj.endvalue===""?UNDEF:Number(obj.endvalue)});endMin=_extent4[0];endMax=_extent4[1];axisConfig.trendLimits=extent([startMin,startMax,endMin,endMax],function(a){return Number(a)});return axisConfig.trendLimits},getPixel=function getPixel(value){return this.getScale().getRangeValue(value)},_drawLabel=function _drawLabel(){var axis=this,chart=axis.getFromEnv("chart"),axisConfig=axis.config,animationManager=axis.getFromEnv("animationManager"),toolTipController=this.getFromEnv("toolTipController"),axisRange=axisConfig.axisRange,labels=axisConfig.labels,style=labels.style,axisComponents=axis.components,i,j,ln,max=axisRange.max,min=axisRange.min,axisContainer=axisConfig.axisContainer,extremeLabels=axisConfig.extremeLabels,textElement,ticks=axisConfig.ticks,mapId,map=[],css={fontFamily:style.fontFamily,fontSize:style.fontSize,fontWeight:style.fontWeight,fontStyle:style.fontStyle,lineHeight:style.lineHeight},removingElement,axisAttrObj,value,diff,labelIndexArr,raiseEvent=function raiseEvent(event){return function(data){var ele=this;chart.plotEventHandler(ele,data,event)}},labelConfArr;if(axisConfig.labels.isDraw){labelConfArr=axisComponents.labels;labelIndexArr=axisComponents.labelIndexArr;axisContainer.css(css);for(j=0,ln=labelIndexArr&&labelIndexArr.length;j<ln;j+=1){i=labelIndexArr[j];value=ticks[i];mapId=""+value+LABEL_ID;textElement=axis.getGraphicalElement(mapId);axisAttrObj=labelConfArr[i].config.props.label.attr;textElement=axis.addGraphicalElement(mapId,animationManager.setAnimation({el:textElement||"text",attr:axisAttrObj,container:axisContainer,data:{value:value},component:axis,label:"text"}));textElement.on("fc-click",raiseEvent("dataLabelClick")).hover(raiseEvent("dataLabelRollOver"),raiseEvent("dataLabelRollOut"));textElement.data(EVENTARGS,{link:style.labelLink,text:axisAttrObj.text,index:i});if(axisAttrObj.tooltext){toolTipController.enableToolTip(textElement,axisAttrObj.tooltext)}else{toolTipController.disableToolTip(textElement)}if(value===max){extremeLabels.lastLabel.graphic=textElement}else if(value===min){extremeLabels.firstLabel.graphic=textElement}map.push(mapId)}}diff=difference(axisConfig.prevIntervalArr,map);for(i=0,ln=diff.length;i<ln;i++){removingElement=axis.getGraphicalElement(diff[i]);removingElement&&axis.removeGraphicalElement(removingElement)}axisConfig.prevIntervalArr=map},_parseLabel=function _parseLabel(){var axis=this,axisConfig=axis.config,canvasDimensions=axis.getLinkedItem("canvas").getEffectiveDimensions(),axisDimension=axisConfig.axisDimention,chart=axis.getFromEnv("chart"),chartConfig=chart.config,axisRange=axisConfig.axisRange,isOpposit=axisConfig.isOpposit,labels=axisConfig.labels,axisComponents=axis.components,labelStore=axisComponents.labels,style=labels.style,smartLabel=chart.getFromEnv("smartLabel"),i,ln,isVertical=axisConfig.isVertical,max=axisRange.max,min=axisRange.min,numberFormatter=axis.getFromEnv("number-formatter"),canvasTop=canvasDimensions.top,canvasLeft=canvasDimensions.left,canvasBottom=canvasTop+canvasDimensions.height,canvasRight=canvasLeft+canvasDimensions.width,axisPadding=axisConfig.labelPadding,extremeLabels=axisConfig.extremeLabels,axisStartPosition=isVertical?axisDimension.x:axisDimension.y,axisEndPosition=axisDimension.opposite,labelRotation,labelLineHeight,avalW,avalH,axisValueMaxH=axisConfig.labelMaxH,axisValueMaxW=axisConfig.labelMaxW,tempStep,tickInterval=axisRange.tickInterval,intervalWidth=Math.abs(axis.getPixel(min,queryOptions)-axis.getPixel(min+tickInterval,queryOptions)),numberFormatterFn,axisAttrObjCommon,axisAttrObj,tickMap=[],ticks=axisConfig.ticks,counter=0,isReverse=axisConfig.isReverse,leftSpace,rightSpace,value,smartLabelConf,showZeroPlaneValue=pluckNumber(axis.getFromEnv("chart-attrib").showzeroplanevalue),checkLimit=true,zeroInPx,limit=axis.getLimit(),intervalArr;smartLabel.useEllipsesOnOverflow(chartConfig.useEllipsesWhenOverflow);smartLabel.setStyle({fontSize:style.fontSize,fontFamily:style.fontFamily,lineHeight:style.lineHeight,fontWeight:style.fontWeight});labelLineHeight=style.lineHeight;if(labelLineHeight){if(labelLineHeight.indexOf("px")!==-1){labelLineHeight=parseFloat(labelLineHeight.replace("px",""))}}if(showZeroPlaneValue===0){checkLimit=false}if(axisConfig.labels.isDraw){if(axisConfig.drawLabelsOpposit){isOpposit=!isOpposit;axisStartPosition=axisEndPosition}axisAttrObjCommon={fill:style.color,"line-height":labelLineHeight,"font-size":style.fontSize,opacity:1,cursor:style.labelLink?POINTER:""};labelRotation=axisConfig.labels.rotation;if(isVertical){if(axisConfig.labelMaxH>intervalWidth&&!axisConfig.tickValues){tempStep=Math.ceil(axisConfig.labelMaxH/intervalWidth)}axisAttrObjCommon["text-anchor"]=isOpposit?POSITION_START:POSITION_END}else{if(axisConfig.labelMaxW>intervalWidth&&!axisConfig.tickValues){tempStep=Math.ceil(axisConfig.labelMaxW/intervalWidth)}if(labelRotation){axisAttrObjCommon["text-anchor"]=isOpposit?POSITION_START:POSITION_END;axisAttrObjCommon["vertical-align"]=MIDDLE_STR}else{axisAttrObjCommon["vertical-align"]=isOpposit?POSITION_BOTTOM:POSITION_TOP}leftSpace=canvasLeft;rightSpace=chartConfig.width-canvasRight}if(tempStep>axisConfig.labels.step){axisConfig.labels.step=tempStep}if(axisConfig.numberFormatterFn){numberFormatterFn=numberFormatter[axisConfig.numberFormatterFn]}else if(axisConfig.isPercent){numberFormatterFn=numberFormatter.yAxisPercentValue}else if(isVertical){numberFormatterFn=numberFormatter.yAxis}else{numberFormatterFn=numberFormatter.xAxis}extremeLabels.firstLabel={};extremeLabels.lastLabel={};intervalArr=ticks.filter(function(tick,idx,arr){if(tick===0&&!axisConfig.showZeroPlaneValue){if(!checkLimit||checkLimit&&!(limit.max===tick||limit.min===tick)){return false}tickMap[counter++]=idx;return true}else if(!isVertical&&idx!==arr.length-1&&axis.getPixel(tick,queryOptions)+axisConfig.labelMaxW>canvasRight){return false}else if(idx%axisConfig.labels.step===0){tickMap[counter++]=idx;return true}else if(axisConfig.labels.drawLimitVal&&(idx===0||idx===arr.length-1)){tickMap[counter++]=idx;return true}return false});if(axisConfig.isZeroTickForced&&intervalArr.indexOf(0)!==-1){var valueInPx;counter=0;tickMap=[];zeroInPx=axis.getPixel(0);intervalArr=intervalArr.filter(function(tick,index,arr){valueInPx=axis.getPixel(tick);if(arr[index+1]===0||arr[index-1]===0){if(isVertical){if(valueInPx+axisValueMaxH>=zeroInPx&&zeroInPx>=valueInPx-axisValueMaxH)return false;tickMap[counter++]=index;return true}else if(valueInPx+axisValueMaxW>=zeroInPx&&zeroInPx>=valueInPx-axisValueMaxW){return false}tickMap[counter++]=index;return true}tickMap[counter++]=index;return true})}avalW=(isVertical?axisValueMaxW:intervalWidth/2)*axisConfig.labels.step;avalH=isVertical?intervalWidth/2:axisValueMaxH;axisComponents.labelIndexArr=tickMap.slice();for(i=0,ln=intervalArr.length;i<ln;i+=1){value=intervalArr[i];labelStore[tickMap[i]]=labelStore[tickMap[i]]||{config:{props:{label:{}}}};axisAttrObj=Object.assign({},axisAttrObjCommon);smartLabelConf=UNDEF;if(!axisConfig.labels.drawNormalVal&&!(value===min||value===max)){axisAttrObj.text=BLANKSTRING}else if(!axisConfig.labels.drawLimitVal&&(value===min||value===max)){axisAttrObj.text=BLANKSTRING}else if(value===min&&axisConfig.lowerLimitDisplay&&axisConfig.labels.drawLimitVal){smartLabelConf=smartLabel.getSmartText(axisConfig.lowerLimitDisplay,avalW,avalH+labelLineHeight/2);axisAttrObj.text=smartLabelConf.text;axisAttrObj.tooltext=smartLabelConf.tooltext}else if(value===max&&axisConfig.upperLimitDisplay&&axisConfig.labels.drawLimitVal){smartLabelConf=smartLabel.getSmartText(axisConfig.upperLimitDisplay,avalW,avalH+labelLineHeight/2);axisAttrObj.text=smartLabelConf.text;axisAttrObj.tooltext=smartLabelConf.tooltext}else{axisAttrObj.text=BLANKSTRING+numberFormatterFn.call(numberFormatter,value,axisConfig.axisIndex);smartLabelConf=smartLabel.getOriSize(axisAttrObj.text)}if(isVertical){axisAttrObj.x=isOpposit?(axisStartPosition||canvasRight)+axisPadding:(axisStartPosition||canvasLeft)-axisPadding;axisAttrObj.y=axis.getPixel(value,queryOptions);if((isReverse&&value===min&&axisConfig.lowerLimitDisplay||!isReverse&&value===max&&axisConfig.upperLimitDisplay)&&smartLabelConf&&smartLabelConf.height>labelLineHeight){axisAttrObj["vertical-align"]=POSITION_BOTTOM}if((isReverse&&value===max&&axisConfig.upperLimitDisplay||!isReverse&&value===min&&axisConfig.lowerLimitDisplay)&&smartLabelConf&&smartLabelConf.height>labelLineHeight){axisAttrObj["vertical-align"]=POSITION_TOP}if(axisConfig.placeValuesInside){axisAttrObj["text-anchor"]=isOpposit?POSITION_END:POSITION_START}}else{axisAttrObj.x=axis.getPixel(value,queryOptions);axisAttrObj.y=isOpposit?(axisStartPosition||canvasTop)-axisPadding:(axisStartPosition||canvasBottom)+axisPadding;if((!isReverse&&value===min||isReverse&&value===max)&&smartLabelConf&&smartLabelConf.width>leftSpace*2){axisAttrObj["text-anchor"]=POSITION_START}if((!isReverse&&value===max||isReverse&&value===min)&&smartLabelConf&&smartLabelConf.width>rightSpace*2){axisAttrObj["text-anchor"]=POSITION_END}if(axisConfig.placeValuesInside){axisAttrObj["vertical-align"]=isOpposit?POSITION_TOP:POSITION_BOTTOM}else{axisAttrObj["vertical-align"]=isOpposit?POSITION_BOTTOM:POSITION_TOP}}if(typeof value==="undefined"){axisAttrObj["text-bound"]=[]}else{axisAttrObj["text-bound"]=[pluck(style.backgroundColor,BLANKSTRING),pluck(style.borderColor,BLANKSTRING),pluck(style.borderThickness,BLANKSTRING),pluck(style.borderPadding,0),pluck(style.borderRadius,0),pluck(style.borderDash,NOSTRING)]}if(labels.shiftX){axisAttrObj.x+=labels.shiftX}if(labels.shiftY){axisAttrObj.y+=labels.shiftY}axisAttrObj.transform=getSuggestiveRotation(labelRotation,axisAttrObj.x,axisAttrObj.y);labelStore[tickMap[i]].config.props.label.attr=axisAttrObj}}},setTickValues=function setTickValues(categories){var len=categories&&categories.length,axisConfig=this.config,startPad=axisConfig.startPad||0,index,chart=this.getFromEnv("chart"),tickObj,countCat=0,tickValues=axisConfig.tickValues={},tickValue=tickValues.tickValue=[],vline=tickValues.vline=[],tickIdMap=tickValues.tickIdMap={},endPad=axisConfig.endPad||0;axisConfig.hasCategory=1;for(index=0;index<len;index+=1){tickObj=extend2({},categories[index]);if(!tickObj.vline){if(tickObj.id){tickIdMap[tickObj.id.toLowerCase()]={tickObj:tickObj,index:countCat}}if(axisConfig.mapTickValuesById&&tickObj.id||!axisConfig.mapTickValuesById){extractStyleInfo(tickObj,chart);tickValue.push(tickObj);tickValue[countCat].label=parseUnsafeString(tickValue[countCat].label);countCat+=1}}else{tickObj.startIndex=tickValue.length-1;vline.push(tickObj)}}axisConfig.oriCatLen=countCat;this._setAxisRange({max:Number(toPrecision(countCat-1+endPad,10)),min:Number(toPrecision(0-startPad,10)),tickInterval:Number(toPrecision(1,10))})},shiftLabels=function shiftLabels(x,y){var axis=this,axisConfig=axis.config,labels=axisConfig.labels;labels.shiftX=x;labels.shiftY=y},_createContainer=function _createContainer(){var axis=this,axisConfig=axis.config,isVertical=axisConfig.isVertical,chart=axis.getLinkedParent(),childContainers=chart.getChildContainer(),axisBottom=childContainers.axisBottomGroup,axisTop=childContainers.axisTopGroup,translation=-axis.getTranslation(),translateString=isVertical?"T0,"+translation:"T"+translation+",0",axisLineGroup,axisNameGroup,axisTrendGroupTop,axisLabelGroup,axisLabelGroupTop;axisNameGroup=axis.createContainer("axisNameGroup",{name:"dataset-Name-group"},axisBottom);axisLineGroup=axis.createContainer("axisLineGroup",{name:"axis-Line-group"},axisTop);axisTrendGroupTop=axis.createContainer("axisTrendGroupTop",{name:"dataset-Trend-group-top"},axisTop);axisLabelGroup=axis.createContainer("axisLabelGroup",{name:"dataset-Label-group"},axisBottom);axisLabelGroupTop=axis.createContainer("axisLabelGroupTop",{name:"dataset-Label-group"},axisTop);if(!axis.getGraphicalElement("scrollbarContainer")){axis.addGraphicalElement("scrollbarContainer",axis.createGroup("scrollbarContainer",{name:"scrollbar-container"},axisLineGroup,"scrollbar"))}axisConfig.axisContainer=axis.createGroup("axisContainer",{name:"dataset-axis",transform:translateString},axisLabelGroup);axisConfig.axisLabelContainerTop=axis.createGroup("axisLabelContainerTop",{name:"dataset-top-label",transform:translateString},axisLabelGroupTop);axisConfig.axisAxisLineContainer=axis.createGroup("axisAxisLineContainer",{name:"axis-line-tick"},axisLineGroup);axisConfig.axisTrendLabelContainer=axis.createGroup("axisTrendLabelContainer",{name:"dataset-axis-trend-label"},axisTrendGroupTop);axisConfig.axisNameContainer=axis.createGroup("axisNameContainer",{name:"dataset-axis-name"},axisNameGroup);axisConfig.axisAxisLineContainerBottom=axis.createGroup("axisAxisLineContainerBottom",{name:"axis-line-tick-bottom"},axisBottom)},setAxisPadding=function setAxisPadding(_startPad,_endPad){if(_startPad===void 0){_startPad=0}if(_endPad===void 0){_endPad=0}var axis=this,axisConfig=axis.config,startPad=_startPad,endPad=_endPad,scale=axis.getScale(),_scale$getDomain=scale.getDomain(),min=_scale$getDomain[0],max=_scale$getDomain[1],diff;if(axisConfig.oriCatLen===1){if(startPad===0){startPad=.5}if(endPad===0){endPad=.5}}diff=startPad-axisConfig.startPad;axisConfig.startPad=Math.max(axisConfig.startPad,startPad);axisConfig.endPad=Math.max(axisConfig.endPad,endPad);if(diff>0){axisConfig.setPadding=true;axis._setAxisRange({min:min-diff,max:max+diff})}if(!axisConfig.tickValues){if(axisConfig.originalMax&&axisConfig.originalMin){axis.setDataLimit(axisConfig.originalMax,axisConfig.originalMin)}}},getLabel=function getLabel(tickId){var axis=this,axisConfig=axis.config,tickObj=axisConfig.tickValues&&axisConfig.tickValues.tickValue[tickId],macroIndices=[3],parserConfig={};if(tickObj&&tickObj.tooltext){parserConfig.label=tickObj.label;tickObj.tooltext=parseTooltext(tickObj.tooltext,macroIndices,parserConfig)}return{label:tickObj&&(tickObj.oriLabel||tickObj.label),tooltext:tickObj&&tickObj.tooltext}};export{setAxisDimention,setDataLimit,getTrendLineLimits,getPixel,_drawLabel,setTickValues,shiftLabels,_createContainer,setAxisPadding,getLabel,extractStyleInfo,_parseLabel};