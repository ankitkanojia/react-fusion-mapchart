import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import Task,{extractLabelStyle,checkInvalidValue,hideFn}from"./task";import{extend2,parseConfiguration,getFirstValue,pluck,pluckNumber,getValidValue,parseUnsafeString,parseTooltext,setLineHeight,getDarkColor,mapSymbolName,getFirstColor,BLANKSTRING,HUNDREDSTRING}from"@fusioncharts/core/src/lib";import milestoneAnimation from"./milestone-gantt.animation";import{addDep}from"@fusioncharts/core/src/dependency-manager";import{priorityList}from"@fusioncharts/core/src/schedular";var UNDEF,FF5E5E="FF5E5E",MIDDLE="middle";var clickHandler=function clickHandler(chart){return function(event){var ele=this;chart.plotEventHandler(ele,event,"MilestoneClick")}},rollOverHandler=function rollOverHandler(chart){return function(event){var ele=this,dataObj=ele.data("dataObj"),config=dataObj.config;chart.plotEventHandler(ele,event,"MilestoneRollOver");config.showHoverEffect&&dataObj.graphics.element.attr({fill:config.hoverFillColor,stroke:config.hoverBorderColor,"fill-opacity":config.hoverFillAlpha,"stroke-opacity":config.hoverBorderAlpha})}},rollOutHandler=function rollOutHandler(chart){return function(event){var ele=this,dataObj=ele.data("dataObj"),config=dataObj.config;chart.plotEventHandler(ele,event,"MilestoneRollOut");config.showHoverEffect&&dataObj.graphics.element.attr({fill:config.fillColor,stroke:config.borderColor,"fill-opacity":config.fillAlpha,"stroke-opacity":config.borderAlpha})}};addDep({name:"milestoneAnimation",type:"animationRule",extension:milestoneAnimation});var Milestone=function(_Task){_inheritsLoose(Milestone,_Task);function Milestone(){return _Task.apply(this,arguments)||this}var _proto=Milestone.prototype;_proto.getName=function getName(){return"milestone"};_proto.__setDefaultConfig=function __setDefaultConfig(){_Task.prototype.__setDefaultConfig.call(this);var config=this.config;config.showpercentlabel=0;config.showstartdate=0;config.showenddate=0;config.showlabels=UNDEF;config.showborder=1;config.borderthickness=1;config.showHoverEffect=1;config.slackFillColor=FF5E5E;config.font=BLANKSTRING;config.fontcolor=BLANKSTRING;config.fontsize=BLANKSTRING;config.color=BLANKSTRING;config.alpha=HUNDREDSTRING;config.bordercolor=BLANKSTRING;config.borderalpha=HUNDREDSTRING;config.hoverFillColor=BLANKSTRING;config.hoverFillAlpha=HUNDREDSTRING;config.slackHoverFillColor=10;config.slackHoverFillAlpha=HUNDREDSTRING};_proto.configureAttributes=function configureAttributes(){var dataset=this,config=dataset.config,jsonData=dataset.getFromEnv("dataSource"),userConfig=extend2({},jsonData.milestones&&jsonData.milestones.length?jsonData.milestones[0]:jsonData.milestones||{});parseConfiguration(userConfig,config,{milestones:true});if(!dataset.components){dataset.components={}}dataset._setConfigure();dataset.setState("dirty",true)};_proto._setConfigure=function _setConfigure(newDataset){var dataset=this,chart=dataset.getFromEnv("chart"),yAxis=chart.getChildren("yAxis")[0],axisConfig=yAxis.config,jsonData=dataset.getFromEnv("dataSource"),JSONData=jsonData.milestones&&jsonData.milestones.length?jsonData.milestones[0]:jsonData.milestones||{},setDataArr=newDataset||JSONData.length?JSONData:JSONData.milestone,setDataLen=setDataArr&&setDataArr.length,colorM=dataset.getFromEnv("color-manager"),chartConfig=chart.config,numberFormatter=dataset.getFromEnv("number-formatter"),dataStore=dataset.components.data,style=chart.config.style,inCanStyle=style.inCanvasStyle,tasksMap=chart.components.tasksMap,dataObj,taskConfigObj,dataConfig,i,processMap=axisConfig.processes.processMap,processes=axisConfig.processes.process.process,processName,setData,sides,color,shape,depth,toolText,taskId,labelStyle=chart.config.milestoneLabelStyle,dateMs,milestoneDate;if(!dataStore){dataStore=dataset.components.data=[]}for(i=0;i<setDataLen;i+=1){setData=setDataArr[i];dataObj=dataStore[i];if(!dataObj){dataObj=dataStore[i]={config:{}}}dataConfig=dataObj.config;taskId=getFirstValue(setData.taskid,BLANKSTRING).toLowerCase();shape=pluck(setData.shape,"polygon").toLowerCase();sides=pluckNumber(setData.numsides,5);depth=0;if(shape==="star"){depth=.4}else{shape=mapSymbolName(sides);shape=mapSymbolName(sides).split("-")[0]}color=pluck(setData.color,colorM.getColor("legendBorderColor"));toolText=getValidValue(parseUnsafeString(pluck(setData.tooltext,setData.hovertext,chartConfig.milestonetooltext)));dateMs=numberFormatter.getDateValue(setData.date).ms;milestoneDate=numberFormatter.getFormattedDate(dateMs);if(toolText!==UNDEF&&tasksMap[taskId]){taskConfigObj=tasksMap[taskId].config;if(processMap[taskId]){processName=processMap[taskId].catObj.label||processMap[taskId].catObj.name}else{processName=processes[i]&&(processes[i].label||processes[i].name)}toolText=parseTooltext(toolText,[28,32,33,34,35,36],{date:milestoneDate,taskStartDate:taskConfigObj._startDate,taskEndDate:taskConfigObj._endDate,taskLabel:taskConfigObj.label,taskPercentComplete:taskConfigObj.percentComplete!==-1?numberFormatter.percentValue(taskConfigObj.percentComplete):BLANKSTRING,processName:processName},setData)}else{toolText=milestoneDate}style=dataConfig.style=extractLabelStyle({fontSize:setData.fontsize,fontFamily:setData.font,fontWeight:setData.fontbold,fontStyle:setData.fontitalic});dataConfig.textColor=getFirstColor(pluck(setData.fontcolor,chartConfig.milestonefontcolor,inCanStyle.color));setLineHeight(style);dataConfig.lineHeight=pluck(style&&style.lineHeight,labelStyle&&labelStyle.lineHeight);dataConfig.numSides=sides;dataConfig.startAngle=pluckNumber(setData.startangle,90);dataConfig.radius=setData.radius;dataConfig.origDate=setData.date;dataConfig.date=numberFormatter.getDateValue(setData.date);dataConfig.fillColor=getFirstColor(color);dataConfig.fillAlpha=pluckNumber(setData.fillalpha,setData.alpha,100)*.01;dataConfig.borderColor=getFirstColor(pluck(setData.bordercolor,color));dataConfig.borderAlpha=pluckNumber(setData.borderalpha,setData.alpha,100)*.01;dataConfig.displayValue=parseUnsafeString(setData.label);dataConfig.style=style;dataConfig.hoverFillColor=getFirstColor(pluck(setData.hoverfillcolor,chartConfig.milestonehoverfillcolor,getDarkColor(color,80)));dataConfig.hoverFillAlpha=pluckNumber(setData.hoverfillalpha,chartConfig.milestonehoverfillalpha,setData.fillalpha,setData.alpha,100)*.01;dataConfig.hoverBorderColor=getFirstColor(pluck(setData.hoverbordercolor,chartConfig.milestonehoverbordercolor,getDarkColor(pluck(setData.bordercolor,color),80)));dataConfig.hoverBorderAlpha=pluckNumber(setData.hoverborderalpha,chartConfig.milestonehoverborderalpha,setData.borderalpha,setData.alpha,100)*.01;dataConfig.showHoverEffect=pluckNumber(setData.showhovereffect,chartConfig.showmilestonehovereffect,chartConfig.showhovereffect,1);dataConfig.depth=depth;dataConfig.taskId=taskId;dataConfig.borderThickness=pluckNumber(setData.borderthickness,1);dataConfig.link=setData.link;dataConfig.toolText=toolText}if(pluckNumber(JSONData.visible,1)){dataset.setState("visible",true)}else{dataset.setState("visible",false)}};_proto.drawLabel=function drawLabel(){var dataset=this,chart=dataset.getFromEnv("chart"),animationManager=dataset.getFromEnv("animationManager"),tasksMap=chart.components.tasksMap,config,toolTipController=dataset.getFromEnv("toolTipController"),dataLabelContainer=dataset.getContainer("milestoneLabelContainer"),eventArgs,dataObj,i,labelElementDummy,labelElement,len,graphics,labelAttrs,taskObj,dataStore=dataset.components.data,style;for(i=0,len=dataStore.length;i<len;i++){dataObj=dataStore[i];config=dataObj.config;taskObj=tasksMap[config.taskId];graphics=dataObj.graphics;labelElementDummy=graphics.labelElement;eventArgs=config.eventArgs;labelAttrs=config._labelAttrs;style=config.style;if(config.displayValue!==BLANKSTRING&&config.displayValue!==UNDEF&&taskObj){labelElement=graphics.labelElement=animationManager.setAnimation({el:labelElementDummy||"text",attr:labelAttrs,container:dataLabelContainer,component:dataset});if(!labelElementDummy){labelElement.on("fc-click",clickHandler(chart)).hover(rollOverHandler(chart),rollOutHandler(chart))}else{labelElement.removeCSS();labelElement.show()}labelElement.css(style);toolTipController.enableToolTip(labelElement,config.toolText);labelElement.data("eventArgs",eventArgs).data("dataObj",dataObj)}else{labelElementDummy&&animationManager.setAnimation({el:labelElementDummy,component:dataset,callback:hideFn,doNotRemove:true})}}};_proto.draw=function draw(){var dataset=this,chart=dataset.getFromEnv("chart"),chartComponents=chart.components,components=dataset.components,toolTipController=dataset.getFromEnv("toolTipController"),xAxis=chart.getChildren("xAxis")[0],dataStore=components.data,taskMap=chartComponents.tasksMap,chartConfig=chart.config,canvas=chart.getChildren("canvas")[0],container=dataset.getContainer("milestoneContainer"),parentContainer=canvas.getChildContainer("milestoneGroup"),dataLabelContainer=dataset.getContainer("milestoneLabelContainer"),visible=dataset.getState("visible"),animationManager=dataset.getFromEnv("animationManager"),removeDataArr=dataset.components.removeDataArr||[],removeDataArrLen=removeDataArr.length,dataObj,taskObj,graphics,config,eventArgs,taskConfigObj,setElementDummy,setElement,xPos,yPos,polypath,radius,i,ln,labelAttrs,showTooltip=chartConfig.showtooltip;if(!container){container=dataset.addContainer("milestoneContainer",animationManager.setAnimation({el:"group",attr:{name:"milestone"},container:parentContainer,component:dataset}))}if(!visible){container.hide()}else{container.show()}if(!dataLabelContainer){dataLabelContainer=dataset.addContainer("milestoneLabelContainer",animationManager.setAnimation({el:"group",attr:{name:"labels"},container:parentContainer,component:dataset}))}if(!visible){dataLabelContainer.hide()}else{dataLabelContainer.show()}ln=dataStore&&dataStore.length;for(i=0;i<ln;i+=1){dataObj=dataStore[i];if(!dataObj){continue}config=dataObj.config;graphics=dataObj.graphics;taskObj=taskMap[config.taskId];!dataObj.graphics&&(dataObj.graphics={});setElementDummy=graphics.element;if(taskObj){taskConfigObj=taskObj.config;eventArgs=config.eventArgs={sides:config.sides,date:config.origDate,radius:config.radius,taskId:config.taskId,toolText:config.toolText,link:config.link,numSides:config.numSides};xPos=xAxis.getPixel(config.date.ms);yPos=taskConfigObj.yPos+taskConfigObj.height*.5;radius=pluckNumber(config.radius,taskConfigObj.height*.6);if(checkInvalidValue(xPos,yPos,radius)===false){continue}polypath=[config.numSides,xPos,yPos,radius,config.startAngle,config.depth];setElement=graphics.element=animationManager.setAnimation({el:setElementDummy||"polypath",label:"polypath",attr:{polypath:polypath,fill:config.fillColor,"fill-opacity":config.fillAlpha,stroke:config.borderColor,"stroke-opacity":config.borderAlpha,groupId:"gId"+i,cursor:config.link?"pointer":BLANKSTRING,"stroke-width":config.borderThickness},component:dataset,container:container});setElement.on("fc-click",clickHandler(chart)).hover(rollOverHandler(chart),rollOutHandler(chart));setElement.show().data("eventArgs",eventArgs).data("dataObj",dataObj);if(showTooltip){toolTipController.enableToolTip(setElement,config.toolText)}else{toolTipController.disableToolTip(setElement)}labelAttrs=config._labelAttrs||(config._labelAttrs={});labelAttrs.x=xPos;labelAttrs.y=yPos;labelAttrs.text=config.displayValue;labelAttrs.groupId="gId"+i;labelAttrs.cursor=config.link?"pointer":BLANKSTRING;labelAttrs.direction=chartConfig.textDirection;labelAttrs["text-anchor"]=MIDDLE;labelAttrs.fill=config.textColor}else{setElementDummy&&animationManager.setAnimation({el:setElementDummy,component:dataset,callback:hideFn,doNotRemove:true})}}dataset.drawn?dataset.drawLabel():dataset.addJob("drawMilestoneLabels",dataset.drawLabel.bind(dataset),priorityList.label);dataset.drawn=true;for(i=0;i<removeDataArrLen;i++){dataset._removeDataVisuals(removeDataArr.shift())}};return Milestone}(Task);export default Milestone;