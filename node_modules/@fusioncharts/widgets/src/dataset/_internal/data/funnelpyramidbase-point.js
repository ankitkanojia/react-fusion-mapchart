import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import{ComponentInterface}from"@fusioncharts/core/src/component-interface";import{pluck,pluckNumber,BLANK,BLANKSTRING,UNDEF,parseUnsafeString,COMMASTRING,ZEROSTRING,getValidValue,parseTooltext,parsexAxisStyles,convertColor,getLightColor}from"@fusioncharts/core/src/lib";import{labelClickFn}from"@fusioncharts/charts/src/dataset/pie2d";import{priorityList}from"@fusioncharts/core/src/schedular";var CRISP="crisp",M="M",L="L",POINTER="pointer",DEFAULT="default",win=window,userAgent=win.navigator.userAgent,isIE=/msie/i.test(userAgent)&&!win.opera,noneStr="none",EVENTARGS="eventArgs",TRACKER_FILL="rgba(192,192,192,"+(isIE?.002:1e-6)+")",removeCSSProps=["fontFamily","fontSize","fontWeight","fontStyle"],hideFn=function hideFn(){this.hide()},extractTextStyle=function extractTextStyle(dataObj,chartAttr){var keyMap={labelfont:"fontFamily",labelfontcolor:"color",labelfontsize:"fontSize",labelfontbold:"fontWeight",labelfontitalic:"fontStyle",labelalpha:"alpha"},style,key;for(key in keyMap){if(!(key in dataObj)&&!(key in chartAttr)){continue}style=style||{};style[keyMap[key]]=pluck(dataObj[key],chartAttr[key])}if(!style){return style}if(style.fontWeight){style.fontWeight=pluckNumber(style.fontWeight)?"bold":"normal"}if(style.fontStyle){style.fontStyle=pluckNumber(style.fontStyle)?"italic":"normal"}style.color=convertColor(style.color,style.alpha);return style};var FunnelPyramidBasePoint=function(_ComponentInterface){_inheritsLoose(FunnelPyramidBasePoint,_ComponentInterface);function FunnelPyramidBasePoint(){return _ComponentInterface.apply(this,arguments)||this}var _proto=FunnelPyramidBasePoint.prototype;_proto.parseAndConfigurePoint=function parseAndConfigurePoint(dataObj,res,colorIndex,index){var point=this,datasetStore=point.getLinkedParent(),chart=datasetStore.getFromEnv("chart"),conf=datasetStore.config,numberFormatter=datasetStore.getFromEnv("number-formatter"),smartLabel=datasetStore.getFromEnv("smartLabel"),colorManager=datasetStore.getFromEnv("color-manager"),refreshedData,highestValue,sumValue=0,sum,dataValue,prevValue,name,smartTextObj,pointSliced,pValue,formatedVal,labelText,displayValueText,displayValue,toolText,ttValue,filteredDataObj,showPercentValues=conf.showPercentValues,labelSepChar=conf.labelSepChar,chartAttr=chart.getFromEnv("chart-attrib"),isSliced=conf.isSliced,plotColor,plotAlpha,plotBorderColor,plotBorderAlpha,pointShadow={apply:conf.showShadow,opacity:1},minplotheightforvalue=pluckNumber(dataObj.minplotheightforvalue,chartAttr.minplotheightforvalue,0),tooltipOptions,hoverEffects,displayValueArgs,plotBorderWidth=conf.plotBorderThickness,defStyle=conf.style,legendItemId,colorApplied,labellink,legendColor;conf.showTextOutline=pluckNumber(chartAttr.textoutline,0);refreshedData=res.refreshedData;sumValue=res.sumValue;sum=numberFormatter.dataLabels(sumValue);highestValue=res.highestValue;labellink=pluck(dataObj.labellink,chartAttr.labellink,dataObj.link,UNDEF);legendItemId=dataObj.legendItemId;dataValue=dataObj.cleanValue;prevValue=index?refreshedData[index-1].value:dataValue;name=parseUnsafeString(pluck(dataObj.label,dataObj.name,BLANKSTRING));smartLabel.setStyle(point.getFromEnv("dataLabelStyle"));smartTextObj=smartLabel.getOriSize(name);plotAlpha=dataObj.alpha||conf.plotFillAlpha;colorApplied=pluck(dataObj.color,colorManager.getPlotColor(colorIndex));legendColor=convertColor(colorApplied);plotColor=convertColor(colorApplied,plotAlpha);plotBorderColor=pluck(dataObj.bordercolor,conf.plotBorderColor,getLightColor(colorApplied,25)).split(COMMASTRING)[0];plotBorderAlpha=!conf.showPlotBorder?ZEROSTRING:pluck(dataObj.borderalpha,conf.plotBorderAlpha,"80");pointShadow.opacity=Math.max(plotAlpha,plotBorderAlpha)/100;pointSliced=pluckNumber(dataObj.issliced,isSliced);if(pointSliced){conf.noOFSlicedElement+=1;conf.preSliced=pointSliced}if(res.prevPerValReq){sumValue=prevValue}pValue=numberFormatter.percentValue(dataValue/sumValue*100);if(!conf.datalabelDisabled){formatedVal=numberFormatter.dataLabels(dataValue)||BLANKSTRING;labelText=conf.showLabels===1?name:BLANKSTRING;displayValueText=pluckNumber(dataObj.showvalue,conf.showValues)===1?showPercentValues===1?pValue:formatedVal:BLANKSTRING;displayValue=getValidValue(parseUnsafeString(dataObj.displayvalue));displayValueArgs=pluck(displayValue,name+labelSepChar+(showPercentValues?pValue:formatedVal),BLANKSTRING);if(displayValue){displayValueText=displayValue}else{if(displayValueText!==BLANKSTRING&&labelText!==BLANKSTRING){displayValueText=labelText+labelSepChar+displayValueText}else{displayValueText=pluck(labelText,displayValueText)||BLANKSTRING}}}toolText=getValidValue(parseUnsafeString(pluck(dataObj.tooltext,conf.toolText)));if(toolText!==UNDEF){tooltipOptions={formatedVal:formatedVal,name:name,pValue:pValue,sum:sum,sumValue:sum,dataValue:dataValue,prevValue:prevValue,highestValue:highestValue};toolText=parseTooltext(toolText,[1,2,3,7,14,24,25,37],datasetStore.getTooltipMacroStub(tooltipOptions),dataObj,chartAttr)}else{ttValue=conf.showPercentInToolTip===1?pValue:formatedVal;toolText=name!==BLANKSTRING?name+conf.tooltipSepChar+ttValue:ttValue}hoverEffects=datasetStore.pointHoverOptions(dataObj,{color:colorApplied,alpha:plotAlpha,borderColor:plotBorderColor,borderAlpha:plotBorderAlpha,borderWidth:plotBorderWidth});filteredDataObj={displayValue:displayValueText,origValue:displayValueText,displayValueArgs:displayValueArgs,style:parsexAxisStyles(dataObj,{},chartAttr,defStyle,plotColor),appliedStyle:extractTextStyle(dataObj,chartAttr),name:name,categoryLabel:name,rawColor:colorApplied,rawAlpha:plotAlpha,toolText:toolText,legendCosmetics:UNDEF,legendItemId:legendItemId||point&&point.legendItemId,showInLegend:UNDEF,y:dataValue,shadow:pointShadow,smartTextObj:smartTextObj,legendColor:legendColor,color:plotColor,alpha:plotAlpha,borderColor:convertColor(plotBorderColor,plotBorderAlpha),borderWidth:plotBorderWidth,link:getValidValue(dataObj.link),isSliced:pointSliced,doNotSlice:!conf.enableSlicing,hoverEffects:hoverEffects.enabled&&hoverEffects.options,labellink:labellink,rolloverProperties:hoverEffects.enabled&&hoverEffects.rolloverOptions,minplotheightforvalue:minplotheightforvalue};point.configure(filteredDataObj)};_proto.drawLabel=function drawLabel(){var point=this,index=point.index,datasetStore=point.getLinkedParent(),chart=datasetStore.getFromEnv("chart"),animationManager=datasetStore.getFromEnv("animationManager"),toolTipController=datasetStore.getFromEnv("toolTipController"),conf=datasetStore.config,dataLabelsGroup=chart.getChildContainer("datalabelsGroup"),dataStore=datasetStore.getChildren("data"),displayValue=point.displayValue,plotItem=point.plot||{},dataLabel=point.getGraphicalElement("dataLabel"),connector=point.getGraphicalElement("connector"),isNewDataLabel=!dataLabel,labelY=point.labelY,labelX=point.labelX,style=point.style||{},fontSize=pluckNumber(parseInt(style.fontSize,10),conf.baseFontSize),isFunnel=datasetStore.getName()==="funnel",lineHeight=conf.lineHeight,value,connectorAttr,actions,drawConnector,labelDrawingConfig,yShift=fontSize*.3,yDisplacement=lineHeight*.3,connectorStartY,connectorEndY,lastConnectorEndY,showLabelsAtCenter=conf.showLabelsAtCenter,connectorEndSwitchHistoryY=conf.connectorEndSwitchHistoryY,connectorEndX,connectorStartX,labelDistance=conf.labelDistance,blankSpace=conf.blankSpace,connectorPath,yD,streamLinedData=conf.streamLinedData;if(!point.displayValue||isFunnel&&!conf.streamLinedData&&!index){dataLabel&&animationManager.setAnimation({el:dataLabel,component:datasetStore,callback:hideFn,doNotRemove:true});connector&&animationManager.setAnimation({el:connector,component:datasetStore,callback:hideFn,doNotRemove:true});return}labelDrawingConfig=datasetStore.config.labelDrawingConfig[index];actions=labelDrawingConfig.actions;value=point.y;connectorAttr={"stroke-width":conf.dataConnectorStyle.connectorWidth,stroke:conf.dataConnectorStyle.connectorColor,transform:labelDrawingConfig.transform};labelDrawingConfig.args.cursor=point.labellink?"pointer":"default";if(labelDrawingConfig.args&&labelDrawingConfig.css){labelDrawingConfig.args.fill=labelDrawingConfig.css.color||labelDrawingConfig.css.fill}if(value===null||value===UNDEF||!point.shapeArgs){if(dataLabel){dataLabel.removeCSS(removeCSSProps);dataLabel&&animationManager.setAnimation({el:dataLabel,attr:labelDrawingConfig.args,component:datasetStore});dataLabel&&dataLabel.css(labelDrawingConfig.css)}else{dataLabel=animationManager.setAnimation({el:"text",label:"dataLabel",attr:labelDrawingConfig.args,css:labelDrawingConfig.css,container:dataLabelsGroup,component:datasetStore});point.addGraphicalElement("dataLabel",dataLabel)}dataLabel.outlineText(conf.showTextOutline,labelDrawingConfig.args.fill)}else{drawConnector=!(isFunnel&&index===0&&conf.streamLinedData);if(point.plot){dataLabel&&dataLabel.removeCSS(removeCSSProps);dataLabel=animationManager.setAnimation({el:dataLabel||"text",label:"dataLabel",attr:labelDrawingConfig.args,css:labelDrawingConfig.css,container:dataLabelsGroup,component:datasetStore});dataLabel.outlineText(conf.showTextOutline,labelDrawingConfig.args.fill);point.addGraphicalElement("dataLabel",dataLabel);connector=animationManager.setAnimation({el:connector||"path",attr:drawConnector&&connectorAttr,container:dataLabelsGroup,callback:function callback(){conf.showLabelsAtCenter&&this.hide()},component:datasetStore,label:"connector"});drawConnector&&point.addGraphicalElement("connector",connector)}toolTipController.enableToolTip(dataLabel,point.originalText);if(!isNewDataLabel){point.labelClickFn&&dataLabel.off("fc-click",point.labelClickFn);point.actionsClick&&dataLabel.off("fc-click",point.actionsClick)}point.labellink&&dataLabel.on("fc-click",function(_dataLabel,labellink){point.labelClickFn=function(){labelClickFn.call(_dataLabel,chart,labellink)};return point.labelClickFn}(dataLabel,point.labellink));!point.doNotSlice&&dataLabel.on("fc-click",function(context){point.actionsClick=function(){actions.click.call(context)};return point.actionsClick}(labelDrawingConfig.context));isNewDataLabel&&dataLabel.hover(actions.hover[0],actions.hover[1])}if(!showLabelsAtCenter){connectorStartY=labelY-yShift-point.distributionFactor*lineHeight;connectorEndY=labelY-yShift;lastConnectorEndY=connectorEndSwitchHistoryY[point.alignmentSwitch];if(conf.lastplotY!==UNDEF&&lastConnectorEndY!==UNDEF&&lastConnectorEndY-connectorEndY<lineHeight){connectorEndY=lastConnectorEndY-lineHeight;labelY=connectorEndY}point.displayValue&&(connectorEndSwitchHistoryY[point.alignmentSwitch]=connectorEndY);conf.lastplotY=point.plotY;if(conf.labelAlignment===conf.alignmentType.alternate){if(point.alignmentSwitch){connectorEndX=labelX+blankSpace+point.virtualWidth;connectorStartX=connectorEndX+labelDistance+point.distributionFactor*conf.globalMinXShift}else{connectorEndX=labelX-blankSpace;connectorStartX=connectorEndX-(labelDistance-(point.lOverflow||0))-point.distributionFactor*conf.globalMinXShift}}else{connectorEndX=labelX-blankSpace;connectorStartX=connectorEndX-(labelDistance-(point.lOverflow||0))-point.distributionFactor*conf.globalMinXShift}if(typeof displayValue!=="undefined"&&displayValue!==BLANKSTRING&&!(isFunnel&&index===0&&streamLinedData)){connectorPath=[M,connectorStartX,connectorStartY,L,connectorEndX,connectorEndY];animationManager.setAnimation({el:connector,state:"transform",label:"connector",attr:{path:connectorPath,"shape-rendering":connectorStartY===connectorEndY&&connectorEndY<1?CRISP:BLANK},component:datasetStore});connector.show()}else{connector&&animationManager.setAnimation({el:connector,component:datasetStore})}if(index===0&&streamLinedData){yD=labelY+(dataStore[1].plot.dy||0)}else{yD=connectorEndY+(plotItem.dy||0)}if(displayValue!==BLANKSTRING){animationManager.setAnimation({el:dataLabel,state:"transform",attr:{transform:["t",labelX,yD]},component:datasetStore,label:"dataLabel"});dataLabel.show()}else{dataLabel&&animationManager.setAnimation({el:dataLabel,component:datasetStore})}}else{if(index===0&&streamLinedData){yD=labelY-yDisplacement+(dataStore[1].plot.distanceAvailed||0)}else{yD=labelY-yDisplacement+(plotItem.distanceAvailed||0)}if(displayValue!==BLANKSTRING){animationManager.setAnimation({el:dataLabel,attr:{transform:["t",labelX,yD]},component:datasetStore});dataLabel.show()}else{dataLabel&&animationManager.setAnimation({el:dataLabel,component:datasetStore})}}dataLabel.attr({"text-bound":[style.backgroundColor,style.borderColor,style.borderThickness,style.borderPadding,style.borderRadius,style.borderDash]});if(point.showValue===0){point.getGraphicalElement().dataLabel&&point.getGraphicalElement().dataLabel.hide()}};_proto.drawTracker=function drawTracker(){var point=this,datasetStore=point.getLinkedParent(),chart=datasetStore.getFromEnv("chart"),renderer=chart.getFromEnv("paper"),trackerGroup=chart.getChildContainer("trackerGroup"),shapeArgs,trackerObj,trackerLabel=+new Date,graphic,eventArgs;if(!point){return}graphic=point.getGraphicalElement("graphic");trackerObj=point.getGraphicalElement("trackerObj");if(graphic){shapeArgs=graphic.Shapeargs.silhuette;eventArgs={link:point.link,value:point.y,displayValue:point.displayValueArgs,categoryLabel:point.categoryLabel,dataIndex:point.index||BLANK,toolText:point.toolText};point.datasetIndex=point.index;if(trackerObj){trackerObj.attr({path:shapeArgs,isTracker:trackerLabel,fill:TRACKER_FILL,stroke:noneStr,transform:"t0,"+(point.plot._startTranslateY||0),cursor:point.link?POINTER:DEFAULT})}else{trackerObj=renderer.path(shapeArgs,trackerGroup).attr({isTracker:trackerLabel,fill:TRACKER_FILL,stroke:noneStr,transform:"t0,"+(point.plot._startTranslateY||0),cursor:point.link?POINTER:DEFAULT});point.addGraphicalElement("trackerObj",trackerObj)}trackerObj.data(EVENTARGS,eventArgs);trackerObj.show()}};_proto.syncDraw=function syncDraw(){var component=this;component.fireEvent("predraw");component.removeJob("draw");component.getState("removed")?component.removingDraw():component.drawPlots&&component.drawPlots();component.addExtEventListener("animationComplete",component.__remove,component.getFromEnv("animationManager"));component.childrenSyncDraw();component.setState("dirty",false);component.setState("parentChanged",false);component.addJob("draw-complete",function(){component.fireEvent("drawn")},priorityList.instant)};return FunnelPyramidBasePoint}(ComponentInterface);export default FunnelPyramidBasePoint;