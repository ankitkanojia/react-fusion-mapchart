import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import MSCartesian from"@fusioncharts/charts/src/chart/_internal/mscartesian";import{TESTSTR,BLANKSTRING,preDefStr,pluck,pluckNumber,convertColor}from"@fusioncharts/core/src/lib";import RealtimeColumnDataset from"../../dataset/realtimecolumn";import ColumnMultiseriesGroup from"@fusioncharts/charts/src/dataset/groups/column-multiseries";import MessageLogger from"@fusioncharts/features/src/messagelogger";import AlertManager from"@fusioncharts/features/src/alertmanager";import FusionCharts from"@fusioncharts/constructor/src/constructor";import{addDep}from"@fusioncharts/core/src/dependency-manager";import realtimeColumnChartAnimation from"./index.animation";import{_realTimeConfigure as _realTimeConfigure2,eiMethods,_stopUpdate as _stopUpdate2,_restartUpdate as _restartUpdate2,_isUpdateActive as _isUpdateActive2,realTimeUpdate as _realTimeUpdate,_RTmanageSpace as _RTmanageSpace2,realTimeDraw as _realTimeDraw,feedData as _feedData,_linearDataParser as _linearDataParser2,_clearChart as _clearChart2,_setRTmenu as __setRTmenu}from"../_internal/realtime";import _getData2 from"@fusioncharts/core/src/_internal/misc/fetch-data";import{priorityList}from"@fusioncharts/core/src/schedular";import DataStreamer from"../_internal/datastreamer";var UNDEF,visibleStr=preDefStr.visibleStr,DS_TYPE="realtimecolumn";function _setData(value,label){var stream=BLANKSTRING;if(value&&value.toString||value===BLANKSTRING||value===0){stream="value="+value.toString()}if(label&&label.toString||label===BLANKSTRING){stream=stream+"&label="+label.toString()}if(stream){this.feedData(stream)}}addDep({name:"realtimeColumnChartAnimation",type:"animationRule",extension:realtimeColumnChartAnimation});FusionCharts.addDep(DataStreamer);var RealtimeColumn=function(_MSCartesian){_inheritsLoose(RealtimeColumn,_MSCartesian);RealtimeColumn.getName=function getName(){return"RealtimeColumn"};function RealtimeColumn(){var _this;_this=_MSCartesian.call(this)||this;var iapi=_assertThisInitialized(_this);FusionCharts.addDep(MessageLogger);FusionCharts.addDep(AlertManager);_this.showRTvalue=true;_this.canvasPadding=true;_this.isRealTime=true;_this.rtManageSpace=true;_this.transposeAxis=true;_this._setData=_setData;_this.eiMethods=eiMethods;_this._drawRTValue=function(){iapi._drawRealTimeValue()};return _this}var _proto=RealtimeColumn.prototype;_proto.getName=function getName(){return"RealtimeColumn"};_proto.__setDefaultConfig=function __setDefaultConfig(){_MSCartesian.prototype.__setDefaultConfig.call(this);var config=this.config;config.defaultDatasetType=DS_TYPE;config.enablemousetracking=true};_proto.asyncRealTimeValueDraw=function asyncRealTimeValueDraw(){this.addJob("realtimevaluedraw",this._drawRTValue,priorityList&&priorityList.draw)};_proto.parseChartAttr=function parseChartAttr(dataObj){_MSCartesian.prototype.parseChartAttr.call(this,dataObj);this.config.drawTrendRegion=0};_proto._setCategories=function _setCategories(){var iapi=this,xAxis=iapi.getChildren("xAxis")[0],tempArr=[],tempCategories,realTimeConfig=iapi.config.realTimeConfig,clear=realTimeConfig&&realTimeConfig.clear,categories=clear?UNDEF:iapi.getFromEnv("dataSource").categories&&iapi.getFromEnv("dataSource").categories[0]&&iapi.getFromEnv("dataSource").categories[0].category,catLen=categories&&Array.isArray(categories)&&categories.filter(function(data){return!data.vline}).length||0,numDisplaySets=realTimeConfig.numDisplaySets;if(catLen<numDisplaySets){tempArr.length=numDisplaySets-catLen;tempCategories=categories?tempArr.concat(categories):tempArr}else if(catLen>numDisplaySets&&numDisplaySets>=0){tempCategories=numDisplaySets?categories.slice(-numDisplaySets):[]}else{tempCategories=categories.slice(0)}xAxis.setTickValues(tempCategories)};_proto._realTimeValuePositioning=function _realTimeValuePositioning(availableHeight){var iapi=this,components=iapi.getChildren(),smartLabel=iapi.getFromEnv("smartLabel"),height,space,config=iapi.config,realTimeConfig=config.realTimeConfig||(config.realTimeConfig={}),padding=realTimeConfig.realTimeValuePadding,axisConfig=components.xAxis[0].config,style=axisConfig.trend.trendStyle,attr=realTimeConfig.style={color:convertColor(pluck(realTimeConfig.realtimeValueFontColor,style.color),pluck(axisConfig.trendlineAlpha,99)),fontFamily:pluck(realTimeConfig.realtimeValueFont,style.fontFamily),fontSize:pluck(realTimeConfig.realtimeValueFontSize,style.fontSize),fontWeight:pluck(realTimeConfig.fontWeight,style.fontWeight),lineHeight:pluckNumber(style.lineHeight)};smartLabel.useEllipsesOnOverflow(config.useEllipsesWhenOverflow);smartLabel.setStyle(attr);realTimeConfig.height=height=smartLabel.getOriSize(TESTSTR).height;realTimeConfig.canvasBottom=config.canvasBottom;space=height+padding;if(space>availableHeight){space=availableHeight}return{bottom:space}};_proto.draw=function draw(){_MSCartesian.prototype.draw.call(this);if(this.showRTvalue&&this.config.realTimeConfig.showRTValue){this._drawRealTimeValue()}};_proto._drawRealTimeValue=function _drawRealTimeValue(){var iapi=this,chart=iapi.getFromEnv("chart"),config=iapi.config,dataset=chart.getDatasets(),animationManager=chart.getFromEnv("animationManager"),smartLabel=iapi.getFromEnv("smartLabel"),realTimeConfig=config.realTimeConfig,realtimeValueSeparator=realTimeConfig.realtimeValueSeparator,len=dataset.length,displayValue=BLANKSTRING,canvasBottom=realTimeConfig.canvasBottom,height=realTimeConfig.height,canvasLeft=config.canvasLeft,canvasRight=config.canvasRight,style=realTimeConfig.style||{},positionX,positionY,realTimeValueGraphics,realTimeValueGraphicsCheck=iapi.getGraphicalElement("realTimeValue"),chartChildContainer=iapi.getChildContainer(),attr,parentLayer=chart.getContainer().parentGroup,realTimeValueGroup=chartChildContainer.realTimeValueGroup,datasetStore,drawn,prevData,dataDisplayValue,i;iapi.removeJob("realtimevaluedraw");if(realTimeConfig.clear&&realTimeValueGraphics){animationManager.setAnimation({el:realTimeValueGraphics,attr:{text:BLANKSTRING},component:iapi,label:"label"})}if(!realTimeValueGroup){realTimeValueGroup=chart.addChildContainer("realTimeValueGroup",animationManager.setAnimation({el:"group",attr:{name:"realTimeValue"},container:parentLayer,label:"group",component:chart}).insertBefore(chartChildContainer.datalabelsGroup))}else{for(i=0;i<len;i++){datasetStore=dataset[i].components.data;prevData=datasetStore[datasetStore.length-1];dataDisplayValue=prevData&&prevData.config.displayValue;displayValue+=dataDisplayValue?dataDisplayValue===UNDEF?BLANKSTRING:dataDisplayValue+realtimeValueSeparator:BLANKSTRING}displayValue=displayValue.substring(0,displayValue.length-realtimeValueSeparator.length);smartLabel.useEllipsesOnOverflow(config.useEllipsesWhenOverflow);smartLabel.setStyle(style);positionX=(canvasLeft+canvasRight)/2;positionY=canvasBottom-height/2;attr={x:positionX||0,y:positionY||0,"font-size":style.fontSize,"font-weight":style.fontWeight,"font-family":style.fontFamily,"line-height":style.lineHeight,text:displayValue,fill:style.color,visibility:visibleStr};realTimeValueGraphics=animationManager.setAnimation({el:realTimeValueGraphicsCheck||"text",attr:attr,container:realTimeValueGroup,label:"rtValue",component:chart});drawn=true;if(!realTimeValueGraphicsCheck){iapi.addGraphicalElement("realTimeValue",realTimeValueGraphics)}realTimeValueGraphics&&!drawn&&realTimeValueGraphics.show()}};_proto._hideRealTimeValue=function _hideRealTimeValue(){var iapi=this,graphics=iapi.getGraphicalElement("realTimeValue");graphics&&graphics.hide()};_proto._setRTmenu=function _setRTmenu(showRTmenuItem,useMessageLog){__setRTmenu.call(this,showRTmenuItem,useMessageLog)};_proto._getDataJSON=function _getDataJSON(){return this.config.realTimeConfig.legacyUpdateObj||{values:[]}};_proto._checkInvalidSpecificData=function _checkInvalidSpecificData(){var jsonData=this.getFromEnv("dataSource"),datasetsJSON=jsonData.dataset,dataStreamer=this.getChildren("dataStreamer")&&this.getChildren("dataStreamer")[0];if(!datasetsJSON){dataStreamer&&dataStreamer._stopUpdate();return true}};_proto._checkInvalidData=function _checkInvalidData(){var iapi=this,dataObj=iapi.getFromEnv("dataSource"),dataStreamer=iapi.getChildren("dataStreamer")&&this.getChildren("dataStreamer")[0];if(dataObj==={}){dataStreamer&&dataStreamer._stopUpdate();return true}};_proto.getDSGroupdef=function getDSGroupdef(){return ColumnMultiseriesGroup};_proto.getDSdef=function getDSdef(){return RealtimeColumnDataset};_proto._realTimeConfigure=function _realTimeConfigure(){_realTimeConfigure2.call(this)};_proto._stopUpdate=function _stopUpdate(source){_stopUpdate2.call(this,source)};_proto._restartUpdate=function _restartUpdate(){_restartUpdate2.call(this)};_proto._isUpdateActive=function _isUpdateActive(){return _isUpdateActive2.call(this)};_proto._getData=function _getData(){return _getData2.call(this)};_proto.realTimeUpdate=function realTimeUpdate(dataObj){_realTimeUpdate.call(this,dataObj)};_proto._RTmanageSpace=function _RTmanageSpace(){_RTmanageSpace2.call(this)};_proto.realTimeDraw=function realTimeDraw(eventArgs){if(eventArgs===void 0){eventArgs={}}_realTimeDraw.call(this,eventArgs)};_proto.feedData=function feedData(stream){return _feedData.call(this,stream)};_proto._linearDataParser=function _linearDataParser(responseText){return _linearDataParser2.call(this,responseText)};_proto._clearChart=function _clearChart(_source){_clearChart2.call(this,_source)};return RealtimeColumn}(MSCartesian);export default RealtimeColumn;